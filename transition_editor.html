<html data-bs-theme="dark" lang="en">
    <head>
        <title>DK64 Randomizer Transition Editor</title>
		<link rel="stylesheet" href="style/main.css">
        <link rel="stylesheet" href="style/home.css">
        <link rel="stylesheet" href="style/midi-converter.css">
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
		<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
		<link rel="manifest" href="/site.webmanifest">
		<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
		<meta name="msapplication-TileColor" content="#da532c">
		<meta name="theme-color" content="#ffffff">
		<meta name="description" content="" />
        <!-- Discord -->
        <meta content="DK64 Transition Editor" property="og:title" />
        <meta content="Editor of transition images for usage within DK64 Randomizer." property="og:description" />
        <meta content="DK64 Utils" property="og:site_name" />
        <meta content="https://raw.githubusercontent.com/theballaam96/theballaam96.github.io/master/assets/head.png" property="og:image" />
        <!-- Scripts and Styles -->
        <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
        <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
        <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jimp@0.3.5/browser/lib/jimp.min.js"></script>

        <style>
            body {
                background-image: none;
                background-color: rgba(30, 30, 30, 1);
            }
            .content-center {
                width: fit-content;
                margin-left: auto;
                margin-right: auto;
            }
            #viewport {
                border: 1px solid white;
                background-color: greenyellow;
            }
            .color-item {
                width: 32px;
                height: 32px;
                border: 1px solid white;
                transition: 0.5s ease-in-out;
            }
            .color-item:hover {
                border-color: darkgreen;
            }
            .color-item.selected {
                border-color: lawngreen;
            }
            .fill-item {
                position: relative;
            }
            .fill-item i {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }
            .transparent-background {
                background: -webkit-linear-gradient(45deg, rgba(0, 0, 0, 0.0980392) 25%, transparent 25%, transparent 75%, rgba(0, 0, 0, 0.0980392) 75%, rgba(0, 0, 0, 0.0980392) 0), -webkit-linear-gradient(45deg, rgba(0, 0, 0, 0.0980392) 25%, transparent 25%, transparent 75%, rgba(0, 0, 0, 0.0980392) 75%, rgba(0, 0, 0, 0.0980392) 0), white;
                background: -moz-linear-gradient(45deg, rgba(0, 0, 0, 0.0980392) 25%, transparent 25%, transparent 75%, rgba(0, 0, 0, 0.0980392) 75%, rgba(0, 0, 0, 0.0980392) 0), -moz-linear-gradient(45deg, rgba(0, 0, 0, 0.0980392) 25%, transparent 25%, transparent 75%, rgba(0, 0, 0, 0.0980392) 75%, rgba(0, 0, 0, 0.0980392) 0), white;
                background: linear-gradient(45deg, rgba(0, 0, 0, 0.0980392) 25%, transparent 25%, transparent 75%, rgba(0, 0, 0, 0.0980392) 75%, rgba(0, 0, 0, 0.0980392) 0), linear-gradient(45deg, rgba(0, 0, 0, 0.0980392) 25%, transparent 25%, transparent 75%, rgba(0, 0, 0, 0.0980392) 75%, rgba(0, 0, 0, 0.0980392) 0), white;
                background-repeat: repeat, repeat;
                background-position: 0px 0, 5px 5px;
                -webkit-transform-origin: 0 0 0;
                transform-origin: 0 0 0;
                -webkit-background-origin: padding-box, padding-box;
                background-origin: padding-box, padding-box;
                -webkit-background-clip: border-box, border-box;
                background-clip: border-box, border-box;
                -webkit-background-size: 10px 10px, 10px 10px;
                background-size: 10px 10px, 10px 10px;
                -webkit-box-shadow: none;
                box-shadow: none;
                text-shadow: none;
                -webkit-transition: none;
                -moz-transition: none;
                -o-transition: none;
                transition: none;
                -webkit-transform: scaleX(1) scaleY(1) scaleZ(1);
                transform: scaleX(1) scaleY(1) scaleZ(1);
              }
        </style>
    </head>
    <body>
        <nav class="navbar sticky-top navbar-expand-lg bg-body-tertiary">
            <div class="container-fluid">
                <a class="navbar-brand excluded_link" href="#">
                    Transition Editor
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" style="width:fit-content;width:-moz-fit-content">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link excluded_link" href="#" onclick="uploadPack()"><i class="fa-solid fa-upload"></i> Upload Pack</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link excluded_link" href="#" onclick="downloadPack()" id="build-pack-button"><i class="fa-solid fa-download"></i> Download Pack</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <input type="file" class="hide" accept=".zip" id="uploaded_pack" />
        <input type="file" accept=".png" id="uploaded_image" hidden />
        <div class="main_panel">
            <!-- Toasts -->
            <div id="toasts">
                <div class="toast-container position-fixed bottom-0 end-0 p-3"></div>
            </div>
            <div class="content-center">
                <div class="d-flex">
                    <div id="color-panel" class="d-flex flex-column m-2 pt-3"></div>
                    <div class="py-3">
                        <div class="p-2">
                            <label for="canvas_scale">Canvas Scale: </label>
                            1
                            <input type="range" min="1" max="20" value="7" id="canvas_scale" />
                            20
                        </div>
                        <canvas id="viewport" width="0" height="0"></canvas>
                    </div>
                    <div class="d-flex flex-column mt-5 mx-3 p-3 border border-light rounded">
                        <div class="mb-3">
                            <label for="imageName">File Name</label>
                            <input type="text" class="form-control" id="imageName" placeholder="name" />
                        </div>
                        <div>
                            <button class="btn btn-primary" type="button" style="width:100%" onclick="pushToPack()">
                                Add to Pack
                            </button>
                        </div>
                        <hr />
                        <div class="mb-3">
                            <select class="form-select" id="pack-file-list"></select>
                        </div>
                        <div class="mb-3 d-flex">
                            <button class="btn btn-danger m-2" onclick="deleteZippedImageFile()">Delete</button>
                            <button class="btn btn-info m-2" onclick="openZippedImageFile()">Open</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            // Add Colors
            const color_panel_hook = document.getElementById("color-panel");
            const upload_image_hook = document.getElementById("uploaded_image");
            const upload_pack_hook = document.getElementById("uploaded_pack");
            const scale_hook = document.getElementById("canvas_scale");
            const pack_file_hook = document.getElementById("pack-file-list");
            let processing_image = false;
            let files_in_pack = [];
            function addColor(intensity, alpha) {
                if (intensity < 0) {
                    intensity = 0;
                }
                const color_hex = `#${intensity.toString(16)}${intensity.toString(16)}${intensity.toString(16)}`
                const item_html = `<div 
                    class="color-item m-2${alpha == 0 ? " transparent-background" : ""}${intensity == 0 ? " selected" : ""}"
                    ${alpha == 0 ? "" : ` style="background-color:${color_hex}"`}
                    onclick="setColor(${intensity}, ${alpha}, this)"
                ></div>`
                color_panel_hook.innerHTML += item_html;
            }

            function addFill() {
                const item_html = `<div 
                    class="color-item m-2 fill-item"
                    onclick="fillColor()">
                    <i class="fa-solid fa-fill fa-lg"></i>
                </div>`
                color_panel_hook.innerHTML += item_html;
            }

            function uploadImage() {
                upload_image_hook.click();
            }

            function uploadPack() {
                upload_pack_hook.click();
            }

            function addUpload() {
                const item_html = `<div 
                    class="color-item m-2 fill-item"
                    onclick="uploadImage()">
                    <i class="fa-solid fa-upload fa-lg"></i>
                </div>`
                color_panel_hook.innerHTML += item_html;
            }

            function pushToZip(name) {
                if (!files_in_pack.includes(name)) {
                    files_in_pack.push(name);
                    pack_file_hook.innerHTML += `<option value="${name}">${name}</option>`
                }
            }
            
            const PIXEL_INTENSITIES = [0, 36, 73, 109, 146, 182, 219, 255];
            for (let i = 0; i < 8; i++) {
                addColor(PIXEL_INTENSITIES[i], 255);
            }
            //addColor(0, 0);
            addFill();
            addUpload();

            // Create Canvas Handler
            const canvas = document.getElementById("viewport");
            const image_dim = 64;
            let upscale_rate = 7;
            let canvas_dim = image_dim * upscale_rate;
            canvas.setAttribute("width", canvas_dim)
            canvas.setAttribute("height", canvas_dim)
            var context = canvas.getContext("2d");
            let mouseX = null;
            let mouseY = null;

            class IAPixel {
                constructor (intensity, alpha) {
                    this.intensity = intensity;
                    this.alpha = alpha;
                }
            }
            
            let applyData = new IAPixel(0, 255);
            
            function setColor(intensity, alpha, e) {
                applyData.intensity = intensity;
                applyData.alpha = alpha;
                const items = document.getElementsByClassName("color-item");
                for (let i = 0; i < items.length; i++) {
                    items[i].classList.remove("selected");
                }
                e.classList.add("selected");
            }
            
            // Define the image dimensions
            var width = canvas_dim;
            var height = canvas_dim;
        
            // Create an ImageData object
            var imagedata = context.createImageData(canvas_dim, canvas_dim);

            let image_pixels = [];
            for (let y = 0; y < image_dim; y++) {
                for (let x = 0; x < image_dim; x++) {
                    image_pixels.push(new IAPixel(255, 255));
                }
            }

            // Create the image
            function createImage() {
                // Loop over all of the pixels
                const mouseSlot = getMouseSlot();

                for (var y=0; y<canvas_dim; y++) {
                    const truncated_y = parseInt(y / upscale_rate);
                    for (var x=0; x<canvas_dim; x++) {
                        const truncated_x = parseInt(x / upscale_rate);
                        const slot = (truncated_y * image_dim) + truncated_x;
                        
                        // Get the pixel index
                        var pixelindex = (y * canvas_dim + x) * 4;
                        
                        let brightness = image_pixels[slot].intensity;
                        let alpha = image_pixels[slot].alpha;
                        if (slot == mouseSlot) {
                            brightness = applyData.intensity;
                            alpha = applyData.alpha;
                        }
        
                        // Set the pixel data
                        imagedata.data[pixelindex] = brightness;     // Red
                        imagedata.data[pixelindex+1] = brightness; // Green
                        imagedata.data[pixelindex+2] = brightness;  // Blue
                        imagedata.data[pixelindex+3] = alpha;   // Alpha
                    }
                }
            }

            class DemoPixel {
                constructor (red, green, blue) {
                    this.red = red;
                    this.green = green
                    this.blue = blue;
                }
            }

            function getMouseSlot() {
                const bounding_rect = canvas.getBoundingClientRect();
                const x = parseInt(mouseX - bounding_rect.x);
                const y = parseInt(mouseY - bounding_rect.y);
                const truncated_x = parseInt(x / upscale_rate);
                const truncated_y = parseInt(y / upscale_rate);
                if ((truncated_x < 0) || (truncated_x >= image_dim)) {
                    return null;
                }
                if ((truncated_y < 0) || (truncated_y >= image_dim)) {
                    return null;
                }
                return (truncated_y * image_dim) + truncated_x;
            }
            
            function drawPixel() {
                const slot = getMouseSlot();
                if (slot == null) {
                    return;
                }
                image_pixels[slot].intensity = applyData.intensity;
                image_pixels[slot].alpha = applyData.alpha;
            }

            function fillColor() {
                image_pixels.forEach(px => {
                    px.intensity = applyData.intensity;
                    px.alpha = applyData.alpha;
                })
            }
            
            let clickEvent = null;
            let rangeEvent = null;
            const click_interval_speed = 10;

            canvas.addEventListener("mousedown", (e) => {
                console.log("click");
                if (clickEvent == null) {
                    clickEvent = setInterval(() => {
                        drawPixel();
                    }, click_interval_speed);
                }
            });
            document.body.addEventListener("mouseup", (e) => {
                console.log("release");
                if (clickEvent != null) {
                    clearInterval(clickEvent);
                }
                if (rangeEvent != null) {
                    clearInterval(rangeEvent);
                }
                clickEvent = null;
                rangeEvent = null;
            });
            document.body.addEventListener("mousemove", (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
            })

            scale_hook.addEventListener("mousedown", (e) => {
                if (rangeEvent == null) {
                    rangeEvent = setInterval(() => {
                        upscale_rate = e.target.value;
                        canvas_dim = image_dim * upscale_rate;
                        canvas.setAttribute("width", canvas_dim);
                        canvas.setAttribute("height", canvas_dim);
                        imagedata = context.createImageData(canvas_dim, canvas_dim);
                    }, click_interval_speed * 10);
                }
            })

            files_in_pack = [];
            pack_file_hook.innerHTML = "";
            
            let zip_output = new JSZip();
            async function handlePack(data) {
                const pack_data = await zip_output.loadAsync(data);
                for (let [filename_0, file_0] of Object.entries(pack_data.files)) {
                    if (!file_0.dir) {
                        const dir_split = "textures/transitions/"
                        if (filename_0.includes(dir_split)) {
                            const raw_file = filename_0.split(dir_split)[1]
                            const no_extension = raw_file.split(".png")[0];
                            pushToZip(no_extension)
                        }
                    }
                }
            }

            upload_pack_hook.addEventListener("change", (e) => {
                var fr = new FileReader();
                fr.onload = function() {
                    handlePack(fr.result);
                };
                fr.readAsArrayBuffer(upload_pack_hook.files[0]);
                
            });

            function downloadPack() {
                zip_output.generateAsync({type:"blob"}).then(function(content) {
                    saveAs(content, "pack.zip");
                });
            }

            const texture_folder = "textures/";
            const transition_folder = "transitions/";

            function pushToPack() {
                if (document.getElementById("imageName").value == "") {
                    generateToast("Cannot unnamed image to pack", true);
                    return;
                }
                const image = new Jimp(64, 64, async (err, image) => {
                    if (err) throw err;
                  
                    // Set the pixel values of the image
                    image.scan(0, 0, image.bitmap.width, image.bitmap.height, function (x, y, idx) {
                        const ia = image_pixels[y * width + (63 - x)]; // 63 - x to horizontally flip it
                        // Detect edge - Not fully congruent with the canvas, but at least fixes obvious issues
                        let is_edge = false;
                        if ((x == 0) || (y == 0)) {
                            is_edge = true;
                        } else if ((x == 63) || (y == 63)) {
                            is_edge = true;
                        }
                        let intensity = is_edge ? 255 : 255 - ia.intensity;
                        let alpha = is_edge ? 255 : ia.alpha;

                        this.bitmap.data[idx + 0] = intensity; // Red channel
                        this.bitmap.data[idx + 1] = intensity; // Green channel
                        this.bitmap.data[idx + 2] = intensity; // Blue channel
                        this.bitmap.data[idx + 3] = alpha; // Alpha channel
                    });

                    // Add folders if necessary
                    
                    if (!zip_output.file(texture_folder)) {
                        zip_output.folder(texture_folder);
                    }
                    if (!zip_output.folder(texture_folder).folder(transition_folder)) {
                        zip_output.folder(texture_folder).folder(transition_folder);
                    }
                  
                    const imageBuffer = await image.getBufferAsync(Jimp.MIME_PNG);
                    const name = document.getElementById("imageName").value;
                    pushToZip(name);

                    zip_output.folder(texture_folder).folder(transition_folder).file(`${name}.png`, imageBuffer);
                    image_pixels.forEach(px => {
                        px.intensity = 255;
                        px.alpha = 255;
                    })
                    document.getElementById("imageName").value = "";
                    generateToast(`Successfully added ${name}.png`, false);
                });
            }
        
            // Main loop
            function main(tframe) {
                // Request animation frames
                window.requestAnimationFrame(main);
        
                // Create the image
                createImage();
        
                // Draw the image data to the canvas
                context.putImageData(imagedata, 0, 0);
            }
        
            // Call the main loop
            setInterval(() => {
                main(0);
            }, 100);

            // Handle Uploaded Image
            upload_image_hook.addEventListener("change", (e) => {
                var fr = new FileReader();
                fr.onload = function(k) {
                    const dataURL = k.target.result;
                    processing_image = true;
                    Jimp.read(dataURL, (err, image) => {
                        if (err) {
                            console.error(err);
                            return;
                        }
                        // Scale Image Down
                        width = image.bitmap.width;
                        height = image.bitmap.height;
                        descale = Math.min(62 / width, 62 / height); // Minus 2 because needs border
                        image.resize(width * descale, height * descale);
                        // Regrab data
                        width = image.bitmap.width;
                        height = image.bitmap.height;
                        x_offset = parseInt((64 - width) / 2);
                        y_offset = parseInt((64 - height) / 2);
                        // Wipe canvas
                        image_pixels.forEach(px => {
                            px.intensity = 0;
                            px.alpha = 255;
                        })
                        // Parse Image
                        for (let y = 0; y < height; y++) {
                            for (let x = 0; x < width; x++) {
                                const data = Jimp.intToRGBA(image.getPixelColor(x, y))
                                const alpha = data.a;
                                let closest_intensity = 0;
                                let closest_range = 9999999;
                                PIXEL_INTENSITIES.forEach(val => {
                                    const range = Math.abs(val - alpha);
                                    if (range < closest_range) {
                                        closest_intensity = val;
                                        closest_range = range;
                                    }
                                })
                                const written_x = x + x_offset;
                                const written_y = y + y_offset;
                                const written_slot = (written_y * image_dim) + written_x;
                                image_pixels[written_slot].intensity = closest_intensity;
                                image_pixels[written_slot].alpha = 255;
                            }
                        }
                        document.getElementById("imageName").value = upload_image_hook.files[0].name.split(".")[0];
                        processing_image = false;
                    })
                };
                fr.readAsDataURL(upload_image_hook.files[0]);
            })

            function openZippedImageFile() {
                const target = pack_file_hook.value;
                if (!target) {
                    generateToast("No file selected.", true);
                    return;
                }
                document.getElementById("imageName").value = target;
                const file = zip_output.folder(texture_folder).folder(transition_folder).file(`${target}.png`);
                file.async("uint8array").then((content) => {
                    Jimp.read(Buffer.from(content.buffer)).then((image) => {
                        image.flip(true, false);
                        width = image.bitmap.width;
                        height = image.bitmap.height;
                        // Wipe canvas
                        image_pixels.forEach(px => {
                            px.intensity = 0;
                            px.alpha = 255;
                        })
                        // Parse Image
                        for (let y = 0; y < height; y++) {
                            for (let x = 0; x < width; x++) {
                                const data = Jimp.intToRGBA(image.getPixelColor(x, y))
                                const intensity = (255 - data.r);
                                let closest_intensity = 0;
                                let closest_range = 9999999;
                                PIXEL_INTENSITIES.forEach(val => {
                                    const range = Math.abs(val - intensity);
                                    if (range < closest_range) {
                                        closest_intensity = val;
                                        closest_range = range;
                                    }
                                })
                                const written_slot = (y * image_dim) + x;
                                image_pixels[written_slot].intensity = closest_intensity;
                                image_pixels[written_slot].alpha = 255;
                            }
                        }
                    }).catch((err) => {
                        generateToast(err, true);
                    })
                }).catch((err) => {
                    generateToast(err, true);
                })
            }
            
            function deleteZippedImageFile() {
                const target = pack_file_hook.value;
                if (!target) {
                    generateToast("No file selected.", true);
                    return;
                }
                const file = zip_output.folder(texture_folder).folder(transition_folder).remove(`${target}.png`);
                const options = pack_file_hook.getElementsByTagName("option");
                for (let o = 0; o < options.length; o++) {
                    if (options[o].getAttribute("value") == target) {
                        options[o].remove();
                    }
                }
                files_in_pack = files_in_pack.filter(item => item != target);
                generateToast(`Successfully deleted ${target}.png`, false);
            }
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
        <script>
            // TOAST GENERATOR
            const toastTrigger = document.getElementById('liveToastBtn')
            const toastContainer = document.getElementById("toasts")

            let toast_counter = 0;

            function generateToast(message, error=false) {
                toastContainer.getElementsByClassName("toast-container")[0].innerHTML += `
                <div id="liveToast${toast_counter}" class="toast align-items-center ${error ? 'text-bg-danger' : 'text-bg-primary'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>                    
                </div>`
                const toastEl = document.getElementById(`liveToast${toast_counter}`)
                const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastEl)
                toastBootstrap.show()
                toast_counter += 1;
            }
        </script>
    </body>
</html>