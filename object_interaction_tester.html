<html>
	<head>
		<title>Object Interaction Calculator - Donkey Kong 64 Speedruns</title>
		<link rel="stylesheet" href="style/nav.css">
		<link rel="stylesheet" href="style/main.css">
		<link rel="stylesheet" href="style/home.css">
		<link rel="stylesheet" href="style/mj.css">
		<meta name="description" content="" />
	</head>
	<body>
		<nav id="navigation"></nav>
		<nav id="navigation"></nav>
		<div class="v_spacer">

		</div>
		<div class="flexsplitter">
			<div class="homebox">
				<div class="header master_header">
					<strong>Object Interaction Calculator</strong>
				</div>
			</div>
		</div>
		<div class="flexsplitter">
			<div class="homebox" style="padding: 20px">
				
			</div>
			<div class="homebox">
					<div class="input_info">
						<div class="mj_calc_desc">
							<h2>The Viewer</h2>
						</div>
						<!-- Phases -->
						<div class="flexsplitter">
							<div class="flex40">
								<h4 class="label">
									Phase Filters
								</h4>
							</div>
							<div class="flex40" style="text-align: right">
								<button style="width: fit-content; font-size: 14px" onclick="selectAllPhases()">
									Select All
								</button>
								<button style="width: fit-content; font-size: 14px" onclick="deselectAllPhases()">
									Deselect All
								</button>
							</div>
						</div>
						<div class="flexsplitter">
							<div class="flex40">
								<table>
									<tr>
										<td>
											<span class="label">Phase 1: </span>
										</td>
										<td>
											<input type="checkbox" class="pfilterCheckbox" phase="1">
										</td>
									</tr>
								</table>
							</div>
							<div class="flex40">
								<table>
									<tr>
										<td>
											<span class="label">Phase 2: </span>
										</td>
										<td>
											<input type="checkbox" class="pfilterCheckbox" phase="2">
										</td>
									</tr>
								</table>
							</div>
							<div class="flex40">
								<table>
									<tr>
										<td>
											<span class="label">Phase 3: </span>
										</td>
										<td>
											<input type="checkbox" class="pfilterCheckbox" phase="3">
										</td>
									</tr>
								</table>
							</div>
							<div class="flex40">
								<table>
									<tr>
										<td>
											<span class="label">Phase 4: </span>										
										</td>
										<td>
											<input type="checkbox" class="pfilterCheckbox" phase="4">											
										</td>
									</tr>
								</table>
							</div>
							<div class="flex40">
								<table>
									<tr>
										<td>
											<span class="label">Phase 5: </span>										
										</td>
										<td>
											<input type="checkbox" class="pfilterCheckbox" phase="5">											
										</td>
									</tr>
								</table>
							</div>
						</div>
						<br><br>	
						<!-- Styling -->
						<div class="flexsplitter">
							<div class="flex40">
								<h4 class="label">
									Stylings
								</h4>
							</div>
							<!-- <div class="flex40" style="text-align: right">
								<button style="width: fit-content; font-size: 14px" onclick="selectAllStylings()">
									Select All
								</button>
								<button style="width: fit-content; font-size: 14px" onclick="deselectAllStylings()">
									Deselect All
								</button>
							</div> -->
						</div>
						<div class="flexsplitter">
							<div class="flex40">
								<table>
									<tr>
										<td>
											<span class="label">Phase Colouring: </span>
										</td>
										<td>
											<input type="checkbox" id="phasecolouring" class="stylingCheckbox">
										</td>
									</tr>
								</table>
							</div>
							<div class="flex40">
								<table>
									<tr>
										<td>
											<span class="label">Show Lines: </span>
										</td>
										<td>
											<input type="checkbox" id="showLines" class="stylingCheckbox">
										</td>
									</tr>
								</table>
							</div>
							<div class="flex40">
								<table>
									<tr>
										<td>
											<span class="label">Line Colouring: </span>
										</td>
										<td>
											<input type="checkbox" id="linecolouring" class="stylingCheckbox">
										</td>
									</tr>
								</table>
							</div>
							<div class="flex40">
								<table>
									<tr>
										<td>
											<span class="label">Display Pufftoss: </span>										
										</td>
										<td>
											<input type="checkbox" id="showCentre" class="stylingCheckbox" checked>											
										</td>
									</tr>
								</table>
							</div>
							<div class="flex40">
								<table>
									<tr>
										<td>
											<span class="label">Display Rods: </span>										
										</td>
										<td>
											<input type="checkbox" id="showRods" class="stylingCheckbox">											
										</td>
									</tr>
								</table>
							</div>
						</div>
						</div>
						<div class="mj_calc_desc">
							<h2>
								What is this?
							</h2>
							<div class="desc">
								This tool displays all the key elements in the "Pufftoss" boss fight in relation to the map as a whole. This can assist in visualising where star locations are, assist in routing and learning. With this tool, the following elements can be plotted onto the map:
								<ul>
									<li>Star Locations</li>
									<li>Pufftoss</li>
									<li>Lightning Rods</li>
								</ul>
								Additionally, lines between each star location can be toggled on and off. Whilst, at the time of writing (18-DEC-2020), Pufftoss cannot be driven through during the fight, and therefore the lines do not 100% reflect the path to take during the fight, the lines give an indication of the curve that will need to be taken for an optimal Pufftoss fight.
							</div>

							<h2>
								How to use
							</h2>
							<div class="desc">
								Select the various checkboxes to display, hide and stylize various elements of the fight that fall into certain categories.
								<br><br>
								Hover over a node or line to display information on that node or line.
							</div>
							<br><br>
						</div>
					</div>
				</div>
		</div>
	</body>
	<script src="script/nav.js"></script>
	<script>
		var xhttp = new XMLHttpRequest();
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				responseJSON = JSON.parse(xhttp.responseText).data;
				console.log("ACTOR JSON")
				console.log(responseJSON)
				actors = responseJSON.actors.slice()
			}
		}
		xhttp.open("GET", "https://raw.githubusercontent.com/theballaam96/theballaam96.github.io/master/data/actors.json", true);
		xhttp.send(null)

		var actors = [];

		var xhttp2 = new XMLHttpRequest();
		xhttp2.open("GET", "https://raw.githubusercontent.com/theballaam96/theballaam96.github.io/master/data/DDQ.bin", true);
		xhttp2.responseType = "blob";
		xhttp2.onload = function (event) {
			var blob = xhttp2.response
			console.log(blob)
			
			const reader = new FileReader();
			reader.addEventListener('loadend', () => {
				rdram_data = reader.result
			});
			reader.readAsArrayBuffer(blob)
		}
		xhttp2.send(null)

		var rdram_data;

		function checkData(target_actor, source_actor, source_int) {
			var param_1 = dereferencePointer(0x74C604 + (8 * target_actor));
			var param_2 = source_actor;
			var param_3 = source_int;
			var arraySignedValue = readData(param_1,2,"signed")
			var break_bool = false;
			var matchBool = false;
			while (!break_bool) {
				arrayPointer = readData(param_1 + 4, 4,"unsigned")
				matchBool = interactionMatches(param_2, param_3, arraySignedValue);
				param_1 = param_1 + 8;
				if (matchBool != 0) {
					break_bool = true;
				} else if (arraySignedValue == 0) {
					break_bool = true;
				}
				arraySignedValue = readData(param_1,2,"signed")
			}
			return arrayPointer
		}

		function convertRawToUnsigned(val) {
			return (val + 256) % 256
		}

		function readData(address,size,type) {
			const view = new Int8Array(rdram_data)
			var endValue = 0;
			var hexValue = "";
			for (offset = 0; offset < size; offset++) {
				endValue = endValue * 256;
				endValue += convertRawToUnsigned(view[address + offset]);
				if (view[address + offset]) {
					var newHex = "00" + parseInt(view[address + offset]).toString(16);
					hexValue += newHex.substring(newHex.length - 2, newHex.length)
				}

			}
			if (type == "hex") {
				return hexValue
			} else if (type == "unsigned") {
				return endValue
			} else if (type == "signed") {
				var cap = Math.pow(2,(size * 8) - 1) - 1;
				if (endValue > cap) {
					return ((endValue - (2 * cap)) - 2);
				} else {
					return endValue
				}
			}
		}

		function dereferencePointer(address) {
			var pointer = readData(address,4,"unsigned")
			if (pointer > 0x7FFFFFFF && pointer < 0x80800000) {
				return pointer - 0x80000000;
			} else {
				return 0;
			}
		}

		function interactionMatches(sourceActor, sourceInteraction, signedVal) {
			if (signedVal == sourceActor) {
				return 1;
			} else {
				if (signedVal > -9 && signedVal < 0) {
					idx = Math.abs(signedVal) - 1;
					if (sourceInteraction == Math.pow(2,idx)) {
						return 1;
					}
				}
			}
			return 0;
		}

		function grabIndex(target_actor,source_actor,source_interaction) {
			var address = checkData(target_actor,source_actor,source_interaction);
			address = address - 0x80000000;
			return readData(address + 9,1,"unsigned")
		}

		function get7FBB85Status(target_actor,source_actor,source_interaction) {
			var idx = grabIndex(target_actor,source_actor,source_interaction);
			var outcome = 0;
			collision_info.forEach(collision_case => {
				var valid_idxs = collision_case.searchIndexes.slice();
				if (valid_idxs.includes(idx)) {
					if (collision_case["7fbb85"]) {
						outcome = 1;
					} else {
						outcome = -1
					}
				}
			})
			return outcome
		}
		function testAllSourcesForTarget(target_actor) {
			var works = [];
			var inconclusive = [];
			var doesntwork = [];
			actors.forEach(actor => {
				var selected_index = parseInt(actor.actor_index);
				for (selected_power = 0; selected_power < 16; selected_power++) {
					var status = get7FBB85Status(target_actor, selected_index, Math.pow(2,selected_power))
					if (status == 1) {
						works.push({
							"source_actor": selected_index,
							"source_actor_name": actors.find(actor => actor.actor_index == selected_index).name,
							"source_interaction": "0x" + Math.pow(2,selected_power).toString(16)
						})
					} else if (status == 0) {
						var idx_val = grabIndex(target_actor,selected_index,Math.pow(2,selected_power))
						var addr = checkData(target_actor,selected_index,Math.pow(2,selected_power))
						inconclusive.push({
							"source_actor": selected_index,
							"source_actor_name": actors.find(actor => actor.actor_index == selected_index).name,
							"source_interaction": "0x" + Math.pow(2,selected_power).toString(16),
							"idx": idx_val,
							"address": addr
						})
					} else if (status == -1) {
						doesntwork.push({
							"source_actor": selected_index,
							"source_actor_name": actors.find(actor => actor.actor_index == selected_index).name,
							"source_interaction": "0x" + Math.pow(2,selected_power).toString(16)
						})
					}
				}
			})
			return {
				"works": works.slice(),
				"inconclusive": inconclusive.slice(),
				"doesntwork": doesntwork.slice()
			}
		}

		var collision_info = [
			{
				"searchIndexes": [],
				"case": 1,
				"7fbb85": false,
			},
			{
				"searchIndexes": [3,4,8,10,11,12,13],
				"case": 2,
				"7fbb85": false,
			},
			{
				"searchIndexes": [15],
				"case": 4,
				"7fbb85": true,
			},
			{
				"searchIndexes": [5],
				"case": 8,
				"7fbb85": true,
			},
			{
				"searchIndexes": [1],
				"case": 0x10,
				"7fbb85": false,
			},
			{
				"searchIndexes": [],
				"case": 0x20,
				"7fbb85": false,
			},
			{
				"searchIndexes": [6],
				"case": 0x40,
				"7fbb85": false,
			},
			{
				"searchIndexes": [7],
				"case": 0x80,
				"7fbb85": false,
			},
			{
				"searchIndexes": [],
				"case": 0x400,
				"7fbb85": false,
			},
			{
				"searchIndexes": [],
				"case": 0x800,
				"7fbb85": false,
			},
			{
				"searchIndexes": [9],
				"case": 0x1000,
				"7fbb85": false,
			},
			{
				"searchIndexes": [],
				"case": 0x2000,
				"7fbb85": false,
			},
			{
				"searchIndexes": [],
				"case": 0x4000,
				"7fbb85": false,
			},
			{
				"searchIndexes": [],
				"case": 0x8000,
				"7fbb85": false,
			},
			{
				"searchIndexes": [],
				"case": 0x10000,
				"7fbb85": false,
			},
			{
				"searchIndexes": [],
				"case": 0x20000,
				"7fbb85": false,
			},
			{
				"searchIndexes": [],
				"case": 0x40000,
				"7fbb85": false,
			},
			{
				"searchIndexes": [],
				"case": 0x80000,
				"7fbb85": false,
			},
			{
				"searchIndexes": [],
				"case": 0x100000,
				"7fbb85": false,
			},
			{
				"searchIndexes": [14],
				"case": 0x200000,
				"7fbb85": false,
			},
		]

		document.getElementsByClassName("navbar")[0].getElementsByTagName("ul")[0].innerHTML = ""
	</script>
</html>