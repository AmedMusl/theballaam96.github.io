<html>
	<head>
		<title>Map Viewer - Donkey Kong 64 Speedruns</title>
		<link rel="stylesheet" href="style/nav.css">
		<link rel="stylesheet" href="style/main.css">
		<link rel="stylesheet" href="style/home.css">
		<link rel="stylesheet" href="style/mj.css">
		<link rel="stylesheet" href="style/viewmap.css">
		<meta name="description" content="" />
	</head>
	<body>
		<nav id="navigation"></nav>
		<nav id="navigation"></nav>
		<div class="v_spacer">

		</div>
		<div class="flexsplitter">
			<div class="homebox">
				<div class="header master_header">
					<strong>Map Viewer</strong>
				</div>
			</div>
		</div>
		<div class="flexsplitter">
			<div class="homebox" style="padding: 20px">
				<div id="map_hook" class="viewmap backdrop">
					<div id="map_image_hook" class="viewmap map">
						<div id="objects_box" class="viewmap viewbox">

						</div>
					</div>
				</div>
			</div>
			<div class="homebox">
					<div class="input_info">
						<div class="mj_calc_desc">
							<h2>The Viewer</h2>
						</div>
						<!-- Phases -->
						<div class="flexsplitter">
							<div class="flex40">
								<h4 class="label">
									Phase Filters
								</h4>
							</div>
							<div class="flex40" style="text-align: right">
								<button style="width: fit-content; width: -moz-fit-content; font-size: 14px" onclick="selectAllPhases()">
									Select All
								</button>
								<button style="width: fit-content; width: -moz-fit-content; font-size: 14px" onclick="deselectAllPhases()">
									Deselect All
								</button>
							</div>
						</div>
						<div class="flexsplitter">
							<div class="flex40">
								<table>
									<tr>
										<td>
											<span class="label">Phase 1: </span>
										</td>
										<td>
											<input type="checkbox" class="pfilterCheckbox" phase="1">
										</td>
									</tr>
								</table>
							</div>
							<div class="flex40">
								<table>
									<tr>
										<td>
											<span class="label">Phase 2: </span>
										</td>
										<td>
											<input type="checkbox" class="pfilterCheckbox" phase="2">
										</td>
									</tr>
								</table>
							</div>
							<div class="flex40">
								<table>
									<tr>
										<td>
											<span class="label">Phase 3: </span>
										</td>
										<td>
											<input type="checkbox" class="pfilterCheckbox" phase="3">
										</td>
									</tr>
								</table>
							</div>
							<div class="flex40">
								<table>
									<tr>
										<td>
											<span class="label">Phase 4: </span>										
										</td>
										<td>
											<input type="checkbox" class="pfilterCheckbox" phase="4">											
										</td>
									</tr>
								</table>
							</div>
							<div class="flex40">
								<table>
									<tr>
										<td>
											<span class="label">Phase 5: </span>										
										</td>
										<td>
											<input type="checkbox" class="pfilterCheckbox" phase="5">											
										</td>
									</tr>
								</table>
							</div>
						</div>
						<br><br>	
						<!-- Styling -->
						<div class="flexsplitter">
							<div class="flex40">
								<h4 class="label">
									Stylings
								</h4>
							</div>
							<!-- <div class="flex40" style="text-align: right">
								<button style="width: fit-content; font-size: 14px" onclick="selectAllStylings()">
									Select All
								</button>
								<button style="width: fit-content; font-size: 14px" onclick="deselectAllStylings()">
									Deselect All
								</button>
							</div> -->
						</div>
						<div class="flexsplitter">
							<div class="flex40">
								<table>
									<tr>
										<td>
											<span class="label">Phase Colouring: </span>
										</td>
										<td>
											<input type="checkbox" id="phasecolouring" class="stylingCheckbox">
										</td>
									</tr>
								</table>
							</div>
							<div class="flex40">
								<table>
									<tr>
										<td>
											<span class="label">Show Lines: </span>
										</td>
										<td>
											<input type="checkbox" id="showLines" class="stylingCheckbox">
										</td>
									</tr>
								</table>
							</div>
							<div class="flex40">
								<table>
									<tr>
										<td>
											<span class="label">Line Colouring: </span>
										</td>
										<td>
											<input type="checkbox" id="linecolouring" class="stylingCheckbox">
										</td>
									</tr>
								</table>
							</div>
							<div class="flex40">
								<table>
									<tr>
										<td>
											<span class="label">Display Pufftoss: </span>										
										</td>
										<td>
											<input type="checkbox" id="showCentre" class="stylingCheckbox" checked>											
										</td>
									</tr>
								</table>
							</div>
							<div class="flex40">
								<table>
									<tr>
										<td>
											<span class="label">Display Rods: </span>										
										</td>
										<td>
											<input type="checkbox" id="showRods" class="stylingCheckbox">											
										</td>
									</tr>
								</table>
							</div>
						</div>
						</div>
						<div class="mj_calc_desc">
							<h2>
								What is this?
							</h2>
							<div class="desc">
								This tool displays all the key elements in the "Pufftoss" boss fight in relation to the map as a whole. This can assist in visualising where star locations are, assist in routing and learning. With this tool, the following elements can be plotted onto the map:
								<ul>
									<li>Star Locations</li>
									<li>Pufftoss</li>
									<li>Lightning Rods</li>
								</ul>
								Additionally, lines between each star location can be toggled on and off. Whilst, at the time of writing (18-DEC-2020), Pufftoss cannot be driven through during the fight, and therefore the lines do not 100% reflect the path to take during the fight, the lines give an indication of the curve that will need to be taken for an optimal Pufftoss fight.
							</div>

							<h2>
								How to use
							</h2>
							<div class="desc">
								Select the various checkboxes to display, hide and stylize various elements of the fight that fall into certain categories.
								<br><br>
								Hover over a node or line to display information on that node or line.
							</div>
							<br><br>
						</div>
					</div>
				</div>
		</div>
	</body>
	<script src="script/nav.js"></script>
	<script>
		var xhttp = new XMLHttpRequest();
		var mapData = [];
		xhttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				responseJSON = JSON.parse(xhttp.responseText).data;
				// star_data = responseJSON.stars.slice();
				// pufftoss = responseJSON.pufftoss.slice()[0];
				// rod_data = responseJSON.rods.slice();
				response_data = responseJSON;
				console.log(responseJSON)
				populateNodes(responseJSON)
				handleImage()
				getImageDimensions()
			}
		}
		xhttp.open("GET", "https://raw.githubusercontent.com/theballaam96/theballaam96.github.io/master/data/object_data_advanced.json", true);
		xhttp.send(null)

		// var xhttp2 = new XMLHttpRequest();
		// var mapData = [];
		// xhttp2.onreadystatechange = function() {
		// 	if (this.readyState == 4 && this.status == 200) {
		// 		responseJSON = JSON.parse(xhttp2.responseText).data;
		// 		star_data = responseJSON.stars.slice();
		// 		pufftoss = responseJSON.pufftoss.slice()[0];
		// 		rod_data = responseJSON.rods.slice();
		// 		response_data = responseJSON;
		// 		console.log(responseJSON)
		// 		getImageDimensions()
		// 	}
		// }
		// xhttp2.open("GET", "https://raw.githubusercontent.com/theballaam96/theballaam96.github.io/master/data/object_data_advanced.json", true);
		// xhttp2.send(null)

		var response_data = {}
		var star_data = [];
		var pufftoss = {};
		var rod_data = [];

		var obj_nodes = [];

		var image_data = [
			{
				"map": "Jungle Japes",
				"location": {
					"folder": "Japes",
					"file": "Jungle Japes"
				},
				"dimensions": {
					"width": 697,
					"height": 951,
				},
				"boundaries": {
					"x": {
						"min": 465.815,
						"max": 3175.039,
					},
					"z": {
						"min": 147.027,
						"max": 4462.491,
					}
				},
				"force_scale": {
					"x": 0.80,
					"z": 1,
				},
				"shift": {
					"x": -0.5,
					"z": -1,
				}
			}
		];

		var focused_map_image_data = {};

		function handleImage() {
			var queryString = window.location.search;
			const urlParams = new URLSearchParams(queryString)
			const selected_map = urlParams.get("map");
			
			var map_image_data = image_data.find(item => item.map == selected_map)
			map_image_data.boundaries.x.center = (map_image_data.boundaries.x.min + map_image_data.boundaries.x.max) / 2;
			map_image_data.boundaries.x.scale = map_image_data.boundaries.x.max - map_image_data.boundaries.x.min;
			map_image_data.boundaries.z.center = (map_image_data.boundaries.z.min + map_image_data.boundaries.z.max) / 2;
			map_image_data.boundaries.z.scale = map_image_data.boundaries.z.max - map_image_data.boundaries.z.min;
			console.log(map_image_data)

			focused_map_image_data = map_image_data;

			var urlString = "https://raw.githubusercontent.com/theballaam96/theballaam96.github.io/master/assets/maps/" + map_image_data.location.folder + "/" + encodeURI(map_image_data.location.file) + ".png";
			document.getElementById("map_image_hook").style["background-image"] = "url("+ urlString + ")"
		}

		function populateNodes(data) {
			var queryString = window.location.search;
			const urlParams = new URLSearchParams(queryString)
			const selected_map = urlParams.get("map");
			const selected_bool = urlParams.get("solo");
			const selected_obj = urlParams.get("obj");
			const selected_type = urlParams.get("type");

			var selected_map_data = data.find(maps => maps.map == selected_map)
			if (selected_map_data) {
				if (selected_bool == "true") {
					obj_nodes = selected_map_data.obj.filter(item => item.id == selected_obj && item.type == selected_type).slice()
				} else {
					obj_nodes = selected_map_data.obj.slice()
				}
			}
			console.log(obj_nodes)
		}

		var scale_factor = {
			"w": 1,
			"h": 1,
		}

		function getImageDimensions() {
			var box = document.getElementById("map_hook");
			var box_data = {
				"w": box.clientWidth,
				"h": box.clientHeight,
			}

			// Assume image is scaled to fit box width, what would height be?
			var scaled_height = (box_data["w"] / focused_map_image_data.dimensions["width"]) * focused_map_image_data.dimensions["height"]
			// Assume image is scaled to fit box height, what would width be?
			var scaled_width = (box_data["h"] / focused_map_image_data.dimensions["height"]) * focused_map_image_data.dimensions["width"];
			var scaled_image = {
				"w": 0,
				"h": 0,
			}
			if (scaled_height > box_data["h"]) {
				// Snapping to width causes problem, snap to height, take scaled width
				scaled_image["w"] = scaled_width;
				scaled_image["h"] = box_data["h"];
			} else {
				scaled_image["w"] = box_data["w"];
				scaled_image["h"] = scaled_height;
			}
			scale_factor["w"] = scaled_image["w"] / box_data["w"];
			scale_factor["h"] = scaled_image["h"] / box_data["h"];
			clearObjs()
			drawObjs(obj_nodes)
		}

		function clearObjs() {
			var hook = document.getElementById("objects_box");
			hook.innerHTML = "";
		}

		function drawObjs(data) {
			var hook = document.getElementById("objects_box");
			data.forEach((obj, index) => {
				var node = document.createElement("span");
				node.setAttribute("x",obj.position_x);
				node.setAttribute("y",obj.position_y);
				node.setAttribute("z",obj.position_z);
				node.setAttribute("objtype",obj.type);
				node.setAttribute("node_type",obj.type);
				node.setAttribute("objname",obj.name);
				node.setAttribute("objid",obj.id);
				node.setAttribute("objscale",obj.scale)
				node.setAttribute("objidx", index);
				node.classList.add("viewmap")
				node.classList.add("star_location")
				var center_x_diff = obj.position_x - focused_map_image_data.boundaries.x.center;
				var center_z_diff = obj.position_z - focused_map_image_data.boundaries.z.center;
				//console.log("Center Diff X: " + center_x_diff + ", Center Diff Z: " + center_z_diff)
				var x_offset = 100 * (center_x_diff / focused_map_image_data.boundaries.x.scale) * scale_factor["w"] * focused_map_image_data.force_scale.x;
				var z_offset = 100 * (center_z_diff / focused_map_image_data.boundaries.z.scale) * scale_factor["h"] * focused_map_image_data.force_scale.z;
				//console.log("Offset X: " + x_offset + ", Offset Z: " + z_offset)
				var x_perc = 50 + x_offset + focused_map_image_data.shift.x;
				var z_perc = 50 + z_offset + focused_map_image_data.shift.z;
				node.style.top = z_perc + "%";
				node.style.left = x_perc + "%";
				//console.log("X: " + x_perc + "%, Z: " + z_perc + "%")
				//var lineText = document.createTextNode(".")
				var lineText = document.createTextNode((index + 1).toString())
				node.style.color = "black";
				node.appendChild(lineText)

				node.addEventListener("mouseover", function(){spawnInfoBox(node, "node", event);})
				node.addEventListener("mouseout", function(){clearInfoBox(index)})

				hook.appendChild(node)
				//console.log("")
			})
		}

		var precision = 3;
		function clipNumber(value) {
			return Math.floor(value * Math.pow(10,precision)) / Math.pow(10,precision)
		}

		function spawnInfoBox(focal_el, focus_point, event) {
			var boxes = document.getElementsByClassName("infobox");
			for (i = 0; i < boxes.length; i++) {
				boxes[i].classList.add("fading")
			}
			var node_type = focal_el.getAttribute("node_type")
			var viewbox = document.getElementById("objects_box").getBoundingClientRect()

			// Container
			var box = document.createElement("span")
			if (focus_point == "node") {
				box.style.top = focal_el.style.top;
				box.style.left = focal_el.style.left;
			} else if (focus_point == "cursor") {
				box.style.top = event.clientY - viewbox.top;
				box.style.left = event.clientX - viewbox.left;
			}
			box.classList.add("viewmap")
			box.classList.add("infobox")
			box.setAttribute("id","center_info")
			box.setAttribute("objidx", focal_el.getAttribute("objidx"))
			
			// Title
			var title_box = document.createElement("div");
			title_box.classList.add("title")
			var title = document.createTextNode(focal_el.getAttribute("objname"))
			title_box.appendChild(title)
			box.appendChild(title_box)

			// Info
			var info_bar = document.createElement("div");
			info_bar.classList.add("info")
			var info_table = document.createElement("table")
			if (focal_el.getAttribute("objtype") == "modeltwo") {
				var info_data = {
					X: clipNumber(focal_el.getAttribute("x")),
					Y: clipNumber(focal_el.getAttribute("y")),
					Z: clipNumber(focal_el.getAttribute("z")),
					Scale: clipNumber(focal_el.getAttribute("objscale")),
				}
				info_keys = Object.keys(info_data).slice()
				info_data["Object ID"] = focal_el.getAttribute("objid");
				info_keys.unshift("Object ID")
			} else if (focal_el.getAttribute("objtype") == "actor") {
				var info_data = {
					X: clipNumber(focal_el.getAttribute("x")),
					Y: clipNumber(focal_el.getAttribute("y")),
					Z: clipNumber(focal_el.getAttribute("z")),
				}
				info_keys = Object.keys(info_data).slice()
				info_data["Object ID"] = focal_el.getAttribute("objid");
				info_keys.unshift("Object ID")
			} else if (focal_el.getAttribute("objtype") == "character") {
				var info_data = {
					X: clipNumber(focal_el.getAttribute("x")),
					Y: clipNumber(focal_el.getAttribute("y")),
					Z: clipNumber(focal_el.getAttribute("z")),
					Scale: clipNumber(focal_el.getAttribute("objscale")),
				}
				info_keys = Object.keys(info_data).slice()
				info_data["Spawner ID"] = focal_el.getAttribute("objid");
				info_keys.unshift("Spawner ID")
			}
			info_keys.forEach((item, index) =>  {
				var tr = document.createElement("tr");
				var td_head = document.createTextNode(item);
				var td_data = document.createTextNode(info_data[item]);

				if (index == 0) {
					var head = document.createElement("thead");
					var td_left = document.createElement("th");
					var td_right = document.createElement("th");
				} else {
					var td_left = document.createElement("td");
					var td_right = document.createElement("td");
				}
				td_left.appendChild(td_head);
				td_right.appendChild(td_data);
				tr.appendChild(td_left);
				tr.appendChild(td_right);
				if (index == 0) {
					head.appendChild(tr);
					info_table.appendChild(head)
				} else {
					info_table.appendChild(tr);
				}
			}) 
			info_bar.appendChild(info_table);
			box.appendChild(info_bar)
			
			document.getElementById("objects_box").appendChild(box)
		}

		function clearInfoBox(objidx) {
			//console.log("Target Index: " + objidx)
			var boxes = document.getElementsByClassName("infobox");
			//console.log(boxes)
			for (i = 0; i < boxes.length; i++) {
				var idx = boxes[i].getAttribute("objidx");
				//console.log("Source Index: " + idx)
				if (idx == objidx) {
					boxes[i].classList.add("fading")
				}
			}
			setTimeout(function() {
				var boxes = document.getElementsByClassName("infobox");
				for (i = 0; i < boxes.length; i++) {
					var idx = boxes[i].getAttribute("objidx");
					if (idx == objidx) {
						boxes[i].remove()
					}
				}
			}, 500)
		}

		function selectAllPhases() {
			var checkboxes = document.getElementsByClassName("pfilterCheckbox");
			for (i = 0; i < checkboxes.length; i++) {
				if (!checkboxes[i].checked) {
					checkboxes[i].click()
				}
			}
		}

		function deselectAllPhases() {
			var checkboxes = document.getElementsByClassName("pfilterCheckbox");
			for (i = 0; i < checkboxes.length; i++) {
				if (checkboxes[i].checked) {
					checkboxes[i].click();
				}
			}
		}

		function selectAllStylings() {
			var checkboxes = document.getElementsByClassName("stylingCheckbox");
			for (i = 0; i < checkboxes.length; i++) {
				console.log(checkboxes[i].checked)
				if (!checkboxes[i].checked) {
					checkboxes[i].click();
				}
			}
		}

		function deselectAllStylings() {
			var checkboxes = document.getElementsByClassName("stylingCheckbox");
			for (i = 0; i < checkboxes.length; i++) {
				if (checkboxes[i].checked) {
					checkboxes[i].click();
				}
			}
		}

		window.addEventListener("resize", getImageDimensions);
		//document.getElementsByClassName("navbar")[0].getElementsByTagName("ul")[0].innerHTML = ""
	</script>
</html>