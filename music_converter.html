<html>
    <head>
        <title>N64 Midi Tool (DK64 Edition)</title>
        <style>
            .hide {
                display: none;
            }
        </style>
    </head>
    <body>
        <h1>Donkey Kong 64 Midi Converter</h1>
        <label for="file-selector">Midi File</label>
        <input type="file" id="file-selector" accept=".midi, .mid"/>
        <div id="conversion-panel" class="hide">
            <div>
                <label for="loop-point">Loop Point (Leave blank if doesn't loop)</label>
                <input type="number" id="loop-point"/>
            </div>
            <button onclick="toBinary()">Convert to binary</button>
        </div>

        <script src="script/n64miditool.js"></script>
        <script>
            let current_midi_file = []
            let output_bin_file = []
            document.getElementById("file-selector").addEventListener("change", function() {
                var fr = new FileReader();
                fr.onload = function() {
                    var data = fr.result;
                    setup_data = fr.result;
                    var array = new Uint8Array(data);
                    current_midi_file = array.slice()
                    document.getElementById("conversion-panel").classList.remove("hide")
                    console.log(current_midi_file)
                };
                fr.readAsArrayBuffer(document.getElementById("file-selector").files[0]);
            })

            function toBinary() {
                loop_raw = document.getElementById("loop-point").value
                input_file_name = document.getElementById("file-selector").value
                loop = loop_raw != "" // TODO: hook this up to UI
                loop_point = Number(loop_raw) // TODO: hook this up to UI
                no_repeaters = true
                output_segments = input_file_name.split(".")[0].split("\\")
                output_file = output_segments[output_segments.length - 1] + ".bin"


                console.log("Does Loop:",loop)
                console.log("Loop Point:",loop_point)
                console.log("Disable Repeaters:",no_repeaters)
                console.log("Output File:",output_file)
                output_bin_file = MidiToGEFormat(current_midi_file, [], loop, loop_point, no_repeaters)
                data_len = output_bin_file.length
                cap = 0x10
                if ((data_len % cap) != 0) {
                    for (let x = 0; x < (cap - (data_len % cap)); x++) {
                        output_bin_file.push(0)
                    } 
                }
                console.log(output_bin_file)
                writeToFile(output_bin_file, output_file)
            }
        </script>
    </body>
</html>