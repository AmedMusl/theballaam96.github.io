<html>
    <head>
        <title>N64 Midi Tool (DK64 Edition)</title>
        <link rel="stylesheet" href="style/nav.css">
		<link rel="stylesheet" href="style/main.css">
        <link rel="stylesheet" href="style/home.css">
        <link rel="stylesheet" href="style/midi-converter.css">
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
		<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
		<link rel="manifest" href="/site.webmanifest">
		<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
		<meta name="msapplication-TileColor" content="#da532c">
		<meta name="theme-color" content="#ffffff">
		<meta name="description" content="" />
        <script type="text/javascript" src="https://unpkg.com/tone@latest/build/Tone.js"></script>
		<script type="text/javascript" src="https://unpkg.com/@tonejs/ui@0.0.8/build/tonejs-ui.js"></script>
        <script type="text/javascript" src="https://unpkg.com/@tonejs/midi"></script>
        <script src="script/libfluidsynth-2-3-0.min.js"></script>
        <script src="script/js-synthesizer.min.js"></script>
        <link rel="preload" as="script" href="script/js-synthesizer.worklet.min.js">
        <script src="script/n64miditool.js"></script>
    </head>
    <body>
        <nav id="navigation"></nav>
		<nav id="navigation"></nav>
        <div class="v_spacer">

		</div>
        <div class="flexsplitter center-container">
            <div class="flexsplitter center-block">
                <div class="homebox">
                    <div class="header master_header">
                        <strong>Donkey Kong 64 Midi Converter</strong>
                    </div>
                </div>
            </div>
        </div>
        <div class="flexsplitter center-container">
            <div class="flexsplitter center-block">
                <div class="homebox" style="color:white">
                    <div class="flexsplitter">
                        <div class="tab selected" association="midi-to-bin">Midi to Bin</div>
                        <div class="tab" association="midi-porting">Midi Porting</div>
                    </div>
                    <br>
                    <div id="midi-to-bin">
                        <div class="flexsplitter">
                            <div id="left-separator" class="sep">
                                <!-- Left box -->
                                <h3>Song Loading</h3>
                                <div class="flexsplitter">
                                    <button class="midi-loaders" onclick="clickEl('file-selector')">Load MIDI</button>
                                    <button class="midi-loaders req-midi hide" onclick="clickEl('soundfont-selector')">Load Soundfont</button>
                                </div>
                                <input type="file" class="hide" id="file-selector" accept=".midi, .mid"/>
                                <input type="file" class="hide" id="soundfont-selector" accept=".sf2"/>
                                <div class="req-midi">
                                    <div id="stats">
                                        <div id="stat-name"></div>
                                        <div id="stat-duration"></div>
                                        <div id="stat-durationticks"></div>
                                        <div id="stat-durationmeasures"></div>
                                        <div id="stat-ppq"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="sep req-midi hide">
                                <!-- Right box -->
                                <h3>Song Actions</h3>
                                <div class="req-midi" class="hide">
                                    <div id="player" class="hide">
                                        <div style="text-align:left;font-weight:bold">Play Song</div>
                                        <div style="font-style:italic;text-align:left">
                                            <strong>NOTE:</strong> This won't sound *exactly* like how it will in game. This is just a rough approximation
                                        </div>
                                        <div class="flexsplitter">
                                            <span id="play-button" onclick="playMusic()">&#9654;</span>
                                            <input
                                                type="range" 
                                                min="0" 
                                                max="100" 
                                                id="player-navigator" 
                                                ontouchstart="navigatorClick(true)" onmousedown="navigatorClick(true)"
                                                ontouchend="navigatorClick(false)" onmouseup="navigatorClick(false)"
                                                ontouchmove="navigatorMove()" onmousemove="navigatorMove()"
                                                />
                                            <span id="player-position-display"></span>
                                        </div>
                                    </div>
                                    <div id="player-sep" class="hide">
                                        <hr>
                                        <div style="text-align:left;font-weight:bold">Binary Generation Settings</div>
                                    </div>
                                    <div class="flexsplitter">
                                        <div class="sep">
                                            <label>Loop:</label>
                                            <input id="loop-check" type="checkbox" onclick="toggleLoop()" />
                                        </div>
                                        <div id="loop-point-info" class="sep hide" style="flex:2">
                                            <label for="loop-point">Loop Point (Ticks)</label>
                                            <input type="number" id="loop-point" value="0"/>
                                        </div>
                                    </div>
                                    <button onclick="toBinary()">Convert to binary</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="midi-porting" class="hide">
                        Coming soon
                    </div>
                </div>
            </div>
        </div>
        <script src="script/nav.js"></script>
        <script src="script/sfplayer.js"></script>
        <script>
            function clickEl(id) {
                document.getElementById(id).click();
            }
            tabs = document.getElementsByClassName("tab")
            for (let t = 0; t < tabs.length; t++) {
                tabs[t].addEventListener("click", function(e) {
                    targ = e.target
                    for (let u = 0; u < tabs.length; u++) {
                        tabs[u].classList.remove("selected")
                        assoc = tabs[u].getAttribute("association")
                        document.getElementById(assoc).classList.add("hide")
                    }
                    targ.classList.add("selected")
                    elm = targ.getAttribute("association")
                    document.getElementById(elm).classList.remove("hide")
                })
            }

            function last(arr) {
                return arr[arr.length - 1]
            }

            function updateStats(midi_json) {
                second_floor_grade = 100
                minutes = Math.floor(midi_json.duration / 60)
                seconds = Math.floor((midi_json.duration - (60 * minutes)) * second_floor_grade) / second_floor_grade
                s_str = seconds.toString()
                if (seconds < 10) {
                    s_str = "0" + s_str
                }
                measures = (midi_json.durationTicks / midi_json.header.ppq) / 4
                measures = Math.floor(measures * second_floor_grade) / second_floor_grade
                name = last(document.getElementById("file-selector").value.split("\\"))
                document.getElementById("stat-name").innerText = `MIDI Name: ${name}`;
                document.getElementById("stat-duration").innerText = `Duration: ${minutes}:${s_str}`
                document.getElementById("stat-durationticks").innerText = `Duration (Ticks): ${midi_json.durationTicks}`
                document.getElementById("stat-durationmeasures").innerText = `Duration (Measures): ${measures}`
                document.getElementById("stat-ppq").innerText = `Pulses per Quarter-Note: ${midi_json.header.ppq}`

                stats = ["stat-name","stat-duration","stat-durationticks","stat-durationmeasures","stat-ppq"]
                stats.forEach(stat => {
                    txt = document.getElementById(stat).innerText
                    head = txt.split(":")[0]
                    info = txt.split(":").filter((item, index) => {
                        return index != 0
                    }).join(":")
                    document.getElementById(stat).innerHTML = `<strong>${head}</strong>: ${info}`
                })
            }

            function u8arrayToBuffer(array) {
                return array.buffer.slice(array.byteOffset, array.byteLength + array.byteOffset)
            }

            let current_midi_file = []
            let output_bin_file = []
            let ticks_per_quarter = 0
            let currentMidi = null;
            let midiBuffer = null;
            let sfBuffer = null;
            document.getElementById("file-selector").addEventListener("change", function(e) {
                var fr = new FileReader();
                fr.onload = function() {
                    var data = fr.result;
                    setup_data = fr.result;
                    var array = new Uint8Array(data);
                    current_midi_file = array.slice()
                    let midi_reqs = document.getElementsByClassName("req-midi")
                    for (let m = 0; m < midi_reqs.length; m++) {
                        midi_reqs[m].classList.remove("hide")
                    }
                    document.getElementById("left-separator").classList.add("sep-left")
                    console.log(current_midi_file)
                    // Midi Stat stuff
                    const midi = new Midi(data);
                    document.getElementById("player-navigator").setAttribute("min", 0)
                    document.getElementById("player-navigator").value = 0
                    document.getElementById("player-navigator").setAttribute("max", midi.durationTicks)
                    document.getElementById("player-navigator").setAttribute("t_s", midi.duration)
                    updateStats(midi)
                    //console.log(midi)
                    midiURL = URL.createObjectURL(e.target.files[0])
                    midiBuffer = u8arrayToBuffer(array)
                    
                };
                fr.readAsArrayBuffer(document.getElementById("file-selector").files[0]);
            })
            document.getElementById("soundfont-selector").addEventListener("change", function(e) {
                var fr = new FileReader();
                fr.onload = function() {
                    var data = fr.result;
                    var array = new Uint8Array(data);
                    sfURL = URL.createObjectURL(e.target.files[0])
                    sfBuffer = u8arrayToBuffer(array)
                    document.getElementById("player").classList.remove("hide")             
                    document.getElementById("player-sep").classList.remove("hide")             
                };
                fr.readAsArrayBuffer(document.getElementById("soundfont-selector").files[0]);
            })

            function toBinary() {
                input_file_name = document.getElementById("file-selector").value
                loop_data = getLoopStatus()
                loop = loop_data["loop"]
                loop_point = loop_data["point"]
                no_repeaters = true
                output_segments = input_file_name.split(".")[0].split("\\")
                output_file = output_segments[output_segments.length - 1] + ".bin"


                console.log("Does Loop:",loop)
                console.log("Loop Point:",loop_point)
                console.log("Disable Repeaters:",no_repeaters)
                console.log("Output File:",output_file)
                output_bin_file = MidiToGEFormat(current_midi_file, [], loop, loop_point, no_repeaters)
                data_len = output_bin_file.length
                cap = 0x10
                if ((data_len % cap) != 0) {
                    for (let x = 0; x < (cap - (data_len % cap)); x++) {
                        output_bin_file.push(0)
                    } 
                }
                console.log(output_bin_file)
                writeToFile(output_bin_file, output_file)
            }

            function toggleLoop() {
                const hook = document.getElementById("loop-point-info")
                if (document.getElementById("loop-check").checked) {
                    hook.classList.remove("hide")
                } else {
                    hook.classList.add("hide")
                }
                console.log()
            }
        </script>
    </body>
</html>