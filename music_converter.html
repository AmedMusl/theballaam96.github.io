<html data-bs-theme="dark" lang="en">
    <head>
        <title>N64 Midi Tool (DK64 Edition)</title>
        <link rel="stylesheet" href="style/nav.css">
		<link rel="stylesheet" href="style/main.css">
        <link rel="stylesheet" href="style/home.css">
        <link rel="stylesheet" href="style/midi-converter.css">
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
		<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
		<link rel="manifest" href="/site.webmanifest">
		<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
		<meta name="msapplication-TileColor" content="#da532c">
		<meta name="theme-color" content="#ffffff">
		<meta name="description" content="" />
        <script src="script/file-buffer.js"></script>
        <script type="text/javascript" src="https://unpkg.com/tone@latest/build/Tone.js"></script> <!-- MIDI Stats -->
		<script type="text/javascript" src="https://unpkg.com/@tonejs/ui@0.0.8/build/tonejs-ui.js"></script> <!-- MIDI Stats -->
        <script type="text/javascript" src="https://unpkg.com/@tonejs/midi"></script> <!-- MIDI Stats -->
        <script src="script/libfluidsynth-2-3-0.min.js"></script> <!-- MIDI Playing -->
        <script src="script/js-synthesizer.min.js"></script> <!-- MIDI Playing -->
        <script src="script/pako.js"></script> <!-- File Compression -->
        <link as="script" href="script/js-synthesizer.worklet.min.js"> <!-- MIDI Playing -->
        <script src="script/n64miditool.js"></script>
        <!-- Bootstrap -->
        <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
        <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
        <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
        <!-- BPS Handling -->
        <script type="text/javascript" src="script/bps.js" defer></script>
        <script type="text/javascript" src="script/MarcFile.js" defer></script>

        <style>
            body {
                background-image: none;
                background-color: rgba(30, 30, 30, 1);
            }
            .main_panel {
                width: 80%;
                margin-left: auto;
                margin-right: auto;
                padding: 20px;
            }
        </style>
    </head>
    <body>
        <nav class="navbar sticky-top navbar-expand-lg bg-body-tertiary">
            <div class="container-fluid">
                <a class="navbar-brand excluded_link" href="#" onclick="hidePopup()">
                    Music Converter
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" style="width:fit-content;width:-moz-fit-content">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link excluded_link" href="#"><i class="fa-solid fa-file"></i> MIDI to Bin</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link excluded_link" href="#" data-bs-toggle="modal" data-bs-target="#portingModal"><i class="fa-solid fa-arrows-left-right-to-line"></i> Midi Porting</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link excluded_link" href="#" data-bs-toggle="modal" data-bs-target="#soundfontModal"><i class="fa-solid fa-headphones"></i> Fix Soundfont</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <!-- Inputs -->
        <input type="file" class="hide" id="file-selector" accept=".midi, .mid"/>
        <input type="file" class="hide" id="soundfont-selector" accept=".sf2"/>
        <input type="file" class="hide" id="dls-selector" accept=".dls"/>
        <input type="file" class="hide" id="rom-selector" accept=".z64"/>
        <!-- Song to Binary -->
        <div class="main_panel">
            <p>
                Converts a MIDI File into a binary format that can be read and played by Donkey Kong 64 in-game.
            </p>
            <p>
                The binary file can either be extracted as a standalone file for usage in <span style="font-style:italic">Randomizer</span> or <span style="font-style:italic">Cranky's Lab</span>
                , or imported straight into a ROM.
            </p>
            <button class="btn btn-outline-info" style="width:fit-content" onclick="clickEl('file-selector')">
                <i class="fa-solid fa-file-arrow-up"></i> Upload MIDI
            </button>
            <button class="btn btn-outline-warning" style="width:fit-content" onclick="clickEl('soundfont-selector')">
                <i class="fa-solid fa-file-arrow-up"></i> Load Soundfont
            </button>
            <div id="stats">
                <div id="stat-name"></div>
                <div id="stat-duration"></div>
                <div id="stat-durationticks"></div>
                <div id="stat-durationmeasures"></div>
                <div id="stat-ppq"></div>
                <div id="stat-size"></div>
            </div>
        </div>
        <!-- Soundfont Modal -->
        <div class="modal fade" id="soundfontModal" tabindex="-1" aria-labelledby="soundfontModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="soundfontModalLabel">Fix Soundfont</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Fixes the soundfont extracted with N64 Soundbank tool to sound better in editors like FL Studio.<br>
                        Fixes by:
                        <ul>
                            <li><a href="https://www.youtube.com/@glitchglidertwo">GlitchGlider</a></li>
                        </ul>
                        <div class="flexsplitter">
                            <button class="sf-loaders" id="dls-loader" onclick="clickEl('dls-selector')" style="width:100%">Load Soundfont (DLS)</button>
                        </div>
                        <div id="sf-correction" class="hide">
                            <div id="soundfont-controls" class="hide">
                                <br />
                                <h3>Select output format</h3>
                                <div class="flexsplitter">
                                    <div class="dls-radio-container">
                                        <button class="sf-loaders dls-radio button-radio-selected" onclick="clickEl('sf-convert-dls'); handleButtonRadios(this, 'dls-radio')">DLS</button>
                                    </div>
                                    <div class="dls-radio-container">
                                        <button class="sf-loaders dls-radio" onclick="clickEl('sf-convert-sf2'); handleButtonRadios(this, 'dls-radio')">SF2</button>
                                    </div>
                                </div>
                                <input type="radio" id="sf-convert-dls" name="sf-convert" value="dls" class="dls-radio-internal hide" checked />
                                <input type="radio" id="sf-convert-sf2" name="sf-convert" value="sf2" class="dls-radio-internal hide"/>
                                <br />
                                <h3>Download Fixed Soundfont</h3>
                                <div class="flexsplitter">
                                    <button class="sf-loaders" id="sf-downloader" onclick="downloadSoundfont()" style="width:100%">Download</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Porting Modal -->
        <div class="modal fade" id="portingModal" tabindex="-1" aria-labelledby="portingModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="portingModalLabel">MIDI Porting</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Converts a MIDI File from one game into the Donkey Kong 64 soundfont. Currently only supports the N64 Banjo titles due to 
                        their similarities to DK64 music-wise enabling music to sound very similar between games. However, this tool does have the
                        functionality to expand to any midi format from any game or general MIDI in general.
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>


        <div class="flexsplitter center-container">
            <div class="flexsplitter center-block">
                <div class="homebox" style="color:white">
                    <div class="flexsplitter">
                        <div id="left-separator" class="sep">
                            <!-- Left box -->
                            
                            <div class="req-edit-midi">
                                <div class="req-midi">
                                    
                                </div>
                            </div>
                        </div>
                        <div class="sep req-midi hide">
                            <div class="req-edit-midi">
                                <div class="req-midi hide">
                                    <div id="midi-to-bin">
                                        <!-- Right box -->
                                        <h3>Song Actions</h3>
                                        <div class="req-midi" class="hide">
                                            <div id="player" class="hide">
                                                <div style="text-align:left;font-weight:bold">Play Song</div>
                                                <div style="font-style:italic;text-align:left">
                                                    <strong>NOTE:</strong> This won't sound *exactly* like how it will in game. This is just a rough approximation
                                                </div>
                                                <div class="flexsplitter">
                                                    <span id="play-button" onclick="playMusic()">&#9654;</span>
                                                    <input
                                                        type="range" 
                                                        min="0" 
                                                        max="100" 
                                                        id="player-navigator" 
                                                        ontouchstart="navigatorClick(true)" onmousedown="navigatorClick(true)"
                                                        ontouchend="navigatorClick(false)" onmouseup="navigatorClick(false)"
                                                        ontouchmove="navigatorMove(false)" onmousemove="navigatorMove(false)"
                                                        />
                                                    <span id="player-position-display"></span>
                                                </div>
                                            </div>
                                            <div id="player-sep" class="hide">
                                                <hr>
                                                <div style="text-align:left;font-weight:bold">Binary Generation Settings</div>
                                            </div>
                                            <div class="flexsplitter">
                                                <div class="sep" style="text-align:left">
                                                    <label>Loop:</label>
                                                    <input id="loop-check" type="checkbox" onclick="toggleLoop()" />
                                                </div>
                                                <div id="loop-point-info" class="sep hide" style="flex:2">
                                                    <label for="loop-point">Loop Point (Ticks)</label>
                                                    <input type="number" id="loop-point" value="0" onkeyup="setPreloadState(false)"/>
                                                </div>
                                            </div>
                                            <div class="flexsplitter">
                                                <div class="sep">
                                                    <button onclick="toBinary(true)" class="song-action-button">Convert to binary</button>
                                                </div>
                                                <div class="sep">
                                                    <div class="req-no-preload">
                                                        <button onclick="preloadROMWrite()" class="song-action-button">Preload ROM Write</button>
                                                    </div>
                                                    <div class="req-preload hide">
                                                        <button onclick="writeToROM()" class="song-action-button">Write to ROM</button>
                                                    </div>
                                                    <div class="req-preload hide">
                                                        <div class="list-choice">
                                                            <div class="list-choice-title">Select Song</div>
                                                            <div class="list-choice-objects" id="song_list"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="midi-porting" class="hide">
                                        <div class="list-choice">
                                            <div class="list-choice-title">Select Template</div>
                                            <div class="list-choice-objects" id="template_select"></div>
                                        </div>
                                        <button onclick="instrumentChange()">
                                            Write new MIDI
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="script/sfplayer.js"></script>
        <script>
            function clickEl(id) {
                document.getElementById(id).click();
            }
            tabs = document.getElementsByClassName("tab")
            for (let t = 0; t < tabs.length; t++) {
                tabs[t].addEventListener("click", function(e) {
                    targ = e.target
                    for (let u = 0; u < tabs.length; u++) {
                        tabs[u].classList.remove("selected")
                        assoc = tabs[u].getAttribute("association")
                        console.log(assoc)
                        document.getElementById(assoc).classList.add("hide")
                        document.getElementById(`exp-${assoc}`).classList.add("hide")
                        edit_type = tabs[u].getAttribute("editing")
                        edits = document.getElementsByClassName(`req-edit-${edit_type}`)
                        for (let c = 0; c < edits.length; c++) {
                            edits[c].classList.add("hide")
                        }
                    }
                    targ.classList.add("selected")
                    elm = targ.getAttribute("association")
                    document.getElementById(elm).classList.remove("hide")
                    document.getElementById(`exp-${elm}`).classList.remove("hide")
                    edit_type = targ.getAttribute("editing")
                    edits = document.getElementsByClassName(`req-edit-${edit_type}`)
                    for (let c = 0; c < edits.length; c++) {
                        edits[c].classList.remove("hide")
                    }
                })
            }

            function handleButtonRadios(evt, cls) {
                radios = document.getElementsByClassName(cls);
                for (let i = 0; i < radios.length; i++) {
                    radios[i].classList.remove("button-radio-selected");
                }
                evt.classList.add("button-radio-selected");
            }

            let dls_base = null;
            let dls_base_res = null;
            document.getElementById("dls-selector").addEventListener("change", function() {
                var fr = new FileReader();
                fr.onload = function() {
                    console.log("Loading DLS")
                    var data = fr.result;
                    console.log(data)
                    dls_base_res = data;
                    dls_base = new MarcFile(new Uint8Array(data));
                    console.log(dls_base)
                };
                fr.readAsArrayBuffer(document.getElementById("dls-selector").files[0]);
            })
            
            // Download file
        var downloadBlob, downloadURL;
        downloadBlob = function(data, fileName, mimeType) {
            var blob, url;
            blob = new Blob([data], {
                type: mimeType
            });
            url = window.URL.createObjectURL(blob);
            downloadURL(url, fileName);
            setTimeout(function() {
                return window.URL.revokeObjectURL(url);
            }, 1000);
        };

        downloadURL = function(data, fileName) {
            var a;
            a = document.createElement('a');
            a.href = data;
            a.download = fileName;
            document.body.appendChild(a);
            a.style = 'display: none';
            a.click();
            a.remove();
        };

        function buildSoundfont(dls, bps, extension) {
            wwApply=new Worker("./script/worker_apply.js");
            console.log("Genned Worker")
            wwApply.postMessage(
				{
					romFileU8Array:dls._u8array,
					patchFileU8Array:bps._u8array,
					validateChecksums:false
				},[
					dls._u8array.buffer,
					bps._u8array.buffer
				]
			);
            console.log("Posted Message")
            wwApply.onmessage = event => { // listen for events from the worker
                console.log("Message received")
                console.log(event.data)
                var newFile=new MarcFile(event.data.patchedRomU8Array);
                downloadBlob(newFile._u8array,`dk64-soundfont-fixed.${extension}`,"application/octet-stream")
            };
        }

            async function downloadSoundfont() {
                let output_format = null;
                const radios = document.getElementsByClassName("dls-radio-internal");
                for (let r = 0; r < radios.length; r++) {
                    if (radios[r].checked) {
                        output_format = radios[r].value;
                    }
                }
                const BPS_HEAD = "v5";
                if (output_format != null) {
                    fetch(`./data/soundfont_correctors/${BPS_HEAD}-${output_format}.bps`)
                    .then(res => res.blob())
                    .then(data => data.arrayBuffer())
                    .then(ab => {
                        console.log(ab)
                        u8 = new Uint8Array(ab);
                        patch = new MarcFile(u8);
                        console.log(patch)
                        //setPatch(patch);
                        //setBase(dls_base);
                        //applyPatch(new MarcFile(dls_base_res), new MarcFile(u8), false)
                        buildSoundfont(dls_base, new MarcFile(u8), output_format);
                        document.getElementById("sf-downloader").setAttribute("disabled","disabled")
                    })
                }
            }

            function last(arr) {
                return arr[arr.length - 1]
            }

            function updateStatStyle() {
                stats = ["stat-name","stat-duration","stat-durationticks","stat-durationmeasures","stat-ppq"]
                stats.forEach(stat => {
                    txt = document.getElementById(stat).innerText
                    head = txt.split(":")[0]
                    info = txt.split(":").filter((item, index) => {
                        return index != 0
                    }).join(":")
                    document.getElementById(stat).innerHTML = `<strong>${head}</strong>: ${info}`
                })
            }

            const VANILLA_BIN_LIMIT = 16512
            const RANDO_BIN_LIMIT = 32768

            function updateBinarySize() {
                toBinary(false)
                const data = new Uint8Array(output_bin_file.slice());
                document.getElementById("stat-size").innerHTML = `<strong>Binary Size</strong>: ${data.length} ${
                    data.length > VANILLA_BIN_LIMIT ?
                    `<span title='${
                        data.length > RANDO_BIN_LIMIT ? "File is too big for DK64 Randomizer" : "File is too big for vanilla DK64, but not randomizer"
                    }' class='${
                        data.length > RANDO_BIN_LIMIT ? "major-warning" : "minor-warning"
                    }'>&nbsp;&#9888;</span>` :
                    ""
                } <span class="reload noselect" id="recalculate-binary" title="Recalculate" onclick="updateBinarySize()">&#x21bb;</span>`
                updateStatStyle()
            }

            

            function updateStats(midi_json) {
                second_floor_grade = 100
                minutes = Math.floor(midi_json.duration / 60)
                seconds = Math.floor((midi_json.duration - (60 * minutes)) * second_floor_grade) / second_floor_grade
                s_str = seconds.toString()
                if (seconds < 10) {
                    s_str = "0" + s_str
                }
                measures = (midi_json.durationTicks / midi_json.header.ppq) / 4
                measures = Math.floor(measures * second_floor_grade) / second_floor_grade
                name = last(document.getElementById("file-selector").value.split("\\"))
                document.getElementById("stat-name").innerText = `MIDI Name: ${name}`;
                document.getElementById("stat-duration").innerText = `Duration: ${minutes}:${s_str}`
                document.getElementById("stat-durationticks").innerText = `Duration (Ticks): ${midi_json.durationTicks}`
                document.getElementById("stat-durationmeasures").innerText = `Duration (Measures): ${measures}`
                document.getElementById("stat-ppq").innerText = `Pulses per Quarter-Note: ${midi_json.header.ppq}`
                updateBinarySize()

                updateStatStyle()
            }

            function u8arrayToBuffer(array) {
                return array.buffer.slice(array.byteOffset, array.byteLength + array.byteOffset)
            }

            let current_midi_file = []
            let compressed_midi = []
            let output_bin_file = []
            let rom_file = []
            let ticks_per_quarter = 0
            let currentMidi = null;
            let midiBuffer = null;
            let sfBuffer = null;
            document.getElementById("file-selector").addEventListener("change", function(e) {
                var fr = new FileReader();
                fr.onload = function() {
                    var data = fr.result;
                    setup_data = fr.result;
                    var array = new Uint8Array(data);
                    //window.clampMidi(fr.result)
                    current_midi_file = array.slice()
                    let midi_reqs = document.getElementsByClassName("req-midi")
                    for (let m = 0; m < midi_reqs.length; m++) {
                        midi_reqs[m].classList.remove("hide")
                    }
                    document.getElementById("left-separator").classList.add("sep-left")
                    console.log(current_midi_file)
                    // Midi Stat stuff
                    const midi = new Midi(data);
                    document.getElementById("player-navigator").setAttribute("min", 0)
                    document.getElementById("player-navigator").value = 0
                    document.getElementById("player-navigator").setAttribute("max", midi.durationTicks)
                    document.getElementById("player-navigator").setAttribute("t_s", midi.duration)
                    updateStats(midi)
                    //console.log(midi)
                    midiURL = URL.createObjectURL(e.target.files[0])
                    midiBuffer = u8arrayToBuffer(array)
                    setPreloadState(false);
                    document.getElementById("loop-check").checked = false;
                    if (synth) {
                        synth.stopPlayer();
                    }
                };
                fr.readAsArrayBuffer(document.getElementById("file-selector").files[0]);
            })
            document.getElementById("soundfont-selector").addEventListener("change", function(e) {
                var fr = new FileReader();
                fr.onload = function() {
                    var data = fr.result;
                    var array = new Uint8Array(data);
                    sfURL = URL.createObjectURL(e.target.files[0])
                    sfBuffer = u8arrayToBuffer(array)
                    document.getElementById("player").classList.remove("hide")             
                    document.getElementById("player-sep").classList.remove("hide")
                    document.getElementById("soundfont-controls").classList.remove("hide")
                    if (synth) {
                        synth.stopPlayer();
                    }
                };
                fr.readAsArrayBuffer(document.getElementById("soundfont-selector").files[0]);
            })
            document.getElementById("dls-selector").addEventListener("change", function(e) {
                var fr = new FileReader();
                fr.onload = function() {
                    var data = fr.result;
                    var array = new Uint8Array(data);
                    document.getElementById("soundfont-controls").classList.remove("hide")
                };
                fr.readAsArrayBuffer(document.getElementById("dls-selector").files[0]);
            })
            document.getElementById("rom-selector").addEventListener("change", function(e) {
                var fr = new FileReader();
                fr.onload = function() {
                    var data = fr.result;
                    rom_file = new Uint8Array(data);
                    const song_data = finishPreload(rom_file);
                    const any_song_loaded = loadSongList(compressed_midi.length, song_data["song_data"])
                    setPreloadState(any_song_loaded);
                    if (!any_song_loaded) {
                        throw new Error(`Song too big for ROM. (${compressed_midi.length} bytes)`)
                    }
                };
                fr.readAsArrayBuffer(document.getElementById("rom-selector").files[0]);
            })

            function toBinary(write_binary) {
                input_file_name = document.getElementById("file-selector").value
                loop_data = getLoopStatus()
                loop = loop_data["loop"]
                loop_point = loop_data["point"]
                no_repeaters = true
                output_segments = input_file_name.split(".")[0].split("\\")
                output_file = output_segments[output_segments.length - 1] + ".bin"

                console.log("Does Loop:",loop)
                console.log("Loop Point:",loop_point)
                console.log("Disable Repeaters:",no_repeaters)
                console.log("Output File:",output_file)
                output_bin_file = MidiToGEFormat(current_midi_file, [], loop, loop_point, no_repeaters, true)
                data_len = output_bin_file.length
                cap = 0x10
                if ((data_len % cap) != 0) {
                    for (let x = 0; x < (cap - (data_len % cap)); x++) {
                        output_bin_file.push(0)
                    } 
                }
                console.log(output_bin_file)
                if (write_binary) {
                    writeToFile(output_bin_file, output_file)
                }
            }

            function toggleLoop() {
                const hook = document.getElementById("loop-point-info")
                if (document.getElementById("loop-check").checked) {
                    hook.classList.remove("hide")
                } else {
                    hook.classList.add("hide")
                }
                setPreloadState(false);
            }

            function setPreloadState(show) {
                const preloaders = document.getElementsByClassName("req-preload")
                const anti_preloaders = document.getElementsByClassName("req-no-preload")
                for (let p = 0; p < preloaders.length; p++) {
                    if (show) {
                        preloaders[p].classList.remove("hide")
                    } else {
                        preloaders[p].classList.add("hide")
                    }
                }
                for (let p = 0; p < anti_preloaders.length; p++) {
                    if (show) {
                        anti_preloaders[p].classList.add("hide")
                    } else {
                        anti_preloaders[p].classList.remove("hide")
                    }
                }
                if (!show) {
                    document.getElementById("rom-selector").value = null;
                }
            }
            
            function preloadROMWrite() {
                toBinary(false)
                const data = new Uint8Array(output_bin_file.slice());
                compressed_midi = Array.from(pako.gzip(data, {"level": 9}));
                clickEl("rom-selector");
            }

            function writeToROM() {
                let slot_childen = document.getElementById("song_list").getElementsByTagName("input")
                let slot = null;
                for (let s = 0; s < slot_childen.length; s++) {
                    if (slot_childen[s].checked) {
                        slot = Number(slot_childen[s].getAttribute("song-id"))
                    }
                }
                if (slot != null) {
                    const new_rom = writeToROMInternal(rom_file.slice(), slot, compressed_midi.slice());
                    writeToFile(new_rom, "song-altered-dk64.z64");
                }
            }

            const SONG_ITEMS = [
                "Silence",
                "Jungle Japes (Starting Area)",
                "Cranky's Lab",
                "Jungle Japes (Minecart)",
                "Jungle Japes (Army Dillo)",
                "Jungle Japes (Caves/Underground)",
                "Funky's Hut",
                "Unused Coin Pickup",
                "Bonus Minigames",
                "Triangle Trample",
                "Guitar Gazump",
                "Bongo Blast",
                "Trombone Tremor",
                "Saxaphone Slam",
                "Angry Aztec",
                "Transformation",
                "Mini Monkey",
                "Hunky Chunky",
                "GB/Key Get",
                "Angry Aztec (Beetle Slide)",
                "Oh Banana",
                "Angry Aztec (Temple)",
                "Company Coin Get",
                "Banana Coin Get",
                "Going through Vulture Ring",
                "Angry Aztec (Dogadon)",
                "Angry Aztec (5DT)",
                "Frantic Factory (Car Race)",
                "Frantic Factory",
                "Snide's HQ",
                "Jungle Japes (Tunnels)",
                "Candy's Music Shop",
                "Minecart Coin Get",
                "Melon Slice Get",
                "Pause Menu",
                "Crystal Coconut Get",
                "Rambi",
                "Angry Aztec (Tunnels)",
                "Water Droplets",
                "Frantic Factory (Mad Jack)",
                "Success",
                "Start (To pause game)",
                "Failure",
                "DK Transition (Opening)",
                "DK Transition (Closing)",
                "Unused High-Pitched Japes",
                "Fairy Tick",
                "Melon Slice Drop",
                "Angry Aztec (Chunky Klaptraps)",
                "Frantic Factory (Crusher Room)",
                "Jungle Japes (Baboon Blast)",
                "Frantic Factory (R&D)",
                "Frantic Factory (Production Room)",
                "Troff 'n' Scoff",
                "Boss Defeat",
                "Angry Aztec (Baboon Blast)",
                "Gloomy Galleon (Outside)",
                "Boss Unlock",
                "Awaiting Entering the Boss",
                "Generic Twinkly Sounds",
                "Gloomy Galleon (Pufftoss)",
                "Gloomy Galleon (Seal Race)",
                "Gloomy Galleon (Tunnels)",
                "Gloomy Galleon (Lighthouse)",
                "Battle Arena",
                "Drop Coins (Minecart)",
                "Fairy Nearby",
                "Checkpoint",
                "Fungi Forest (Day)",
                "Blueprint Get",
                "Fungi Forest (Night)",
                "Strong Kong",
                "Rocketbarrel Boost",
                "Orangstand Sprint",
                "Fungi Forest (Minecart)",
                "DK Rap",
                "Blueprint Drop",
                "Gloomy Galleon (2DS)",
                "Gloomy Galleon (5DS/Submarine)",
                "Gloomy Galleon (Pearls Chest)",
                "Gloomy Galleon (Mermaid Palace)",
                "Fungi Forest (Dogadon)",
                "Mad Maze Maul",
                "Crystal Caves",
                "Crystal Caves (Giant Kosha Tantrum)",
                "Nintendo Logo (Old?)",
                "Success (Races)",
                "Failure (Races & Try Again)",
                "Bonus Barrel Introduction",
                "Stealthy Snoop",
                "Minecart Mayhem",
                "Gloomy Galleon (Mechanical Fish)",
                "Gloomy Galleon (Baboon Blast)",
                "Fungi Forest (Anthill)",
                "Fungi Forest (Barn)",
                "Fungi Forest (Mill)",
                "Generic Seaside Sounds",
                "Fungi Forest (Spider)",
                "Fungi Forest (Mushroom Top Rooms)",
                "Fungi Forest (Giant Mushroom)",
                "Boss Introduction",
                "Tag Barrel (All of them)",
                "Crystal Caves (Beetle Race)",
                "Crystal Caves (Igloos)",
                "Mini Boss",
                "Creepy Castle",
                "Creepy Castle (Minecart)",
                "Baboon Balloon",
                "Gorilla Gone",
                "DK Isles",
                "DK Isles (K Rool's Ship)",
                "DK Isles (Banana Fairy Island)",
                "DK Isles (K-Lumsy's Prison)",
                "Hideout Helm (Blast-O-Matic On)",
                "Move Get",
                "Gun Get",
                "Hideout Helm (Blast-O-Matic Off)",
                "Hideout Helm (Bonus Barrels)",
                "Crystal Caves (Cabins)",
                "Crystal Caves (Rotating Room)",
                "Crystal Caves (Tile Flipping)",
                "Creepy Castle (Tunnels)",
                "Intro Story Medley",
                "Training Grounds",
                "Enguarde",
                "K-Lumsy Celebration",
                "Creepy Castle (Crypt)",
                "Headphones Get",
                "Pearl Get",
                "Creepy Castle (Dungeon w/ Chains)",
                "Angry Aztec (Lobby)",
                "Jungle Japes (Lobby)",
                "Frantic Factory (Lobby)",
                "Gloomy Galleon (Lobby)",
                "Main Menu",
                "Creepy Castle (Inner Crypts)",
                "Creepy Castle (Ballroom)",
                "Creepy Castle (Greenhouse)",
                "K Rool's Theme",
                "Fungi Forest (Winch)",
                "Creepy Castle (Wind Tower)",
                "Creepy Castle (Tree)",
                "Creepy Castle (Museum)",
                "BBlast Final Star",
                "Drop Rainbow Coin",
                "Rainbow Coin Get",
                "Normal Star",
                "Bean Get",
                "Crystal Caves (Army Dillo)",
                "Creepy Castle (Kut Out)",
                "Creepy Castle (Dungeon w/out Chains)",
                "Banana Medal Get",
                "K Rool's Battle",
                "Fungi Forest (Lobby)",
                "Crystal Caves (Lobby)",
                "Creepy Castle (Lobby)",
                "Hideout Helm (Lobby)",
                "Creepy Castle (Trash Can)",
                "End Sequence",
                "K-Lumsy Ending",
                "Jungle Japes",
                "Jungle Japes (Cranky's Area)",
                "K Rool Takeoff",
                "Crystal Caves (Baboon Blast)",
                "Fungi Forest (Baboon Blast)",
                "Creepy Castle (Baboon Blast)",
                "DK Isles (Snide's Room)",
                "K Rool's Entrance",
                "Monkey Smash",
                "Fungi Forest (Rabbit Race)",
                "Game Over",
                "Wrinkly Kong",
                "100th CB Get",
                "K Rool's Defeat",
                "Nintendo Logo",
            ]

            function loadSongList(max_size, sizes=null) {
                const hook = document.getElementById("song_list");
                html = "";
                let permit_total = false;
                SONG_ITEMS.forEach((song, index) => {
                    permit = max_size == -1;
                    if (max_size >= 0) {
                        if (sizes != null) {
                            permit = sizes[index] >= max_size;
                        }
                    }
                    if (permit) {
                        permit_total = true;
                        html += `<label>
                            <input type=\"radio\" name=\"Select Song\" song-id=\"${index}\">
                            <span>${song}</span>
                            </label>`
                    }
                })
                hook.innerHTML = html;
                return permit_total;
            }
            loadSongList(-1);

            function instrumentChange() {
                toBinary(false);
                readMidiPorting(current_midi_file.slice());
            }

            const TEMPLATE_DATA = [
                {"file": "bk", "name": "Banjo-Kazooie"},
                {"file": "bt", "name": "Banjo-Tooie"},
            ]

            function loadTemplates() {
                const hook = document.getElementById("template_select");
                html = "";
                TEMPLATE_DATA.forEach(template => {
                    html += `<label>
                        <input type=\"radio\" name=\"Select Song\" template-file=\"${template['file']}.json\">
                        <span>${template['name']}</span>
                        </label>`
                })
                hook.innerHTML = html;
            }
            loadTemplates();
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    </body>
</html>