<html data-bs-theme="dark" lang="en">
    <head>
        <title>DK64 Music Converter</title>
        <link rel="stylesheet" href="style/midi-converter.css">
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
		<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
		<link rel="manifest" href="/site.webmanifest">
		<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
		<meta name="msapplication-TileColor" content="#da532c">
		<meta name="theme-color" content="#ffffff">
		<meta name="description" content="" />
        <script src="script/file-buffer.js"></script>
        <script type="text/javascript" src="https://unpkg.com/tone@latest/build/Tone.js"></script> <!-- MIDI Stats -->
		<script type="text/javascript" src="https://unpkg.com/@tonejs/ui@0.0.8/build/tonejs-ui.js"></script> <!-- MIDI Stats -->
        <script type="text/javascript" src="https://unpkg.com/@tonejs/midi"></script> <!-- MIDI Stats -->
        <script src="script/libfluidsynth-2-3-0.min.js"></script> <!-- MIDI Playing -->
        <script src="script/js-synthesizer.min.js"></script> <!-- MIDI Playing -->
        <script src="script/pako.js"></script> <!-- File Compression -->
        <link as="script" href="script/js-synthesizer.worklet.min.js"> <!-- MIDI Playing -->
        <script src="script/n64miditool.js"></script>
        <!-- Bootstrap -->
        <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
        <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
        <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
        <!-- FA -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
        <!-- ChartJS -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <!-- BPS Handling -->
        <script type="text/javascript" src="script/bps.js" defer></script>
        <script type="text/javascript" src="script/MarcFile.js" defer></script>
        <!-- Discord -->
        <meta content="DK64 Music Converter" property="og:title" />
        <meta content="MIDI Converter, intended for usage with Donkey Kong 64. Will convert MIDI files to binary files which can be used in-game." property="og:description" />
        <meta content="DK64 Utils" property="og:site_name" />
        <meta content="https://raw.githubusercontent.com/theballaam96/theballaam96.github.io/master/assets/head.png" property="og:image" />

        <style>
            body {
                background-image: none;
                background-color: rgba(30, 30, 30, 1);
            }
            .main_panel {
                width: 80%;
                margin-left: auto;
                margin-right: auto;
                padding: 20px;
            }
            .hide {
                display: none!important;
            }
            .loop-height {
                height: 100%;
            }
            #volume_demo {
                background-color: green;
                height: 5px;
            }
            .bubble {
                background: #0d6efd;
                color: white;
                padding: 4px 12px;
                position: absolute;
                border-radius: 4px;
                left: 50%;
                transform: translateX(-50%);
                top: 2rem;
            }
            .bubble::after {
                content: "";
                position: absolute;
                width: 2px;
                height: 2px;
                background: #0d6efd;
                top: -1px;
                left: 50%;
            }
            .range-wrap {
                position: relative;
                margin: 0 auto 3rem;
            }
        </style>
    </head>
    <body>
        <nav class="navbar sticky-top navbar-expand-lg bg-body-tertiary">
            <div class="container-fluid">
                <a class="navbar-brand excluded_link" href="#">
                    Music Converter
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" style="width:fit-content;width:-moz-fit-content">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link excluded_link" href="#" data-bs-toggle="modal" data-bs-target="#portingModal"><i class="fa-solid fa-arrows-left-right-to-line"></i> Midi Porting</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link excluded_link" href="#" data-bs-toggle="modal" data-bs-target="#soundfontModal"><i class="fa-solid fa-headphones"></i> Fix Soundfont</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link excluded_link" href="#" data-bs-toggle="modal" data-bs-target="#rebalanceModal"><i class="fa-solid fa-sliders"></i> Rebalance MIDI</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle excluded_link" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                Resources
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item excluded_link" href="https://docs.google.com/spreadsheets/d/1ngZfHXbsOqFBTTCknMX0WEhyJ_xTcGP_a-1zPPY2AP0/edit#gid=48901832" rel="noreferrer noopener" target="_blank"><i class="fa-solid fa-font"></i> Soundfont Data Table</a></li>
                                <li><a class="dropdown-item excluded_link" href="https://pastebin.com/bSNHLsV3" rel="noreferrer noopener" target="_blank"><i class="fa-solid fa-list"></i> OST List</a></li>
                                <li><a class="dropdown-item excluded_link" href="https://youlean.co/file-loudness-meter/" rel="noreferrer noopener" target="_blank"><i class="fa-solid fa-volume-high"></i> Loudness Tester</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        <!-- Inputs -->
        <input type="file" class="hide" id="porting-midi-selector" accept=".midi, .mid"/>
        <input type="file" class="hide" id="rebalancing-midi-selector" accept=".midi, .mid"/>
        <input type="file" class="hide" id="file-selector" accept=".midi, .mid"/>
        <input type="file" class="hide" id="soundfont-selector" accept=".sf2"/>
        <input type="file" class="hide" id="dls-selector" accept=".dls"/>
        <input type="file" class="hide" id="rom-selector" accept=".z64"/>
        <!-- Song to Binary -->
        <div class="main_panel">
            <p>
                Converts a MIDI File into a binary format that can be read and played by Donkey Kong 64 in-game.
            </p>
            <p>
                The binary file can either be extracted as a standalone file for usage in <span style="font-style:italic">Randomizer</span> or <span style="font-style:italic">Cranky's Lab</span>
                , or imported straight into a ROM.
            </p>
            <div class="d-flex">
                <div class="px-3" style="flex:1">
                    <button class="btn btn-outline-info" style="width:100%" onclick="clickEl('file-selector')">
                        <i class="fa-solid fa-file-arrow-up"></i> Upload MIDI
                    </button>
                </div>
                <div class="px-3" style="flex:1">
                    <button class="btn btn-outline-warning" style="width:100%" onclick="clickEl('soundfont-selector')">
                        <i class="fa-solid fa-file-arrow-up"></i> Load Soundfont
                    </button>
                </div>
            </div>
        </div>
        <!-- Soundfont Modal -->
        <div class="modal fade" id="soundfontModal" tabindex="-1" aria-labelledby="soundfontModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="soundfontModalLabel">Fix Soundfont</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Fixes the soundfont extracted with N64 Soundbank tool to sound better in editors like FL Studio.<br>
                        Fixes by:
                        <ul>
                            <li><a href="https://www.youtube.com/@glitchglidertwo">GlitchGlider</a></li>
                        </ul>
                        <div class="d-flex">
                            <button class="sf-loaders btn btn-primary" id="dls-loader" onclick="clickEl('dls-selector')" style="width:100%">Load Soundfont (DLS)</button>
                        </div>
                        <div id="sf-correction" hidden>
                            <div id="soundfont-controls">
                                <br />
                                <h5>Select output format</h5>
                                <div class="d-flex">
                                    <div class="dls-radio-container">
                                        <button class="sf-loaders dls-radio btn btn-primary" onclick="clickEl('sf-convert-dls'); handleButtonRadios(this, 'dls-radio')">DLS</button>
                                    </div>
                                    <div class="dls-radio-container">
                                        <button class="sf-loaders dls-radio btn btn-secondary" onclick="clickEl('sf-convert-sf2'); handleButtonRadios(this, 'dls-radio')">SF2</button>
                                    </div>
                                </div>
                                <input type="radio" id="sf-convert-dls" name="sf-convert" value="dls" class="dls-radio-internal hide" checked />
                                <input type="radio" id="sf-convert-sf2" name="sf-convert" value="sf2" class="dls-radio-internal hide"/>
                                <br />
                                <h5>Download Fixed Soundfont</h5>
                                <div class="d-flex">
                                    <button class="sf-loaders btn btn-success" id="sf-downloader" onclick="downloadSoundfont()" style="width:100%">Download</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Rebalance Modal -->
        <div class="modal fade" id="rebalanceModal" tabindex="-1" aria-labelledby="rebalanceModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="rebalanceModalLabel">Rebalance MIDI Volume</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>
                            Adjusts all volume events by a factor, to ease rebalancing the audio from a MIDI file.
                            <br /><br />
                            <strong>NOTE: </strong>MIDI file volume events cannot exceed a volume of 127. Exceeding this (denoted by "Max Ratio without compromising balance") will mean that your balance between track volumes may be disturbed.
                        </p>
                        <div class="d-flex">
                            <button class="btn btn-primary" onclick="clickEl('rebalancing-midi-selector')" style="width:100%">Load MIDI</button>
                        </div>
                        <div id="midi-rebalance-controls" hidden>
                            <p>
                                <div>
                                    <strong>Loaded MIDI: </strong><span id="rebalancing-file-name"></span> 
                                </div>
                                <div id="rebalancing-boost-container">
                                    <strong>Max Ratio without compromising balance: </strong><span id="rebalancing-boost"></span>
                                </div>
                            </p>
                            <div class="d-flex">
                                <div>
                                    0%
                                </div>
                                <div style="flex:9" class="range-wrap">
                                    <input type="range" class="form-range" id="rebalancing_ratio" min="0" max="200" style="width:100%"/>
                                    <output class="bubble" id="rebalancing_bubble">100%</output>
                                </div>
                                <div>
                                    200%
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-success" style="width:100%" onclick="rebalanceMidiWrapper()">
                                    Apply Rebalance
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Porting Modal -->
        <div class="modal fade" id="portingModal" tabindex="-1" aria-labelledby="portingModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="portingModalLabel">MIDI Porting</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>
                            Converts a MIDI File from one game into the Donkey Kong 64 soundfont. Currently only supports the N64 Banjo titles due to 
                            their similarities to DK64 music-wise enabling music to sound very similar between games. However, this tool does have the
                            functionality to expand to any midi format from any game or general MIDI in general.
                        </p>
                        <div class="p-3 text-center">
                            <button class="btn btn-primary" onclick="clickEl('porting-midi-selector')">
                                Load MIDI
                            </button>
                        </div>
                        <div id="midi-port-controls" hidden>
                            <p>
                                <strong>Loaded MIDI: </strong><span id="porting-file-name"></span> 
                            </p>
                            <label for="template_select"><strong>Select Template:</strong></label>
                            <select id="template_select" class="form-select"></select>
                            <div class="p-3 text-center">
                                <button class="btn btn-success" onclick="instrumentChange()">
                                    Write new MIDI
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="d-flex req-midi hide" style="width: 90%; margin-left: auto; margin-right: auto" hidden>
            <div class="card m-3" style="flex:1">
                <div id="stats" class="p-3">
                    <h3>Midi Statistics</h3>
                    <div id="stat-name"></div>
                    <div id="stat-duration"></div>
                    <div id="stat-durationticks"></div>
                    <div id="stat-durationmeasures"></div>
                    <div id="stat-ppq"></div>
                    <div id="stat-size"></div>
                </div>
            </div>
            <div style="flex: 1" class="m-3">
                <div id="player" class="card p-3 mb-3" hidden>
                    <div class="d-flex">
                        <h3 style="flex:9">Play Song</h3>
                        <div class="text-end">
                            <div>
                                <label for="volume_strobing">Disable volume bar recolors</label>
                                <input type="checkbox" id="volume_strobing"/>
                            </div>
                            <div>
                                <label for="volume_chart">Display Volume Chart</label>
                                <input type="checkbox" id="volume_chart" onclick="handleChartDisplay(this)"/>
                            </div>
                        </div>
                    </div>
                    <div style="font-style:italic;text-align:left">
                        <strong>NOTE:</strong> This won't sound *exactly* like how it will in game. This is just a rough approximation
                    </div>
                    <div>
                        <div class="mb-2">
                            Volume <span id="max_volume_demo" class="badge text-bg-success">Max: 0</span> <span id="avg_volume_demo" class="badge text-bg-success">Avg: 0</span>
                        </div>
                        <div id="volume_demo">&nbsp;</div>
                    </div>
                    <div id="volumeChartContainer" hidden>
                        <canvas id="volumeChart"></canvas>
                    </div>

                    <div class="d-flex">
                        <span id="play-button" onclick="playMusic()"><i class="fa-solid fa-play"></i></span>
                        <input
                            type="range" 
                            min="0" 
                            max="100" 
                            id="player-navigator" 
                            ontouchstart="navigatorClick(true)" onmousedown="navigatorClick(true)"
                            ontouchend="navigatorClick(false)" onmouseup="navigatorClick(false)"
                            ontouchmove="navigatorMove(false)" onmousemove="navigatorMove(false)"
                            />
                        <span id="player-position-display"></span>
                    </div>
                </div>
                <div class="card loop-height p-3" id="loop-controls">
                    <h3>Loop Controls</h3>
                    <div class="d-flex">
                        <div class="sep" style="text-align:left">
                            <label>Loop:</label>
                            <input id="loop-check" type="checkbox" onclick="toggleLoop()" />
                        </div>
                        <div id="loop-point-info" class="sep hide" style="flex:2">
                            <label for="loop-point">Loop Point (Ticks)</label>
                            <input type="number" id="loop-point" value="0" onkeyup="setPreloadState(false)"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="req-midi" style="width:90%; margin-left:auto; margin-right: auto" hidden>
            <div class="d-flex">
                <div class="sep">
                    <div class="p-3">
                        <button onclick="convertToBinaryButton()" class="song-action-button btn btn-success">Convert to binary</button>
                    </div>
                </div>
                <div class="sep">
                    <div class="req-no-preload p-3">
                        <button onclick="clickEl('rom-selector'); preloadROMWrite();" class="song-action-button btn btn-primary">Preload ROM Write</button>
                    </div>
                    <div class="req-preload d-flex hide" hidden>
                        <div class="p-3">
                            <button onclick="writeToROM()" class="song-action-button btn btn-success">Write to ROM</button>
                        </div>
                        <div class="px-3">
                            <label for="song_list"><strong>Select Song:</strong></label>
                            <select class="form-select" id="song_list"></select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="script/sfplayer.js"></script>
        <script>
            function clickEl(id) {
                document.getElementById(id).click();
            }
            tabs = document.getElementsByClassName("tab")
            for (let t = 0; t < tabs.length; t++) {
                tabs[t].addEventListener("click", function(e) {
                    targ = e.target
                    for (let u = 0; u < tabs.length; u++) {
                        tabs[u].classList.remove("selected")
                        assoc = tabs[u].getAttribute("association")
                        console.log(assoc)
                        document.getElementById(assoc).classList.add("hide")
                        document.getElementById(`exp-${assoc}`).classList.add("hide")
                        edit_type = tabs[u].getAttribute("editing")
                        edits = document.getElementsByClassName(`req-edit-${edit_type}`)
                        for (let c = 0; c < edits.length; c++) {
                            edits[c].classList.add("hide")
                        }
                    }
                    targ.classList.add("selected")
                    elm = targ.getAttribute("association")
                    document.getElementById(elm).classList.remove("hide")
                    document.getElementById(`exp-${elm}`).classList.remove("hide")
                    edit_type = targ.getAttribute("editing")
                    edits = document.getElementsByClassName(`req-edit-${edit_type}`)
                    for (let c = 0; c < edits.length; c++) {
                        edits[c].classList.remove("hide")
                    }
                })
            }

            function loadPortingMidi() {
                document.getElementById("midi-port-controls").removeAttribute("hidden");
            }

            function handleButtonRadios(evt, cls) {
                radios = document.getElementsByClassName(cls);
                for (let i = 0; i < radios.length; i++) {
                    radios[i].classList.remove("btn-primary");
                    radios[i].classList.add("btn-secondary");
                }
                evt.classList.remove("btn-secondary")
                evt.classList.add("btn-primary");
            }

            let dls_base = null;
            let dls_base_res = null;
            document.getElementById("dls-selector").addEventListener("change", function() {
                var fr = new FileReader();
                fr.onload = function() {
                    console.log("Loading DLS")
                    var data = fr.result;
                    dls_base_res = data;
                    dls_base = new MarcFile(new Uint8Array(data));
                    document.getElementById("sf-correction").removeAttribute("hidden");
                };
                fr.readAsArrayBuffer(document.getElementById("dls-selector").files[0]);
            })
            
            // Download file
        var downloadBlob, downloadURL;
        downloadBlob = function(data, fileName, mimeType) {
            var blob, url;
            blob = new Blob([data], {
                type: mimeType
            });
            url = window.URL.createObjectURL(blob);
            downloadURL(url, fileName);
            setTimeout(function() {
                return window.URL.revokeObjectURL(url);
            }, 1000);
        };

        downloadURL = function(data, fileName) {
            var a;
            a = document.createElement('a');
            a.href = data;
            a.download = fileName;
            document.body.appendChild(a);
            a.style = 'display: none';
            a.click();
            a.remove();
        };

        function buildSoundfont(dls, bps, extension) {
            wwApply=new Worker("./script/worker_apply.js");
            console.log("Genned Worker")
            wwApply.postMessage(
				{
					romFileU8Array:dls._u8array,
					patchFileU8Array:bps._u8array,
					validateChecksums:false
				},[
					dls._u8array.buffer,
					bps._u8array.buffer
				]
			);
            console.log("Posted Message")
            wwApply.onmessage = event => { // listen for events from the worker
                console.log("Message received")
                console.log(event.data)
                var newFile=new MarcFile(event.data.patchedRomU8Array);
                downloadBlob(newFile._u8array,`dk64-soundfont-fixed.${extension}`,"application/octet-stream")
            };
        }

            async function downloadSoundfont() {
                let output_format = null;
                const radios = document.getElementsByClassName("dls-radio-internal");
                for (let r = 0; r < radios.length; r++) {
                    if (radios[r].checked) {
                        output_format = radios[r].value;
                    }
                }
                const BPS_HEAD = "v6";
                if (output_format != null) {
                    fetch(`./data/soundfont_correctors/${BPS_HEAD}-${output_format}.bps`)
                    .then(res => res.blob())
                    .then(data => data.arrayBuffer())
                    .then(ab => {
                        console.log(ab)
                        u8 = new Uint8Array(ab);
                        patch = new MarcFile(u8);
                        console.log(patch)
                        //setPatch(patch);
                        //setBase(dls_base);
                        //applyPatch(new MarcFile(dls_base_res), new MarcFile(u8), false)
                        buildSoundfont(dls_base, new MarcFile(u8), output_format);
                        document.getElementById("sf-downloader").setAttribute("disabled","disabled")
                    })
                }
            }

            function last(arr) {
                return arr[arr.length - 1]
            }

            function goTo(url) {
                window.open(url, "_blank");
            }

            function updateStatStyle() {
                stats = ["stat-name","stat-duration","stat-durationticks","stat-durationmeasures","stat-ppq"]
                stats.forEach(stat => {
                    txt = document.getElementById(stat).innerText
                    head = txt.split(":")[0]
                    info = txt.split(":").filter((item, index) => {
                        return index != 0
                    }).join(":")
                    document.getElementById(stat).innerHTML = `<strong>${head}</strong>: ${info}`
                })
            }

            const VANILLA_BIN_LIMIT = 16512
            const RANDO_BIN_LIMIT = 24576

            function convertToBinaryButton() {
                toBinary(true, current_midi_file, "file-selector");
            }

            function updateBinarySize() {
                toBinary(false, current_midi_file, "file-selector")
                const data = new Uint8Array(output_bin_file.slice());
                document.getElementById("stat-size").innerHTML = `<strong>Binary Size</strong>: ${data.length} ${
                    data.length > VANILLA_BIN_LIMIT ?
                    `<span title='${
                        data.length > RANDO_BIN_LIMIT ? "File is too big for DK64 Randomizer" : "File is too big for vanilla DK64, but not randomizer"
                    }' class='${
                        data.length > RANDO_BIN_LIMIT ? "major-warning" : "minor-warning"
                    }'>&nbsp;&#9888;</span>` :
                    ""
                } <span class="reload noselect" id="recalculate-binary" title="Recalculate" onclick="updateBinarySize()">&#x21bb;</span>`
                updateStatStyle()
            }

            

            function updateStats(midi_json) {
                second_floor_grade = 100
                minutes = Math.floor(midi_json.duration / 60)
                seconds = Math.floor((midi_json.duration - (60 * minutes)) * second_floor_grade) / second_floor_grade
                s_str = seconds.toString()
                if (seconds < 10) {
                    s_str = "0" + s_str
                }
                measures = (midi_json.durationTicks / midi_json.header.ppq) / 4
                measures = Math.floor(measures * second_floor_grade) / second_floor_grade
                name = last(document.getElementById("file-selector").value.split("\\"))
                document.getElementById("stat-name").innerText = `MIDI Name: ${name}`;
                document.getElementById("stat-duration").innerText = `Duration: ${minutes}:${s_str}`
                document.getElementById("stat-durationticks").innerText = `Duration (Ticks): ${midi_json.durationTicks}`
                document.getElementById("stat-durationmeasures").innerText = `Duration (Measures): ${measures}`
                document.getElementById("stat-ppq").innerText = `Pulses per Quarter-Note: ${midi_json.header.ppq}`
                updateBinarySize()

                updateStatStyle()
            }

            function u8arrayToBuffer(array) {
                return array.buffer.slice(array.byteOffset, array.byteLength + array.byteOffset)
            }

            let current_midi_file = []
            let current_porting_midi_file = [];
            let current_rebalancing_midi_file = [];
            let compressed_midi = []
            let output_bin_file = []
            let rom_file = []
            let ticks_per_quarter = 0
            let currentMidi = null;
            let midiBuffer = null;
            let sfBuffer = null;
            document.getElementById("file-selector").addEventListener("change", function(e) {
                var fr = new FileReader();
                fr.onload = function() {
                    var data = fr.result;
                    setup_data = fr.result;
                    var array = new Uint8Array(data);
                    //window.clampMidi(fr.result)
                    current_midi_file = array.slice()
                    let midi_reqs = document.getElementsByClassName("req-midi")
                    for (let m = 0; m < midi_reqs.length; m++) {
                        midi_reqs[m].removeAttribute("hidden")
                        midi_reqs[m].classList.remove("hide")
                    }
                    console.log(current_midi_file)
                    // Midi Stat stuff
                    const midi = new Midi(data);
                    document.getElementById("player-navigator").setAttribute("min", 0)
                    document.getElementById("player-navigator").value = 0
                    document.getElementById("player-navigator").setAttribute("max", midi.durationTicks)
                    document.getElementById("player-navigator").setAttribute("t_s", midi.duration)
                    updateStats(midi)
                    //console.log(midi)
                    midiURL = URL.createObjectURL(e.target.files[0])
                    midiBuffer = u8arrayToBuffer(array)
                    setPreloadState(false);
                    document.getElementById("loop-check").checked = false;
                    if (synth) {
                        synth.stopPlayer();
                    }
                };
                fr.readAsArrayBuffer(document.getElementById("file-selector").files[0]);
            })
            document.getElementById("porting-midi-selector").addEventListener("change", function(e) {
                var fr = new FileReader();
                fr.onload = function() {
                    var data = fr.result;
                    var array = new Uint8Array(data);
                    loadPortingMidi();
                    //window.clampMidi(fr.result)
                    current_porting_midi_file = array.slice()
                    console.log(current_porting_midi_file)
                    const raw_file_name = document.getElementById("porting-midi-selector").value;
                    const raw_file_split = raw_file_name.split("\\")
                    document.getElementById("porting-file-name").innerText = raw_file_split[raw_file_split.length - 1];
                };
                fr.readAsArrayBuffer(document.getElementById("porting-midi-selector").files[0]);
            })
            document.getElementById("rebalancing-midi-selector").addEventListener("change", function(e) {
                var fr = new FileReader();
                fr.onload = function() {
                    var data = fr.result;
                    var array = new Uint8Array(data);
                    //window.clampMidi(fr.result)
                    current_rebalancing_midi_file = array.slice()
                    console.log(current_rebalancing_midi_file)
                    toBinary(false, current_rebalancing_midi_file, "rebalancing-midi-selector");
                    const max_boost = getMaximumVolumeBoost(current_rebalancing_midi_file.slice());
                    const max_boost_hook = document.getElementById("rebalancing-boost");
                    document.getElementById("rebalancing-boost-container").removeAttribute("hidden");
                    max_boost_hook.innerText = "";
                    if (max_boost != null) {
                        max_boost_hook.innerText = `${parseInt(100 * max_boost)}%`;
                    } else {
                        document.getElementById("rebalancing-boost-container").setAttribute("hidden", "hidden");
                    }
                    const raw_file_name = document.getElementById("rebalancing-midi-selector").value;
                    const raw_file_split = raw_file_name.split("\\")
                    document.getElementById("rebalancing-file-name").innerText = raw_file_split[raw_file_split.length - 1];
                    document.getElementById("midi-rebalance-controls").removeAttribute("hidden");
                };
                fr.readAsArrayBuffer(document.getElementById("rebalancing-midi-selector").files[0]);
            })
            document.getElementById("soundfont-selector").addEventListener("change", function(e) {
                var fr = new FileReader();
                fr.onload = function() {
                    var data = fr.result;
                    var array = new Uint8Array(data);
                    sfURL = URL.createObjectURL(e.target.files[0])
                    sfBuffer = u8arrayToBuffer(array)
                    document.getElementById("player").removeAttribute("hidden")           
                    //document.getElementById("player-sep").removeAttribute("hidden")    
                    document.getElementById("soundfont-controls").removeAttribute("hidden")
                    console.log("Removing")
                    document.getElementById("loop-controls").classList.remove("loop-height")    
                    if (synth) {
                        synth.stopPlayer();
                    }
                };
                fr.readAsArrayBuffer(document.getElementById("soundfont-selector").files[0]);
            })
            document.getElementById("dls-selector").addEventListener("change", function(e) {
                var fr = new FileReader();
                fr.onload = function() {
                    var data = fr.result;
                    var array = new Uint8Array(data);
                    document.getElementById("soundfont-controls").removeAttribute("hidden")
                };
                fr.readAsArrayBuffer(document.getElementById("dls-selector").files[0]);
            })
            document.getElementById("rom-selector").addEventListener("change", function(e) {
                var fr = new FileReader();
                fr.onload = function() {
                    var data = fr.result;
                    rom_file = new Uint8Array(data);
                    const song_data = finishPreload(rom_file);
                    const any_song_loaded = loadSongList(compressed_midi.length, song_data["song_data"])
                    setPreloadState(any_song_loaded);
                    if (!any_song_loaded) {
                        throw new Error(`Song too big for ROM. (${compressed_midi.length} bytes)`)
                    }
                };
                fr.readAsArrayBuffer(document.getElementById("rom-selector").files[0]);
            })
            function setBubble(range, bubble) {
                const val = range.value;
                const min = range.min ? range.min : 0;
                const max = range.max ? range.max : 100;
                const newVal = Number(((val - min) * 100) / (max - min));
                bubble.innerHTML = `${val}%`;
              
                // Sorta magic numbers based on size of the native UI thumb
                bubble.style.left = `calc(${newVal}% + (${8 - newVal * 0.15}px))`;
            }
            document.getElementById("rebalancing_ratio").addEventListener("input", (e) => {
                setBubble(document.getElementById("rebalancing_ratio"), document.getElementById("rebalancing_bubble"))
            }) 

            let GLOBAL_NO_REPEATERS_SETTING = true;

            function toBinary(write_binary, file_bytes, element) {
                console.log(element)
                input_file_name = document.getElementById(element).value
                loop_data = getLoopStatus()
                loop = loop_data["loop"]
                loop_point = loop_data["point"]
                no_repeaters = GLOBAL_NO_REPEATERS_SETTING
                output_segments = input_file_name.split(".")[0].split("\\")
                output_file = output_segments[output_segments.length - 1] + ".bin"

                console.log("Does Loop:",loop)
                console.log("Loop Point:",loop_point)
                console.log("Disable Repeaters:",no_repeaters)
                console.log("Output File:",output_file)
                output_bin_file = MidiToGEFormat(file_bytes, [], loop, loop_point, no_repeaters, true)
                data_len = output_bin_file.length
                cap = 0x10
                if ((data_len % cap) != 0) {
                    for (let x = 0; x < (cap - (data_len % cap)); x++) {
                        output_bin_file.push(0)
                    } 
                }
                console.log(output_bin_file)
                if (write_binary) {
                    writeToFile(output_bin_file, output_file)
                }
            }

            function toggleLoop() {
                const hook = document.getElementById("loop-point-info")
                if (document.getElementById("loop-check").checked) {
                    hook.classList.remove("hide")
                } else {
                    hook.classList.add("hide")
                }
                setPreloadState(false);
            }

            function setPreloadState(show) {
                const preloaders = document.getElementsByClassName("req-preload")
                const anti_preloaders = document.getElementsByClassName("req-no-preload")
                for (let p = 0; p < preloaders.length; p++) {
                    if (show) {
                        preloaders[p].removeAttribute("hidden")
                        preloaders[p].classList.remove("hide")
                    } else {
                        preloaders[p].setAttribute("hidden", "hidden")
                        preloaders[p].classList.add("hide")
                    }
                }
                for (let p = 0; p < anti_preloaders.length; p++) {
                    if (show) {
                        anti_preloaders[p].classList.add("hide")
                    } else {
                        anti_preloaders[p].classList.remove("hide")
                    }
                }
                if (!show) {
                    document.getElementById("rom-selector").value = null;
                }
            }
            
            function preloadROMWrite() {
                toBinary(false, current_midi_file, "file-selector")
                const data = new Uint8Array(output_bin_file.slice());
                compressed_midi = Array.from(pako.gzip(data, {"level": 9}));
            }

            function writeToROM() {
                let slot = document.getElementById("song_list").value;
                console.log(slot);
                if (slot != null) {
                    const new_rom = writeToROMInternal(rom_file.slice(), slot, compressed_midi.slice());
                    writeToFile(new_rom, "song-altered-dk64.z64");
                }
            }

            const SONG_ITEMS = [
                "Silence",
                "Jungle Japes (Starting Area)",
                "Cranky's Lab",
                "Jungle Japes (Minecart)",
                "Jungle Japes (Army Dillo)",
                "Jungle Japes (Caves/Underground)",
                "Funky's Hut",
                "Unused Coin Pickup",
                "Bonus Minigames",
                "Triangle Trample",
                "Guitar Gazump",
                "Bongo Blast",
                "Trombone Tremor",
                "Saxaphone Slam",
                "Angry Aztec",
                "Transformation",
                "Mini Monkey",
                "Hunky Chunky",
                "GB/Key Get",
                "Angry Aztec (Beetle Slide)",
                "Oh Banana",
                "Angry Aztec (Temple)",
                "Company Coin Get",
                "Banana Coin Get",
                "Going through Vulture Ring",
                "Angry Aztec (Dogadon)",
                "Angry Aztec (5DT)",
                "Frantic Factory (Car Race)",
                "Frantic Factory",
                "Snide's HQ",
                "Jungle Japes (Tunnels)",
                "Candy's Music Shop",
                "Minecart Coin Get",
                "Melon Slice Get",
                "Pause Menu",
                "Crystal Coconut Get",
                "Rambi",
                "Angry Aztec (Tunnels)",
                "Water Droplets",
                "Frantic Factory (Mad Jack)",
                "Success",
                "Start (To pause game)",
                "Failure",
                "DK Transition (Opening)",
                "DK Transition (Closing)",
                "Unused High-Pitched Japes",
                "Fairy Tick",
                "Melon Slice Drop",
                "Angry Aztec (Chunky Klaptraps)",
                "Frantic Factory (Crusher Room)",
                "Jungle Japes (Baboon Blast)",
                "Frantic Factory (R&D)",
                "Frantic Factory (Production Room)",
                "Troff 'n' Scoff",
                "Boss Defeat",
                "Angry Aztec (Baboon Blast)",
                "Gloomy Galleon (Outside)",
                "Boss Unlock",
                "Awaiting Entering the Boss",
                "Generic Twinkly Sounds",
                "Gloomy Galleon (Pufftoss)",
                "Gloomy Galleon (Seal Race)",
                "Gloomy Galleon (Tunnels)",
                "Gloomy Galleon (Lighthouse)",
                "Battle Arena",
                "Drop Coins (Minecart)",
                "Fairy Nearby",
                "Checkpoint",
                "Fungi Forest (Day)",
                "Blueprint Get",
                "Fungi Forest (Night)",
                "Strong Kong",
                "Rocketbarrel Boost",
                "Orangstand Sprint",
                "Fungi Forest (Minecart)",
                "DK Rap",
                "Blueprint Drop",
                "Gloomy Galleon (2DS)",
                "Gloomy Galleon (5DS/Submarine)",
                "Gloomy Galleon (Pearls Chest)",
                "Gloomy Galleon (Mermaid Palace)",
                "Fungi Forest (Dogadon)",
                "Mad Maze Maul",
                "Crystal Caves",
                "Crystal Caves (Giant Kosha Tantrum)",
                "Nintendo Logo (Old?)",
                "Success (Races)",
                "Failure (Races & Try Again)",
                "Bonus Barrel Introduction",
                "Stealthy Snoop",
                "Minecart Mayhem",
                "Gloomy Galleon (Mechanical Fish)",
                "Gloomy Galleon (Baboon Blast)",
                "Fungi Forest (Anthill)",
                "Fungi Forest (Barn)",
                "Fungi Forest (Mill)",
                "Generic Seaside Sounds",
                "Fungi Forest (Spider)",
                "Fungi Forest (Mushroom Top Rooms)",
                "Fungi Forest (Giant Mushroom)",
                "Boss Introduction",
                "Tag Barrel (All of them)",
                "Crystal Caves (Beetle Race)",
                "Crystal Caves (Igloos)",
                "Mini Boss",
                "Creepy Castle",
                "Creepy Castle (Minecart)",
                "Baboon Balloon",
                "Gorilla Gone",
                "DK Isles",
                "DK Isles (K Rool's Ship)",
                "DK Isles (Banana Fairy Island)",
                "DK Isles (K-Lumsy's Prison)",
                "Hideout Helm (Blast-O-Matic On)",
                "Move Get",
                "Gun Get",
                "Hideout Helm (Blast-O-Matic Off)",
                "Hideout Helm (Bonus Barrels)",
                "Crystal Caves (Cabins)",
                "Crystal Caves (Rotating Room)",
                "Crystal Caves (Tile Flipping)",
                "Creepy Castle (Tunnels)",
                "Intro Story Medley",
                "Training Grounds",
                "Enguarde",
                "K-Lumsy Celebration",
                "Creepy Castle (Crypt)",
                "Headphones Get",
                "Pearl Get",
                "Creepy Castle (Dungeon w/ Chains)",
                "Angry Aztec (Lobby)",
                "Jungle Japes (Lobby)",
                "Frantic Factory (Lobby)",
                "Gloomy Galleon (Lobby)",
                "Main Menu",
                "Creepy Castle (Inner Crypts)",
                "Creepy Castle (Ballroom)",
                "Creepy Castle (Greenhouse)",
                "K Rool's Theme",
                "Fungi Forest (Winch)",
                "Creepy Castle (Wind Tower)",
                "Creepy Castle (Tree)",
                "Creepy Castle (Museum)",
                "BBlast Final Star",
                "Drop Rainbow Coin",
                "Rainbow Coin Get",
                "Normal Star",
                "Bean Get",
                "Crystal Caves (Army Dillo)",
                "Creepy Castle (Kut Out)",
                "Creepy Castle (Dungeon w/out Chains)",
                "Banana Medal Get",
                "K Rool's Battle",
                "Fungi Forest (Lobby)",
                "Crystal Caves (Lobby)",
                "Creepy Castle (Lobby)",
                "Hideout Helm (Lobby)",
                "Creepy Castle (Trash Can)",
                "End Sequence",
                "K-Lumsy Ending",
                "Jungle Japes",
                "Jungle Japes (Cranky's Area)",
                "K Rool Takeoff",
                "Crystal Caves (Baboon Blast)",
                "Fungi Forest (Baboon Blast)",
                "Creepy Castle (Baboon Blast)",
                "DK Isles (Snide's Room)",
                "K Rool's Entrance",
                "Monkey Smash",
                "Fungi Forest (Rabbit Race)",
                "Game Over",
                "Wrinkly Kong",
                "100th CB Get",
                "K Rool's Defeat",
                "Nintendo Logo",
            ]

            function loadSongList(max_size, sizes=null) {
                const hook = document.getElementById("song_list");
                html = "";
                let permit_total = false;
                let song_to_index_mapping = {};
                SONG_ITEMS.forEach((song, index) => {
                    song_to_index_mapping[song] = index;
                })
                song_names = SONG_ITEMS.slice();
                song_names.sort();
                song_names.forEach(song => {
                    index = song_to_index_mapping[song];
                    permit = max_size == -1;
                    if (max_size >= 0) {
                        if (sizes != null) {
                            permit = sizes[index] >= max_size;
                        }
                    }
                    if (permit) {
                        permit_total = true;
                        html += `<option type=\"radio\" name=\"Select Song\" value=\"${index}\"${index == 1 ? ' selected' : ''}>${song}</option>`
                    }
                })
                hook.innerHTML = html;
                return permit_total;
            }
            loadSongList(-1);

            function instrumentChange() {
                toBinary(false, current_porting_midi_file, "porting-midi-selector");
                readMidiPorting(current_porting_midi_file.slice());
            }

            function rebalanceMidi(ratio) {
                toBinary(false, current_rebalancing_midi_file, "rebalancing-midi-selector");
                adjustMIDIVolume(current_rebalancing_midi_file.slice(), ratio)
            }

            function rebalanceMidiWrapper() {
                const rebalance_ratio_hook = document.getElementById("rebalancing_ratio");
                const ratio = rebalance_ratio_hook.value / 100;
                rebalanceMidi(ratio);
            }

            const TEMPLATE_DATA = [
                {"file": "bk", "name": "Banjo-Kazooie"},
                {"file": "bt", "name": "Banjo-Tooie"},
            ]

            function loadTemplates() {
                const hook = document.getElementById("template_select");
                html = TEMPLATE_DATA.map(template => `<option type=\"radio\" name=\"Select Song\" value=\"${template['file']}.json\">${template['name']}</option>`).join("");
                hook.innerHTML = html;
            }
            loadTemplates();
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    </body>
</html>