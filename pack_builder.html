<html data-bs-theme="dark" lang="en">
    <head>
        <title>DK64 Randomizer Cosmetic Pack Builder</title>
		<link rel="stylesheet" href="style/main.css">
        <link rel="stylesheet" href="style/home.css">
        <link rel="stylesheet" href="style/midi-converter.css">
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
		<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
		<link rel="manifest" href="/site.webmanifest">
		<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
		<meta name="msapplication-TileColor" content="#da532c">
		<meta name="theme-color" content="#ffffff">
		<meta name="description" content="" />
        <!-- Discord -->
        <meta content="DK64 Pack Builder" property="og:title" />
        <meta content="Music Pack creator for Donkey Kong 64, serving as hub for video game songs which have been transposed to the DK64 soundfont." property="og:description" />
        <meta content="DK64 Utils" property="og:site_name" />
        <meta content="https://raw.githubusercontent.com/theballaam96/theballaam96.github.io/master/assets/head.png" property="og:image" />
        <!-- Scripts and Styles -->
        <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
        <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
        <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>

        <style>
            #song_list .game-header {
                background-color: rgba(0,0,0,0.8);
                border: 2px solid white;
                border-radius: 5px;
                padding: 5px;
                cursor: pointer;
                transition: 0.1s ease-in-out;
                margin: 5px;
            }
            #song_list[render=grid][gridtext=hide] .game-icon {
                margin-top: 15px;
            }
            #song_list .game-header:hover {
                background-color: rgba(255, 255, 255, 0.2);
            }
            #song_list .game-header .game-icon {
                display: none;
            }
            #song_list[render=grid] .game-header .game-icon {
                text-align: center;
                padding: 5px;
                display: flex;
                align-items: center;
                height: 64px;
            }
            #song_list[render=grid] .game-header .game-internal-name {
                text-align: center;
                overflow: hidden;
                font-size: 1vw;
                padding: 5px;
                height: calc(15vh - 64px - 10px - 10px);
                transition: 0.1s ease-in-out;
                opacity: 100%;
            }
            #song_list[render=grid][gridtext=hide] .game-header .game-internal-name {
                display: none;
                opacity: 0;
            }
            .game-songs {
                background-color: rgba(0,0,0,0.2);
                padding-bottom: 10px;
                padding-left: 10px;
                border-bottom: 1px solid white;
            }
            .panel-sep {
                display: flex;
            }
            .panel-sep-anti {
                display: block;
            }
            #song_list {
                grid-template-columns: 50% 50%;
            }
            #song_list[render=grid] {
                grid-template-columns: 16% 16% 16% 16% 16% 16%;
            }
            .popup_background, .popup_background-fade {
                background-color: rgba(0,0,0,0.5);
                position:fixed;
                top:0;
                left:0;
                width:100%;
                height:100%;
            }
            .popup_background-fade {
                background-color: rgba(0, 0, 0, 1);
                opacity: 100;
                transition: 0.1s ease-in-out;
            }
            .popup_prompt {
                background-color: #15172b;
                border-radius: 20px;
                box-sizing: border-box;
                max-height: 70%;
                padding: 20px;
                width: 50%;
                position: relative;
                margin-left: auto;
                margin-right: auto;
                top: 50%;
                transform: translateY(-50%);
                /*text-align: center;*/
                color: white;
                overflow-y: auto;
            }
            .popup_head {
                color: #eee;
                font-family: sans-serif;
                font-size: 36px;
                font-weight: 600;
                margin-top: 30px;
            }
            .popup_subtitle {
                color: #eee;
                font-family: sans-serif;
                font-size: 16px;
                font-weight: 600;
                margin-top: 10px;
            }
            .midi-checkbox-container {
                margin: 5px;
                position: relative;
            }
            .midi-checkbox {
                border: 1px solid white;
                border-radius: 5px;
                cursor: pointer;
                padding: 5px;
                transition: 0.1s ease-in-out;
                /*width: 100%;*/
                min-height: 100%;
                position: relative;
            }
            .midi-checkbox:hover {
                background-color: rgb(61, 255, 145, 0.15);
            }
            .midi-checkbox[ticked="true"] {
                background-color: rgba(61, 255, 145, 0.3);
            }
            .midi-checkbox .name_data {
                flex: 1;
                font-weight: bold;
            }
            .popup_buttons {
                flex: 1;
                margin: 5px;
            }
            .popup_controls {
                margin-bottom: 20px;
            }
            .name_meta_data {
                padding-left: 5px;
                flex: 2;
            }
            #song_selected_count {
                transition: 0.1s ease-in-out;
                width: fit-content;
            }
            .errored {
                background-color: #b00000;
            }
            #button-panel {
                margin-top: 10px;
            }
            @media only screen and (max-width: 1500px) {
                .popup_prompt {
                    width: 70%;
                }
            }
            @media only screen and (max-width: 1200px) {
                #song_list {
                    grid-template-columns: 100%;
                }
                #song_list[render=grid] {
                    grid-template-columns: 33% 33% 33%;
                }
                #song_list[render=grid] .game-header .game-internal-name {
                    font-size: 2vw;
                }
            }
            button {
                width: calc(100% - 10px);
                margin: 5px;
            }
            @media only screen and (max-width: 1000px) {
                .popup_prompt {
                    width: 90%;
                }
                .panel-sep {
                    display: block;
                }
                .panel-sep-anti {
                    display: flex;
                }
                .sep-left {
                    border-right: none;
                }
            }
            /*input[type=text], #advf-container select {
                background-color: #303245;
                border-radius: 5px;
                border: 0;
                box-sizing: border-box;
                color: #eee;
                font-size: 18px;
                outline: 0;
                padding: 7px 20px;
                width: -webkit-fill-available;
                width: -moz-fill-available;
                margin: 5px;
            }*/
            #search-game {
                height: 100%;
            }
            #song_selected_count {
                padding: 5px;
                margin-left: auto;
                margin-right: auto;
            }
            .audio_positioner_container {
                width: 100%;
                position: relative;
            }
            .audio_positioner {
                top:0;
                right: 0;
                position: absolute;
                height: 20px;
            }
            .audio-close-container {
                text-align: right;
            }
            .audio_positioner_internal {
                padding: 2px;
                margin-top: 2px;
                margin-right: 5px;;
                transition: 0.1s ease-in-out;
            }
            /*.audio_positioner_internal:hover {
                color: rgba(13, 202, 240, 0.7);
            }*/
            .audio-close {
                width: fit-content;
                margin-left: auto;
                padding: 5px;
                transition: 0.1s ease-in-out;
                border-radius: 5px;
            }
            .audio-close:hover {
                background-color: rgba(255, 255, 255, 0.4);
            }
            .fixed-body {
                overflow-y: clip;
            }
            .load_bar {
                height: 10px;
            }
            #loading_left{
                background-color: #7c80a3;
            }
            #loading_right{
                background-color: #20254f;
            }
            .game-image {
                max-width: 100%;
                max-height: 64px;
                margin-left: auto;
                margin-right: auto;
                /*vertical-align: middle;*/
            }
            .game-image-replacement {
                height: 64px;
                font-size: 1vw;
                overflow: hidden;
            }
            #song_list[gridtext=hide] .game-image.no-icon {
                display: none;
            }
            #song_list[gridtext=show] .game-image-replacement {
                display: none;
            }
            .game-fullness-panel {
                height: 10px;
                padding: 2.5px;
            }
            .panel-all, .panel-some {
                width: 10px;
                height: 10px;
                margin-left: auto;
                border-radius: 10px;
            }
            .panel-all {
                background-color: green;
            }
            .panel-some {
                background-color: white;
            }
            /*
            #advf-container {
                margin-top: 20px;
            }
            #advf-container input, #advf-container select {
                margin-bottom: 10px;
            }
            */
            .slider-range {
                border-radius: 50px;
                height: 8px;
                margin-top: 10px;
                margin-bottom: calc(40px);
                width: 90%;
                margin-left: auto;
                margin-right: auto;
            }
            .slider-range .ui-slider-range {
                background-color: dodgerblue;
            }
            .slider-range .ui-slider-handle {
                border-radius: 100px;
                background-color: dodgerblue;
                top: calc(-0.3em - 1px);
            }
            .slider-range .ui-slider-timecode {
                position: absolute;
                color: white;
                font-weight: bold;
                top: 20px;
            }
            .advf-hint {
                font-size: 75%;
                font-style: italic;
                padding-bottom: 5px;
            }
            #tag-list {
                flex-wrap: wrap;
            }
            .advf-tag-container {
                flex: 1;
                min-width: 33%;
                max-width: 33%;
            }
            .bs-checkbox-right {
                border: 2px solid white;
                border-top-right-radius: 5px;
                border-bottom-right-radius: 5px;
                padding: 5px;
            }
            /*
            .icon-alignment {
                display: inline-block;
                height: 100%;
                vertical-align: middle;
            }
            */
            body {
                background-image: none;
                background-color: rgba(30, 30, 30, 1);
            }
            html[data-bs-theme="dark"].main_panel {
                color: white;
            }
            .header_main, .header_sub {
                text-align: center;
                font-weight: 600;
            }
            .header_main {
                font-size: 2rem;
            }
            .header_sub {
                font-size: 1.75rem;
            }
            #load-event {
                transition: 1.0s ease-in-out;
                background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url("assets/bckgrnd.png");
            }
            .midi-tag {
                padding: 0px 2px;
            }
            .handle-overflow {
                text-overflow: ellipsis;
                -o-text-overflow: ellipsis;
                -ms-text-overflow: ellipsis;
                white-space: nowrap;
                overflow: hidden;
            }
            .content-center {
                width: 75%;
                margin-left: auto;
                margin-right: auto;
            }
            .midi-grid {
                display: grid;
                grid-template-columns: 33% 33% 33%;
            }
            @media only screen and (max-width: 750px) {
                .midi-grid {
                    grid-template-columns: 50% 50%;
                }
            }
            @media only screen and (max-width: 500px) {
                .midi-grid {
                    grid-template-columns: 100% 100%;
                }
                .content-center {
                    width: 95%;
                }
            }
            .breadcrumb-container {
                padding: 10px;
                display: flex;
            }
            #popup_master_controls {
                margin-left: auto;
                flex: 1;
            }
            #song_selected_count {
                text-align: right;
            }
            .has-transition {
                transition: 0.1s ease-in-out;
            }
            #audio-event-content {
                text-align: center;
            }
            .fix-bottom {
                position: fixed;
                bottom: 0;
                background: rgba(30, 30, 30, 1);
                margin-top: 10px;
                left: 12.5%;
            }
            .bottom-line {
                padding-bottom: 2px;
                border-bottom: 1px solid gray;
            }
            .midi-tray {
                padding: 5px 0px;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
            }
        </style>
    </head>
    <body>
        <nav class="navbar sticky-top navbar-expand-lg bg-body-tertiary">
            <div class="container-fluid">
                <a class="navbar-brand excluded_link" href="#" onclick="hidePopup()">
                    Pack Builder
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" style="width:fit-content;width:-moz-fit-content">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle excluded_link" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                File
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item excluded_link" href="#" onclick="buildCandyPack()" id="build-pack-button"><i class="fa-solid fa-download"></i> Download Candy Pack (Categorized)</a></li>
                                <li><a class="dropdown-item excluded_link" href="#" onclick="buildBinaryPack()"><i class="fa-solid fa-download"></i> Download Binary Pack</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item excluded_link" href="#" onclick="uploadPack()"><i class="fa-solid fa-upload"></i> Upload Pack</a></li>
                            </ul>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link excluded_link" href="#" onclick="selectAllSongs()"><i id="select-all-songs-fa" class="fa-solid fa-square-check"></i> <span id="select-all-songs">Select all Songs</span></a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link excluded_link" href="#" data-bs-toggle="modal" data-bs-target="#accessibilityModal"><i class="fa-solid fa-universal-access"></i> Accessibility</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle excluded_link" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                Misc
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item excluded_link" href="#" data-bs-toggle="modal" data-bs-target="#changelogModal"><i class="fa-solid fa-clipboard"></i> Song Changelog</a></li>
                                <li><a class="dropdown-item excluded_link" href="#" onclick="submitSong()"><i class="fa-solid fa-music"></i> Submit Song</a></li>
                                <li><a class="dropdown-item excluded_link" href="#" onclick="getShareLink(true, false, false, 0, false)"><i class="fa-solid fa-link"></i> Get Shareable Link</a></li>
                                <li><a class="dropdown-item excluded_link" href="#" onclick="getYTPlaylist()"><i class="fa-brands fa-youtube"></i> Get YouTube Playlist</a></li>
                            </ul>
                        </li>
                    </ul>
                    <div class="d-flex">
                        <input class="form-control me-2" type="text" placeholder="Search Game or Song..." aria-label="Search Game or Song..." id="search-game" onkeyup="filterGame()">
                        <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#filterModal" style="width:fit-content"><i class="fa-solid fa-gear"></i></button>
                    </div>
                </div>
            </div>
        </nav>
        <input type="file" class="hide" accept=".zip" id="uploaded_pack" />
        <div class="main_panel">
            <!-- Song Changelog Modal -->
            <div class="modal fade" id="changelogModal" tabindex="-1" aria-labelledby="changelogModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="changelogModalLabel">Song Changelog</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="popup_recent"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Play Song Modal -->
            <div class="modal modal-lg fade" data-bs-backdrop="static" data-bs-keyboard="false" id="playSongModal" tabindex="-1" aria-labelledby="playSongModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h1 class="modal-title fs-5" id="playSongModalLabel">Playing Song</h1>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeSong()" id="playSongModalClose"></button>
                    </div>
                    <div class="modal-body">
                        <div id="audio-event-content">
                            <audio controls>
                                <source src="" type="audio/mpeg">
                            </audio>
                        </div>
                    </div>
                  </div>
                </div>
            </div>
            <!-- Accessibility Modal -->
            <div class="modal fade" id="accessibilityModal" tabindex="-1" aria-labelledby="accessibilityModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="accessibilityModalLabel">Accessibility Options</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            All options will be cached:
                            <form style="text-align: center" class="mt-3">
                                <div class="input-group">
                                    <div>
                                        <input type="checkbox" data-toggle="toggle" class="form-check-input" id="min-view" />
                                        Minimal View
                                    </div>
                                </div>
                                <div class="input-group" id="text-view-container">
                                    <div>
                                        <input type="checkbox" data-toggle="toggle" class="form-check-input" id="text-view" />
                                        Grid Text Shown
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
              </div>
            <!-- Advanced Filters Modal -->
            <div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="filterModalLabel">Advanced Filters</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="advf-container">
                                <div class="mb-3">
                                    <label for="advf-game" class="form-label">Game Name</label>
                                    <input type="text" class="form-control" id="advf-game" placeholder="Game Name..." />
                                </div>
                                
                                <div class="mb-3">
                                    <label for="advf-song" class="form-label">Song Name</label>
                                    <input type="text" id="advf-song" class="form-control" placeholder="Song Name..." />
                                </div>
            
                                <div class="mb-3">
                                    <label for="advf-group" class="form-label">Group</label>
                                    <select id="advf-group" class="form-select">
                                        <option selected>Any</option>
                                        <option value="bgm">Background Music</option>
                                        <option value="events">Events</option>
                                        <option value="majoritems">Major Items</option>
                                        <option value="minoritems">Minor Items</option>
                                    </select>
                                </div>
            
                                <div class="mb-3">
                                    <label for="advf-bgm-length" class="form-label">BGM Length</label>
                                    <div class="slider-range" id="advf-bgm-length"></div>
                                </div>
            
                                <div class="mb-3">
                                    <label for="advf-noloop-length" class="form-label">Non-Looping Lengths</label>
                                    <div class="slider-range" id="advf-noloop-length"></div>
                                </div>
            
                                <div class="mb-3">
                                    <label for="advf-composer" class="form-label">Composers</label>
                                    <input type="text" id="advf-composer" class="form-control" placeholder="Composer Name..." aria-describedby="composerHelpBlock"/>
                                    <div id="composerHelpBock" class="form-text">
                                        Split names with comma (Eg. Koji Kondo, Grant Kirkhope)
                                    </div>
                                </div>
            
                                <div class="mb-3">
                                    <label for="advf-converter" class="form-label">Converters</label>
                                    <input type="text" id="advf-converter" class="form-control" placeholder="Converter Name..."  aria-describedby="converterHelpBlock"/>
                                    <div id="converterHelpBock" class="form-text">
                                        Split names with comma (Eg. Ballaam, Adeleine64DS)
                                    </div>
                                </div>
            
                                <div class="mb-3">
                                    <label class="form-label">Tags</label>
                                    <div class="advf-hint">Select all that you are happy with</div>
                                    <div id="tag-list" class="flexsplitter"></div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-success" data-bs-dismiss="modal" onclick="compileAdvancedFilters()">Apply</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Toasts -->
            <div id="toasts">
                <div class="toast-container position-fixed bottom-0 end-0 p-3"></div>
            </div>
            <!-- Breadcrumb -->
            <div class="breadcrumb-container">
                <nav aria-label="breadcrumb" style="flex:1">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item active" id="home-breadcrumb" aria-current="page" onclick="hidePopup()">Home</li>
                        <li class="breadcrumb-item hide" id="sub-breadcrumb">Library</li>
                    </ol>
                </nav>
                <div id="song_selected_count" class="has-transition">0/0 songs selected</div>
                <div class="flexsplitter has-transition" id="popup_master_controls" style="opacity:0" hidden>
                    <button type="button" class="btn btn-outline-info" id="game-select-toggle" onclick="selectMaster()">Select All</button>
                    <button type="button" class="btn btn-outline-success" onclick="destroyPopup()">Apply changes</button>
                    <button type="button" class="btn btn-outline-danger" id="addSongClose" onclick="hidePopup()">Close</button>
                </div>
            </div>
            <div class="content-center">
                <div id="song_list" class="has-transition" style="display:grid; opacity: 1" render="grid" defaultrender="grid" gridtext="hide"></div>
                <div id="popup_global_container" class="has-transition" hidden style="opacity:0">
                    <h1 id="popup_game_name">Add Songs to List</h1>
                    <div>
                        Hide Credits:
                        <input type="checkbox" id="credits_hidden"/>
                    </div>
                    <div id="popup_controls" style="padding-bottom: 100px"></div>
                </div>
            </div>
        </div>
        <div class="flexsplitter fix-bottom has-transition content-center" id="sticky-controls" hidden>
            <button type="button" class="btn btn-outline-info" id="game-select-toggle-bottom" onclick="selectMaster()">Select All</button>
            <button type="button" class="btn btn-outline-success" onclick="destroyPopup()">Apply changes</button>
            <button type="button" class="btn btn-outline-danger" onclick="hidePopup()">Close</button>
        </div>
        <div class="popup_background hide" id="audio-event" style="z-index:2000">
            <div class="popup_prompt" style="width:fit-content">
                <div class="audio-close-container">
                    <button type="button" class="btn-close btn-close-white" aria-label="Close" onclick="closeSong()"></button>
                </div>
                
            </div>
        </div>
        <div class="popup_background" id="load-event" style="opacity:1; z-index: 5000">
            <div class="popup_prompt">
                <div class="popup_head">Loading Site Data</div>
                <div class="progress" style="color:black" role="progressbar" id="loading_bar" aria-label="Loading Progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar bg-success" style="width: 0%; color: black">0%</div>
                  </div>
                <div id="loading_text"></div>
            </div>
        </div>
        <div id="lazy-loader"><img id=lazy-img-loader height="1px" width="1px"/></div>
        <script>      
            const ZELDA_NAME = "The Legend of Zelda: "
            let midi_data_copy = null;
            let total_data_copy = null;
            let current_game = null;
            let uploaded_pack_data = {};
            const BASE_NO_ICON_IMG = "https://d1nhio0ox7pgb.cloudfront.net/_img/g_collection_png/standard/512x512/question.png"
            const MISC_NAME = "Other"
            
            const char_upper_alpha_idx = Array.from(Array(26)).map((e, i) => i + 65);
            const char_lower_alpha_idx = Array.from(Array(26)).map((e, i) => i + 97);
            const char_upper_alpha = char_upper_alpha_idx.map((x) => String.fromCharCode(x));
            const char_lower_alpha = char_lower_alpha_idx.map((x) => String.fromCharCode(x));
            const char_num = Array.from(Array(10).keys()).map(x => x.toString())
            const char_alphanumeric = char_upper_alpha + char_lower_alpha + char_num;

            let output_as_encoded = false;
            const ACCEPTED_TAGS = [
                "Fights",
                "Lobbies and Shops",
                "Interiors",
                "Exteriors",
                "Minigames",
                "Happy",
                "Gloomy",
                "Calm",
                "Spawning",
                "Collection",
            ]
            const QUERY_STRING_IDENTIFIER = "is_qs=true"       

            function populateTagSuggestions() {
                const hook = document.getElementById("tag-list")
                hook.innerHTML = ACCEPTED_TAGS.map(item => `
                    <div class='advf-tag-container'>
                        <input type='checkbox' class='advf-tag form-check-input' value='' id='advf-tag-${filterName(item)}' data-toggle='toggle' checked/>
                        <label for='advf-tag-${filterName(item)}' class=form-check-label>${item}</label>
                    </div>
                `).join("")
            }
            populateTagSuggestions();

            const tc_sliders = document.getElementsByClassName("slider-range")
            const tc_default = [[0, 300], [0, 60]]
            const tc_els = ["advf-bgm-length", "advf-noloop-length"]
            tc_els.forEach((el, index) => {
                $( `#${el}` ).slider({
                    range: true,
                    min: tc_default[index][0],
                    max: tc_default[index][1],
                    values: tc_default[index],
                    slide: function( event, ui ) {
                        $( `#${el}` ).attr("value-min", ui.values[0])
                        $( `#${el}` ).attr("value-max", ui.values[1])
                        const handles = event.target.getElementsByClassName("ui-slider-handle")
                        for (let i = 0; i < 2; i++) {
                            const tc_min = parseInt(ui.values[i] / 60);
                            const tc_sec = parseInt(ui.values[i] - (tc_min * 60));
                            handles[i].innerHTML = `<span class='ui-slider-timecode'>${tc_min}:${tc_sec < 10 ? `0${tc_sec}` : tc_sec}</span>`
                        }
                    }
                });
                const hook = document.getElementById(el)
                document.getElementById(el).setAttribute("value-min", tc_default[index][0].toString())
                document.getElementById(el).setAttribute("value-max", tc_default[index][1].toString())
                const tc_handles = hook.getElementsByClassName("ui-slider-handle")
                for (let i = 0; i < 2; i++) {
                    const tc_min = parseInt(tc_default[index][i] / 60);
                    const tc_sec = parseInt(tc_default[index][i] - (tc_min * 60));
                    tc_handles[i].innerHTML = `<span class='ui-slider-timecode'>${tc_min}:${tc_sec < 10 ? `0${tc_sec}` : tc_sec}</span>`
                }
            })

            function filterAdvancedFilterValue(value) {
                if (value == "") {
                    return null
                }
                return value.replaceAll("&","").replace("=","")
            }

            function compileAdvancedFilters() {
                let filtering_information = {
                    "game": filterAdvancedFilterValue(document.getElementById("advf-game").value),
                    "song": filterAdvancedFilterValue(document.getElementById("advf-song").value),
                    "group": filterAdvancedFilterValue(document.getElementById("advf-group").value),
                    "bgm-min": parseInt(document.getElementById("advf-bgm-length").getAttribute("value-min")),
                    "bgm-max": parseInt(document.getElementById("advf-bgm-length").getAttribute("value-max")),
                    "noloop-min": parseInt(document.getElementById("advf-noloop-length").getAttribute("value-min")),
                    "noloop-max": parseInt(document.getElementById("advf-noloop-length").getAttribute("value-max")),
                    "composers": filterAdvancedFilterValue(document.getElementById("advf-composer").value),
                    "converters": filterAdvancedFilterValue(document.getElementById("advf-converter").value),
                }
                let all_tagged = true;
                ACCEPTED_TAGS.forEach(tag => {
                    if (!document.getElementById(`advf-tag-${filterName(tag)}`).checked) {
                        all_tagged = false;
                    }
                })
                if (!all_tagged) {
                    ACCEPTED_TAGS.forEach(tag => {
                        filtering_information[`tag-${filterName(tag)}`] = document.getElementById(`advf-tag-${filterName(tag)}`).checked
                    })
                }
                let filtering_array = [QUERY_STRING_IDENTIFIER]
                Object.keys(filtering_information).forEach(key => {
                    if (filtering_information[key] != null) {
                        filtering_array.push(`${key}=${filtering_information[key]}`)
                    }
                })
                document.getElementById("search-game").value = filtering_array.join("&");
                filterGame();
            }

            function last(array) {
                return array[array.length - 1];
            }

            function uuidv4() {
                return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                  (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
                );
              }

            function getCellValue(reference, index) {
                if (reference.c[index] == null) {
                    return null
                }
                let val = reference.c[index].v;
                if (val.substring(0, 1) == "|") {
                    val = val.substring(1);
                }
                if ((val == null) || (val == undefined)) {
                    return null;
                }
                if (val.trim() == "") {
                    return null;
                }
                return val.trim()
            }

            class MIDIHeader {
                constructor (name, mandatory, excluded_values=[null], push_item=true) {
                    this.name = name
                    this.mandatory = mandatory
                    this.excluded_values = excluded_values
                    this.push_item = push_item
                }
            }

            class OldMIDIInfo {
                constructor (drive_id, audio, converter, timestamp) {
                    this.converter = converter;
                    this.drive_id = drive_id;
                    this.audio = audio;
                    this.timestamp = timestamp;
                }
            }

            let recent_history = {}
            const timeframe_names = ["This week", "Last Week", "2 weeks ago", "3 weeks ago", "Last Month", "Older"]
            const timeframe_limit = [7, 14, 21, 28, 60, 999999]

            function getTimeframeName(time_ago) {
                if (time_ago != null) {
                    let time_name = last(timeframe_names);
                    timeframe_limit.forEach((lim, index) => {
                        if ((time_name == last(timeframe_names)) && (time_ago < lim)) {
                            time_name = timeframe_names[index]
                        }
                    })
                    return time_name
                }
                return last(timeframe_names);
            }

            function pushToRecent(game, song, time_ago) {
                if (time_ago != null) {
                    const time_name = getTimeframeName(time_ago)
                    if (!Object.keys(recent_history).includes(time_name)) {
                        recent_history[time_name] = []
                    }
                    is_update = midi_data_copy.filter(item => (item.name == song) && (item.game == game)).length > 0
                    recent_history[time_name].push({
                        "game": game,
                        "song": song,
                        "is_update": is_update,
                        "days_ago": time_ago
                    })
                    return recent_history[time_name].length - 1;
                }
                return null;
            }

            function updateChangelogEntry(entry_index, time_ago, new_data) {
                if ((time_ago != null) && (entry_index != null)) {
                    const time_name = getTimeframeName(time_ago);
                    if (Object.keys(recent_history).includes(time_name)) {
                        Object.keys(new_data).forEach(key => {
                            recent_history[time_name][entry_index][key] = new_data[key]
                        })
                    }
                }
            }
            
            function toggleShowName(el) {
                if (el.innerText == "Show") {
                    el.innerText = "Hide";
                } else {
                    el.innerText = "Show";
                }
            }

            function updateRecent() {
                Object.keys(recent_history).forEach(key => {
                    recent_history[key].sort()
                    recent_history[key].reverse()
                })
                document.getElementById("popup_recent").innerHTML = `
                    ${timeframe_names.map(frame => `${!Object.keys(recent_history).includes(frame) ? "" : `
                        <div class="flexsplitter">
                            <div class="popup_subtitle" style="flex:1">${frame}</div>
                            <div style="flex:1; text-align:right">
                                <button style="width:fit-content; width:-moz-fit-content" class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle='collapse' href='#collapse-${frame.replaceAll(" ","")}' role="button" aria-expanded="false" aria-controls="collapse-${frame.replaceAll(" ","")}" onclick="toggleShowName(this)">
                                    Show
                                </button>
                            </div>
                        </div>
                        <div class="collapse multi-collapse" id="collapse-${frame.replaceAll(" ","")}">
                            <ul>${recent_history[frame].map(song => `
                                <li>${song.is_update ? "[UPDATE] " : ""}
                                ${song.game}: ${song.song}</li>
                            `).join("")}</ul>
                        </div>
                    `}`).join("")}
                `
            }

            const DELISTED_TAG = "Delisted"
            const GITHUB_AUDIO = "github.com/theballaam96/candys-shop/raw/main/previews"

            class MIDIInfo {
                constructor (name, game, group, composer, converter, drive_id, timestamp, audio, midi_length, track_count, tags, notes, index) {
                    this.name = name;
                    this.game = game;
                    this.group = group;
                    this.composer = composer;
                    this.converter = converter;
                    this.drive_id = drive_id;
                    this.timestamp = timestamp;
                    this.audio = audio;
                    this.index = index;
                    this.midi_length = midi_length ? parseFloat(midi_length) : null;
                    this.track_count = track_count
                    this.tags = []
                    this.delisted = false
                    if (tags != null) {
                        this.tags = tags;
                        if (typeof tags == "string") {
                            this.tags = tags.split(",").map(item => item.trim());
                        }
                        this.delisted = this.tags.includes(DELISTED_TAG)
                        this.tags = this.tags.filter(item => item != DELISTED_TAG);
                    }
                    this.notes = notes
                    this.days_since_submission = null;
                    this.is_new = false;
                    this.older_revisions = null;
                    if (timestamp != null) {
                        const current_dt = new Date();
                        const timestamp_dt = new Date(timestamp);
                        const diff_dt = current_dt - timestamp_dt;
                        this.days_since_submission = Math.floor(diff_dt / (1000 * 60 * 60 * 24));
                        this.is_new = this.days_since_submission < 7;
                    }
                    if (!this.delisted) {
                        this.changelog_entry = pushToRecent(this.game, this.name, this.days_since_submission)
                    }
                }

                update_entry(replacement) {
                    if (this.older_revisions == null) {
                        this.older_revisions = [];
                    }
                    this.older_revisions.push(new OldMIDIInfo(
                        this.drive_id,
                        this.audio,
                        this.converter,
                        this.timestamp,
                    ))
                    let converter_list = this.converter.split(",").map(item => item.trim());
                    replacement.converter.split(",").map(item => item.trim()).forEach(item => {
                        if (!converter_list.includes(item)) {
                            converter_list.push(item);
                        }
                    })
                    this.converter = converter_list.join(", ");
                    this.drive_id = replacement.drive_id;
                    this.audio = replacement.audio ? replacement.audio : this.audio;
                    this.midi_length = replacement.midi_length ? replacement.midi_length : this.midi_length;
                    this.track_count = replacement.track_count ? replacement.track_count : this.track_count;
                    if ((replacement.tags != null) && (replacement.tags.length > 0)) {
                        this.tags = replacement.tags.slice();
                    }
                    this.notes = replacement.notes ? replacement.notes : this.notes;
                    this.timestamp = replacement.timestamp;
                    this.days_since_submission = replacement.days_since_submission;
                    this.is_new = replacement.is_new;
                }
            }
            
            let pack_zip_data = null;

            function clone(instance) {
                return Object.assign(
                    Object.create(
                        // Set the prototype of the new object to the prototype of the instance.
                        // Used to allow new object behave like class instance.
                        Object.getPrototypeOf(instance),
                    ),
                    // Prevent shallow copies of nested structures like arrays, etc
                    JSON.parse(JSON.stringify(instance)),
                );
              }

            let icon_json = {}
            
            function getCookie(cname) {
                let name = cname + "=";
                let decodedCookie = decodeURIComponent(document.cookie);
                let ca = decodedCookie.split(';');
                for(let i = 0; i <ca.length; i++) {
                  let c = ca[i];
                  while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                  }
                  if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                  }
                }
                return "";
              }

            function setPackCookie(cname, cvalue, exdays=60) {
                const d = new Date();
                d.setTime(d.getTime() + (exdays*24*60*60*1000));
                let expires = "expires="+ d.toUTCString();
                document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
            }

            async function getSpreadsheetData() {
                const spreadsheetId = "13WWHcGiYJQD_rUqfGL17Lp0zn7MveU5xf7Fy-CNghzo"
                const sheetId = "0"
                const tab_name = "Song Uploads"
                const iconId = "1845127615"
                // Get generic data
                const res = await fetch('https://raw.githubusercontent.com/theballaam96/candys-shop/main/mapping.json')
                const text = await res.text()
                json = JSON.parse(text)
                // Get icon data
                const icon_res = await fetch('https://raw.githubusercontent.com/theballaam96/candys-shop/main/images.json')
                const icon_text = await icon_res.text()
                icon_json = JSON.parse(icon_text)

                let counter = 0;
                midi_data_copy = [];
                total_data_copy = [];
                let used_game_song_combos = [];
                json.forEach(json_item => {
                    const headers = [
                        // Has to remain in this order
                        new MIDIHeader("Song", true), // Name
                        new MIDIHeader("Game", true), // Game
                        new MIDIHeader("Category", true), // Category
                        new MIDIHeader("Composers", false), // Composer
                        new MIDIHeader("Converters", false), // Converter
                        new MIDIHeader("Binary", true), // Binary
                        new MIDIHeader("Date", false), // Timestamp
                        new MIDIHeader("Audio", false), // Audio
                        new MIDIHeader("Duration", false), // Duration
                        new MIDIHeader("Tracks", false), // Track Count
                        new MIDIHeader("Tags", false), // Tags
                        new MIDIHeader("Additional Notes", false), // Notes
                        new MIDIHeader("Verified", true, [null, false], false), // Song is Verified
                    ]
                    let permit = true;
                    const arr_length = headers.filter(i => i.push_item).length;
                    let params = new Array(arr_length).fill(null);
                    let index = 0;
                    headers.forEach(header => {
                        if (header.push_item) {
                            params[index] = Object.keys(json_item).includes(header.name) ? json_item[header.name] : null;
                            index += 1;
                        }
                        if (!Object.keys(json_item).includes(header.name)) {
                            if (header.mandatory) {
                                permit = false;
                            }
                        } else if (header.excluded_values.includes(json_item[header.name])) {
                            permit = false;
                        }
                    })
                    if (permit) {
                        const new_data = new MIDIInfo(...params, counter)
                        if (!new_data.delisted) {
                            const game_song_combo = `${new_data.game}|${new_data.name}`
                            total_data_copy.push(clone(new_data))
                            if (!used_game_song_combos.includes(game_song_combo)) {
                                // Completely new song
                                midi_data_copy.push(new_data)
                                used_game_song_combos.push(game_song_combo)
                            } else {
                                // Used song, update existing entry
                                const existing_entry = midi_data_copy.find(item => ((item.game == new_data.game) && (item.name == new_data.name)));
                                if (existing_entry) {
                                    existing_entry.update_entry(new_data)
                                }
                            }
                        }
                        counter++
                    }
                })
                updateRecent()
            }

            function ReLoadImages(){
                document.getElementById("lazy-loader").remove()
            }

            function lazyLoadImages() {
                document.getElementById("lazy-loader").innerHTML = Object.keys(icon_json).map(key => `
                    <img src='${icon_json[key]}' height="1px" width="1px" async loading=lazy />
                `).join("")
            }

            function filterName(name) {
                return name.split("").filter(item => char_alphanumeric.includes(item)).join("").toLowerCase();
            }

            function filterNote(note) {
                bad_note_characters = ["'","\""]
                bad_note_characters.forEach(char => {
                    note = note.replaceAll(char, "")
                })
                return note
            }

            const site_is_down = false;
            const total_prog = 6;
            async function getMidiData() {
                let prog = 0;
                updateProgress(prog++, total_prog, "Initializing");
                await getSpreadsheetData()
                if (getCookie("min-view") != "minimal") {
                    lazyLoadImages();
                }
                updateProgress(prog++, total_prog, "Grabbed midi data");
                const spreadsheetId = "13WWHcGiYJQD_rUqfGL17Lp0zn7MveU5xf7Fy-CNghzo"
                const pack_sheet_id = "1943464809"
				const pack_res = await fetch(`https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&tq&gid=${pack_sheet_id}`, {cache: "no-store"})
				const pack_res_text = await pack_res.text()
                const pack_json = JSON.parse(pack_res_text.substr(47).slice(0, -2))
                const zip_id = pack_json.table.rows[0].c[0].v;
                let ban = false;
                if (zip_id == null) {
                    ban = true;
                } else if (zip_id.trim().length == 0) {
                    ban = true;
                }
                if (ban) {
                    throw new Error("No pack.zip ID loaded. This is likely due to a song upload occurring.")
                    return;
                }
                const zip_url = "https://raw.githubusercontent.com/theballaam96/candys-shop/main/binaries.zip"
                const zip_res = await fetch(zip_url, {
                    cache: "no-store"
                });
                pack_zip_data = await zip_res.blob();
                updateProgress(prog++, total_prog, "Grabbing Pack.zip");

                updateProgress(prog++, total_prog, "Adjusting Pack.zip");
                const hook = document.getElementById("song_list")
                let html = ""
                let songs_by_game = {}
                let other = []
                midi_data_copy.sort(function(a, b) {
                    // Sort songs alphabetically
                    var textA = a.name.toUpperCase();
                    var textB = b.name.toUpperCase();
                    return (textA < textB) ? -1 : (textA > textB) ? 1 : 0;
                });
                midi_data_copy.forEach(song => {
                    const game_name = song.game;
                    if (game_name == MISC_NAME) {
                        other.push(song)
                    } else {
                        if (!Object.keys(songs_by_game).includes(game_name)) {
                            songs_by_game[game_name] = []
                        }
                        songs_by_game[game_name].push(song)
                    }
                })
                songs_by_game = Object.keys(songs_by_game).sort().reduce(
                    (obj, key) => { 
                        obj[key] = songs_by_game[key]; 
                        return obj;
                    }, {}
                );
                songs_by_game[MISC_NAME] = other.slice();
                
                Object.keys(songs_by_game).forEach(game_pretty => {
                    let game = filterName(game_pretty);
                    if (game != null) {
                        const song_list = songs_by_game[game_pretty].sort()
                        // <input type='checkbox' class='midi-checkbox' id='' onclick='updateMaster(\"${game}\")' game='${game}'/>
                        let local_html = {};
                        song_list.forEach(song => {
                            const group = song.group;
                            let displayed_song_name = song.name;
                            let composer = song.composer ? song.composer : "";
                            let converter = song.converter ? song.converter : "";
                            let audio = song.audio;
                            if (!Object.keys(local_html).includes(group)) {
                                local_html[group] = "";
                            }
                            const state_index = song.index;
                            local_html[group] += 
                                `
                                <div class='midi-checkbox-container'>
                                    <div 
                                        class='midi-checkbox noselect' 
                                        song-id='${song.index}' 
                                        onclick='updateTickbox(this,\"${game}\")' 
                                        ticked=${parseSeed(state_index) ? 'true' : 'false'} 
                                        group='${group}'
                                        game='${game}'
                                        ${song.notes ? `title='${song.notes}'` : ''}>
                                        <div class='flexsplitter bottom-line'>
                                            <div class='name_data handle-overflow' title='${filterNote(displayed_song_name.replace('.bin',''))}'>${displayed_song_name.replace('.bin','')}</div>
                                        </div>
                                        <div class='bottom-line name_meta_data${isCreditHidden() ? ' hide' : ''}'>
                                            ${composer != '' ? `<div title='Composer${composer.includes(',') ? 's' : ''} of original song: ${composer}' class="handle-overflow">&#119070; ${composer}</div>` : ''}
                                            ${converter != '' ? `<div title='Converter${converter.includes(',') ? 's' : ''} into DK64 Soundfont: ${converter}' class="handle-overflow"><i class="fa-solid fa-rotate"></i> ${converter}</div>` : ''}
                                        </div>
                                        <div class='midi-tray'>
                                            ${
                                                `<span class='midi-tag credit-guitar${isCreditHidden() ? '' : ' hide'}' title='Composer${composer.includes(',') ? 's' : ''} of original song: ${composer}\nConverter${converter.includes(',') ? 's' : ''} into DK64 Soundfont: ${converter}'
                                                    data-bs-toggle='tooltip'>
                                                    <i class='fa-solid fa-guitar'></i>
                                                </span>`
                                            }
                                            ${
                                                song.notes ?
                                                song.notes.trim().length > 0 ?
                                                `<span class='midi-tag' title='${filterNote(song.notes)}'><i class='fa-solid fa-note-sticky'></i></span>`
                                                : ""
                                                : ""
                                            }
                                            ${
                                                song.tags.length > 0 ?
                                                `<span class='midi-tag' title='${song.tags.join(', ')}'>
                                                    <i class='fa-solid fa-tags'></i>
                                                </span>`
                                                : ""
                                            }
                                            ${
                                                song.tags.map((item, index) => index < 10 ? `
                                                    <span class='badge text-bg-light rounded-pill'>
                                                        ${item}
                                                    </span>
                                                ` : "").join("")
                                            }
                                        </div>
                                    </div>
                                    <div class='audio_positioner'>
                                        <div class='audio_positioner_internal'>
                                            ${
                                                audio ?
                                                `<span class='midi-tag audio-clicker' title='Listen to song' onclick='playSong(\"${audio}\",\"${converter}\",\"${filterNote(displayed_song_name.replace('.bin',''))}\", ${song.index})' data-bs-toggle="modal" data-bs-target="#playSongModal" conversion_id="${song.index}"><i class='fa-solid fa-play'></i></span>`
                                                : ""
                                            }
                                        </div>
                                    </div>
                                </div>`
                        })
                        let local_html_total = "";
                        const group_priority = {
                            "bgm": "Background Music",
                            "events": "Events",
                            "majoritems": "Major Items",
                            "minoritems": "Minor Items"
                        }
                        let first = true;
                        Object.keys(group_priority).forEach(group => {
                            if (Object.keys(local_html).includes(group)) {
                                local_html_total += `${first ? '' : '<br>'}
                                    <div class='fs-5'>${group_priority[group]}</div>
                                    <div class='midi-grid'>
                                        ${local_html[group]}
                                    </div>
                                `
                                first = false;
                            }
                        })
                        const game_name = game_pretty;
                        html += `<div class='game-handler' title='${filterNote(game_name)}'>
                            <div class='game-header noselect collapsed' onclick='toggleGameVisibility(\"${game}\",this)'>
                                <div class='game-icon'>
                                    <span class='icon-alignment'></span>
                                    <img class='game-image ${
                                        Object.keys(icon_json).includes(game_name) ? 
                                        "" : "no-icon"
                                    }' src='${
                                        Object.keys(icon_json).includes(game_name) ?
                                        icon_json[game_name] :
                                        BASE_NO_ICON_IMG
                                    }' loading=lazy />
                                    ${Object.keys(icon_json).includes(game_name) ?
                                        "" :
                                        `<div class='game-image-replacement'>${game_name}</div>`
                                    }
                                </div>
                                <div class='game-internal-name'>${game_name}</div>
                                <div class='game-fullness-panel'></div>
                            </div>
                            <div class='game-songs hide' game='${game}'>
                                ${local_html_total}
                            </div>
                        </div>`
                        //hook.innerHTML = html // Start loading
                    }
                })
                hook.innerHTML = html;
                updateProgress(prog++, total_prog, "Lazy Loading Images");
                ReLoadImages();
                updateProgress(prog++, total_prog, "Populated Site");
                updateMaster();
                updateProgress(prog++, total_prog, "Updated Master");
                // Update click events
                setMinView(getCookie("min-view") == "minimal", false, true);
                setTextView(getCookie("text-view") == "show", false)
                document.getElementById("credits_hidden").checked = getCookie("credits") == "true";
                document.getElementById("credits_hidden").addEventListener("click", () => {handleCredits(true)});
                document.getElementById("min-view").addEventListener("click", () => {handleMinView(true, true)});
                document.getElementById("text-view").addEventListener("click", () => {handleTextView(true)});

                if (willAutoDownload()) {
                    document.getElementById("build-pack-button").click();
                }
                autoPlaySong();
            }
            
            if ((!site_is_down) || (window.location.origin.includes("localhost"))) {
                getMidiData();
            } else {
                updateProgress(1, 1, "Site is down for Maintainence. Please check back later", true)
            }

            function convertSongName(game, song) {
                return `${game}|${song.replaceAll(" ", "_").replaceAll(".bin","")}`
            }

            const group_internal_to_name = {
                "bgm": "Background Music",
                "events": "Events",
                "majoritems": "Major Items",
                "minoritems": "Minor Items",
            }

            function updateFullnessIndicators() {
                const game_boxes = document.getElementsByClassName("game-handler");
                for (let g = 0; g < game_boxes.length; g++) {
                    const song_boxes = game_boxes[g].getElementsByClassName("midi-checkbox")
                    let filled_counts = {}
                    let total_counts = {}
                    let has_song = false;
                    let has_all_songs = true;
                    for (let s = 0; s < song_boxes.length; s++) {
                        const group = song_boxes[s].getAttribute("group")
                        if (!Object.keys(filled_counts).includes(group)) {
                            filled_counts[group] = 0
                        }
                        if (!Object.keys(total_counts).includes(group)) {
                            total_counts[group] = 0
                        }
                        const ticked = song_boxes[s].getAttribute("ticked") == "true";
                        total_counts[group] += 1;
                        if (ticked) {
                            has_song = true;
                            filled_counts[group] += 1;
                        } else {
                            has_all_songs = false;
                        }
                    }
                    const hint_text = Object.keys(filled_counts).map(key => `${group_internal_to_name[key]}: ${filled_counts[key]}/${total_counts[key]}`).join("\n")
                    game_boxes[g].getElementsByClassName("game-fullness-panel")[0].innerHTML = `
                        ${has_song ? `<div class="${has_all_songs ? "panel-all" : "panel-some"}" title="${hint_text}"></div>` : ""}
                    `;

                }
            }

            function idToSongInfo(id) {
                if (midi_data_copy != null) {
                    let song = null;
                    let folder = null;
                    let download = null;
                    let song_index = null;
                    let drive_id = null;
                    let game = null;
                    let preview = null;
                    let tags = [];
                    const entry = midi_data_copy.find(item => item.index == id);
                    if (entry) {
                        song = entry.name;
                        folder = entry.group;
                        download = entry.drive_id;
                        song_index = id;
                        drive_id = entry.drive_id
                        game = entry.game;
                        preview = entry.audio,
                        tags = entry.tags
                    }
                    if (song != null) {
                        return {
                            "song": song,
                            "game": game,
                            "folder": folder,
                            "download": download,
                            "index": song_index,
                            "drive_id": drive_id,
                            "preview": preview,
                            "tags": tags.slice()
                        }
                    }
                }
                return null;
            }

            const TRANSITION_SPEED = 150
            const TRANSITION_BUFFER = 1

            function scrollTo(value = 0) {
                document.body.scrollTop = value; // For Safari
                document.documentElement.scrollTop = value; // For Chrome, Firefox, IE and Opera
            }

            let stored_scroll = 0;

            function changeGlobalSongListState(shown=true) {
                const global_song_list = document.getElementById("song_list");
                const was_shown = !global_song_list.hasAttribute("hidden");
                const game_song_list = document.getElementById("popup_global_container");
                const game_song_buttons = document.getElementById("popup_master_controls");
                const sticky_controls = document.getElementById("sticky-controls");
                const ss_count_el = document.getElementById("song_selected_count");
                const main_breadcrumb = document.getElementById("home-breadcrumb");
                const sub_breadcrumb = document.getElementById("sub-breadcrumb");
                if (shown == was_shown) {
                    return;
                }
                if (shown) {
                    game_song_list.style.opacity = 0;
                    game_song_buttons.style.opacity = 0;
                    sticky_controls.style.opacity = 0;
                    main_breadcrumb.classList.add("active");
                    main_breadcrumb.setAttribute("aria-current","page");
                    sub_breadcrumb.classList.remove("active");
                    sub_breadcrumb.removeAttribute("aria-current");
                    main_breadcrumb.innerHTML = "Home";
                    sub_breadcrumb.classList.add("hide");
                    setTimeout(() => {
                        game_song_list.setAttribute("hidden","");
                        game_song_buttons.setAttribute("hidden","");
                        sticky_controls.setAttribute("hidden","");
                        global_song_list.removeAttribute("hidden");
                        ss_count_el.removeAttribute("hidden");
                        setTimeout(() => {
                            global_song_list.style.opacity = 1;
                            ss_count_el.style.opacity = 1;
                        }, TRANSITION_BUFFER);
                        scrollTo(stored_scroll);
                    }, TRANSITION_SPEED);
                } else {
                    global_song_list.style.opacity = 0;
                    ss_count_el.style.opacity = 0;
                    main_breadcrumb.classList.remove("active");
                    main_breadcrumb.removeAttribute("aria-current");
                    sub_breadcrumb.classList.add("active");
                    sub_breadcrumb.setAttribute("aria-current","page");
                    main_breadcrumb.innerHTML = "<a href='#' class='excluded_link'>Home</a>";
                    sub_breadcrumb.classList.remove("hide");
                    stored_scroll = document.body.scrollTop;
                    setTimeout(() => {
                        global_song_list.setAttribute("hidden","");
                        ss_count_el.setAttribute("hidden", "");
                        game_song_list.removeAttribute("hidden");
                        game_song_buttons.removeAttribute("hidden");
                        sticky_controls.removeAttribute("hidden");
                        setTimeout(() => {
                            game_song_list.style.opacity = 1;
                            game_song_buttons.style.opacity = 1;
                            sticky_controls.style.opacity = 1;
                        }, TRANSITION_BUFFER);
                        scrollTo();
                    }, TRANSITION_SPEED);
                }
            }

            function hidePopup() {
                document.getElementById("addSongClose").click();
                changeGlobalSongListState(true);
                setTimeout(() => {
                    const game_song_list = document.getElementById("popup_controls")
                    game_song_list.innerHTML = "";
                    updateCount()
                }, 300 + TRANSITION_SPEED)
            }

            function destroyPopup() {
                const song_el = document.getElementsByClassName("game-songs");
                for (let s = 0; s < song_el.length; s++) {
                    if (song_el[s].getAttribute("game") == current_game) {
                        let songs_set = {};
                        const inputs = document.getElementById("popup_controls").getElementsByClassName("midi-checkbox");
                        for (let i = 0; i < inputs.length; i++) {
                            songs_set[inputs[i].getAttribute("song-id")] = inputs[i].getAttribute("ticked");
                        }
                        const new_inputs = song_el[s].getElementsByClassName("midi-checkbox");
                        for (let n = 0; n < new_inputs.length; n++) {
                            new_inputs[n].setAttribute("ticked", songs_set[new_inputs[n].getAttribute("song-id")]);
                        }
                        hidePopup();
                        return;
                    }
                }
                hidePopup()
                updateFullnessIndicators()
            }

            function toggleGameVisibility(game_internal, el) {
                const game_pretty = el.getElementsByClassName("game-internal-name")[0].innerText;
                const song_el = document.getElementsByClassName("game-songs");
                document.getElementById("popup_game_name").innerText = game_pretty;
                document.getElementById("sub-breadcrumb").innerText = game_pretty;
                changeGlobalSongListState(false);
                for (let s = 0; s < song_el.length; s++) {
                    if (song_el[s].getAttribute("game") == game_internal) {
                        document.getElementById("popup_controls").innerHTML = song_el[s].innerHTML;
                        let songs_set = {};
                        const inputs = song_el[s].getElementsByClassName("midi-checkbox");
                        for (let i = 0; i < inputs.length; i++) {
                            songs_set[inputs[i].getAttribute("song-id")] = inputs[i].getAttribute("ticked");
                        }
                        const new_inputs = document.getElementById("popup_controls").getElementsByClassName("midi-checkbox");
                        for (let n = 0; n < new_inputs.length; n++) {
                            new_inputs[n].setAttribute("ticked", songs_set[new_inputs[n].getAttribute("song-id")]);
                        }
                        updateMaster();
                        handleCredits(false);
                        current_game = game_internal;
                        return;
                    }
                }
            }

            let folder_data = {}
            let build_progress = 0;
            let build_limit = 0;

            function updateProgress(progress, total, text="", error=false) {
                const hook = document.getElementById("loading_bar")
                const bar = hook.getElementsByTagName("div")[0]
                const perc = Math.floor(100 * (progress / total));
                hook.setAttribute("aria-valuenow", perc.toString()); 
                bar.style.width = `${perc}%`
                bar.innerText = `${perc}%`
                bar.classList.remove("bg-info");
                bar.classList.remove("bg-danger");
                if (error) {
                    bar.classList.add("bg-danger");
                } else {
                    bar.classList.add("bg-info");
                }
                document.getElementById("loading_text").innerText = text;
                if ((progress == total) && (!error)) {
                    document.getElementById("load-event").style.opacity = 0;
                    setTimeout(() => {
                        document.getElementById("load-event").classList.add("hide")
                    }, TRANSITION_SPEED * 2);
                }
            }

            function filterFilename(unsafe_filename) {
                const bad_characters = "#%&{}<>*?$!'\":@+`|=/".split("");
                const split_filename = unsafe_filename.split("")
                return split_filename.filter(item => !bad_characters.includes(item)).join("")
            }

            async function buildBinaryPack() {
                output_as_encoded = false;
                buildPack();
            }
            
            async function buildCandyPack() {
                output_as_encoded = true;
                buildPack();
            }

            async function buildPack() {
                const ss_count = getSongSelectedCount();
                if ((ss_count < 1) && (Object.keys(uploaded_pack_data).length == 0)) {
                    generateToast("Cannot generate pack, no songs selected", true);
                    return;
                }
                if (pack_zip_data == null) {
                    generateToast("Something went wrong", true);
                    return;
                }
                generateToast(`Generating pack with ${ss_count} song${ss_count != 1 ? 's' : ''}`);
                const checkboxes = document.getElementsByClassName("midi-checkbox");
                folder_data = {...uploaded_pack_data}
                let data_array = []
                for (let c = 0; c < checkboxes.length; c++) {
                    if (checkboxes[c].getAttribute("ticked") == "true") {
                        const data = idToSongInfo(checkboxes[c].getAttribute("song-id"));
                        if (data != null) {
                            data_array.push(data)
                        }
                    }
                }
                const zip_full = new JSZip();
                pack_zip_jszip = await zip_full.loadAsync(pack_zip_data);
                console.log(data_array)
                for (let [filename_0, file_0] of Object.entries(pack_zip_jszip.files)) {
                    if (!file_0.dir) {
                        const found_data = data_array.find(item => item.drive_id == filename_0);
                        if (found_data) {
                            const fileData = await pack_zip_jszip.files[filename_0].async("blob");
                            if (!Object.keys(folder_data).includes(found_data.folder)) {
                                folder_data[found_data.folder] = []
                            }
                            let composer = "";
                            let converter = "";
                            for (let i = 0; i < midi_data_copy.length; i++) {
                                if (midi_data_copy[i].name === found_data.song && midi_data_copy[i].game === found_data.game) {
                                    composer = midi_data_copy[i].composer;
                                    converter = midi_data_copy[i].converter;
                                    group = midi_data_copy[i].group;
                                    length = midi_data_copy[i].midi_length;
                                    break;
                                }
                            }
                            folder_data[found_data.folder].push({
                                "song": found_data.song,
                                "game": found_data.game,
                                "logo": (async () => {
                                    if (folder_data[found_data.folder].some(file => file.game === found_data.game)) {
                                        return folder_data[found_data.folder].find(file => file.game === found_data.game).logo;
                                    } else {
                                        const response = await fetch(icon_json[found_data.game]);
                                        return await response.arrayBuffer();
                                    }
                                })(),
                                "composer": composer,
                                "converter": converter,
                                "group": group,
                                "length": length,
                                "data": fileData,
                                "tags": found_data.tags,
                                "append_extension": true
                            });
                        }
                    }
                }
                const zip = new JSZip();
                const promises = [];
                const png_zip = zip.folder("music_icons")
                Object.keys(folder_data).forEach(folder => {
                    const files  = folder_data[folder];
                    const f_zip = zip.folder(folder)
                    files.forEach(file => {
                        if (output_as_encoded) {
                            c_zip = new JSZip();
                            logo_name = filterFilename(`${file.game}.png`)
                            c_zip.file(filterFilename("song.bin"), file.data); // Song
                            png_zip.file(logo_name, file.logo); // Game PNG in main zip
                            // Create a json file for the song info containing the song, game, composer, and converter, and the name of the logo file
                            c_zip.file(filterFilename("data.json"), JSON.stringify({
                                "song": file.song,
                                "game": file.game,
                                "group": file.group,
                                "length": file.length,
                                "logo": logo_name,
                                "composer": file.composer,
                                "converter": file.converter,
                                "tags": file.tags,
                            }));
                            promises.push(
                                c_zip.generateAsync({type:"blob"}).then((content) => {
                                    if (file.append_extension) {
                                        f_zip.file(filterFilename(`${file.game} ${file.song}.candy`), content);
                                    } else {
                                        f_zip.file(filterFilename(file.song), content);
                                    }
                                })
                            );
                        } else {
                            if (file.append_extension) {
                                f_zip.file(filterFilename(`${file.game} ${file.song}.bin`), file.data);
                            } else {
                                f_zip.file(filterFilename(file.song), file.data);
                            }
                        }
                    })
                })
                
                if (output_as_encoded) {
                    Promise.all(promises).then((data) => {
                        zip.generateAsync({type:"blob"}).then(function(content) {
                            saveAs(content, "pack.zip");
                        });
                    })
                } else {
                    zip.generateAsync({type:"blob"}).then(function(content) {
                        saveAs(content, "pack.zip");
                    });
                }               
            }

            function selectMaster() {
                const checkboxes = document.getElementById("popup_controls").getElementsByClassName("midi-checkbox");
                let all_checked = true;
                let all_unchecked = true;
                for (let c = 0; c < checkboxes.length; c++) {
                    if (checkboxes[c].getAttribute("ticked") == "true") {
                        all_unchecked = false;
                    } else {
                        all_checked = false;
                    }
                }
                let setting = true;
                if (all_checked) {
                    setting = false;
                }
                for (let c = 0; c < checkboxes.length; c++) {
                    checkboxes[c].setAttribute("ticked", setting.toString());
                }
                updateMaster();
            }

            function updateMaster() {
                const checkboxes = document.getElementById("popup_controls").getElementsByClassName("midi-checkbox");
                let all_checked = true;
                let all_unchecked = true;
                for (let c = 0; c < checkboxes.length; c++) {
                    if (checkboxes[c].getAttribute("ticked") == "true") {
                        all_unchecked = false;
                    } else {
                        all_checked = false;
                    }
                }
                let text = "Select All";
                if (all_checked) {
                    text = "Deselect All";
                }
                document.getElementById("game-select-toggle").innerText = text;
                document.getElementById("game-select-toggle-bottom").innerText = text;
                const all_checkboxes = document.getElementsByClassName("midi-checkbox");
                all_checked = true;
                all_unchecked = true;
                for (c = 0; c < all_checkboxes.length; c++) {
                    if (all_checkboxes[c].getAttribute("ticked") == "true") {
                        all_unchecked = false;
                    } else {
                        all_checked = false;
                    }
                }
                const fa_hook = document.getElementById("select-all-songs-fa");
                fa_hook.classList.remove("fa-regular");
                fa_hook.classList.remove("fa-solid");
                text = "Select All Songs";
                if (all_checked) {
                    text = "Deselect All Songs";
                    fa_hook.classList.add("fa-regular");
                } else {
                    fa_hook.classList.add("fa-solid");
                }
                document.getElementById("select-all-songs").innerText = text;
                updateCount();
            }
            function filterGame() {
                const checkboxes = document.getElementsByClassName("midi-checkbox-container");
                for (let c = 0; c < checkboxes.length; c++) {
                    if (adheresToFilterCheckbox(checkboxes[c].getElementsByClassName("midi-checkbox")[0])) {
                        checkboxes[c].classList.remove("hide");
                    } else {
                        checkboxes[c].classList.add("hide");
                    }
                }
                const handlers = document.getElementsByClassName("game-handler")
                for (let h = 0; h < handlers.length; h++) {
                    const h_checkboxes = handlers[h].getElementsByClassName("midi-checkbox-container");
                    let has_any = false;
                    for (let c = 0; c < h_checkboxes.length; c++) {
                        has_any |= !h_checkboxes[c].classList.contains("hide");
                    }
                    if (has_any) {
                        handlers[h].classList.remove("hide");
                    } else {
                        handlers[h].classList.add("hide");
                    }
                }
            }

            function updateTickbox(el, game) {
                if (el.getAttribute("ticked") == "false") {
                    el.setAttribute("ticked",true);
                } else {
                    el.setAttribute("ticked",false);
                }
                updateMaster();
            }

            function getSongSelectedCount() {
                let count = 0;
                const checkboxes = document.getElementsByClassName("midi-checkbox");
                for (let c = 0; c < checkboxes.length; c++) {
                    if (checkboxes[c].getAttribute("ticked") == "true") {
                        count += 1;
                    }
                }
                const bad_checkboxes = document.getElementById("popup_controls").getElementsByClassName("midi-checkbox");
                for (let c = 0; c < bad_checkboxes.length; c++) {
                    if (bad_checkboxes[c].getAttribute("ticked") == "true") {
                        count -= 1;
                    }
                }
                return count;
            }

            function updateCount() {
                const count = getSongSelectedCount();
                let song_text = "songs"
                if (count == 1) {
                    song_text = "song";
                }
                document.getElementById("song_selected_count").innerText = `${count}/${midi_data_copy.length} ${song_text} selected.`
                updateFullnessIndicators();
            }

            function isCreditHidden() {
                return document.getElementById("credits_hidden").checked;
            }

            function getUpdatedVersion(drive_id) {
                let found_id = null;
                midi_data_copy.forEach(item => {
                    if (item.older_revisions != null) {
                        if (item.older_revisions.map(a => a.drive_id).includes(drive_id)) {
                            found_id = item.drive_id;
                        }
                    }
                })
                return found_id;
            }

            function handleCredits(update_cookie) {
                const credit_info = document.getElementById("popup_global_container").getElementsByClassName("name_meta_data");
                const audio_containers = document.getElementById("popup_global_container").getElementsByClassName("audio_container");
                const guitars = document.getElementById("popup_global_container").getElementsByClassName("credit-guitar");
                const hide = document.getElementById("credits_hidden").checked;
                for (let c = 0; c < credit_info.length; c++) {
                    if (hide) {
                        credit_info[c].classList.add("hide");
                    } else {
                        credit_info[c].classList.remove("hide");
                    }
                }
                for (let a = 0; a < audio_containers.length; a++) {
                    if (hide) {
                        audio_containers[a].classList.add("hide");
                    } else {
                        audio_containers[a].classList.remove("hide");
                    }
                }
                for (let g = 0; g < guitars.length; g++) {
                    if (hide) {
                        guitars[g].classList.remove("hide");
                    } else {
                        guitars[g].classList.add("hide");
                    }
                }
                if (update_cookie) {
                    setPackCookie("credits", hide);
                }
            }

            function isNumeric(str) {
                if (typeof str == "number") return true // Failsafe
                if (typeof str != "string") return false // we only process strings!  
                return !isNaN(str) && // use type coercion to parse the _entirety_ of the string (`parseFloat` alone does not do this)...
                        !isNaN(parseFloat(str)) // ...and ensure strings of whitespace fail
            }

            let query_keys = {}
            function checkQueryKey(key) {
                if (Object.keys(query_keys).includes(key)) {
                    const key_value = query_keys[key]
                    if (key_value == "true") {
                        return true;
                    } else if (key_value == "false") {
                        return false;
                    } else if (isNumeric(key_value)) {
                        return parseFloat(key_value);
                    }
                    return key_value
                }
                return null;
            }

            function adheresToFilter(index) {
                /*
                    .name .game .group
                    .composer .converter
                    .drive_id .timestamp
                    .audio .index .midi_length
                    .track_count .tags .notes
                    .days_since_submission .is_new
                    .older_revisions .changelog_entry
                */
                const midi_info = midi_data_copy.find(item => item.index == index)
                const filter_value = document.getElementById("search-game").value.toLowerCase();
                const filtered_game = filterName(filter_value);
                if (filter_value.includes(QUERY_STRING_IDENTIFIER)) {
                    const array_keys = ["composers","converters"]
                    const queries = filter_value.split("&")
                    query_keys = {}
                    queries.forEach(query => {
                        if (query != QUERY_STRING_IDENTIFIER) {
                            const q_k = query.split("=")[0]
                            const q_v = query.split("=")[1]
                            if (array_keys.includes(q_k)) {
                                query_keys[q_k] = q_v.split(",").map(item => item.trim())
                            } else {
                                query_keys[q_k] = q_v
                            }
                        }
                    })
                    Object.keys(query_keys).forEach(key => {
                        query_keys[key] = checkQueryKey(key); // Basic filtering
                    })
                    let valid_entry = true;
                    Object.keys(query_keys).forEach(key => {
                        if (!valid_entry) {
                            return;
                        }
                        const key_value = query_keys[key];
                        if (key == "game") {
                            valid_entry &= midi_info.game.toLowerCase().includes(filterName(key_value));
                        } else if (key == "song") {
                            valid_entry &= midi_info.name.toLowerCase().includes(key_value);
                        } else if (key == "composers") {
                            const entry_composers = midi_info.composer.split(",").map(item => item.trim().toLowerCase())
                            let has_valid_composer = false;
                            entry_composers.forEach(composer => {
                                key_value.forEach(suggested_composer => {
                                    has_valid_composer |= composer.includes(suggested_composer)
                                })
                            })
                            valid_entry &= has_valid_composer;
                        } else if (key == "converters") {
                            const entry_converters = midi_info.converter.split(",").map(item => item.trim().toLowerCase())
                            let has_valid_converter = false;
                            entry_converters.forEach(converter => {
                                key_value.forEach(suggested_converter => {
                                    has_valid_converter |= converter.includes(suggested_converter)
                                })
                            })
                            valid_entry &= has_valid_converter;
                        } else if (key == "group") {
                            if (key_value.toLowerCase() != "any") {
                                let referenced_group = key_value;
                                if (key_value == "background music") {
                                    referenced_group = "bgm"
                                }
                                valid_entry &= midi_info.group.replaceAll(" ","") == referenced_group.toLowerCase()
                            }
                        } else if (key == "bgm-min") {
                            if (midi_info.group == "bgm") {
                                valid_entry &= midi_info.midi_length >= key_value;
                            }
                        } else if (key == "bgm-max") {
                            if (midi_info.group == "bgm") {
                                valid_entry &= midi_info.midi_length <= key_value;
                            }
                        } else if (key == "noloop-min") {
                            if (midi_info.group != "bgm") {
                                valid_entry &= midi_info.midi_length >= key_value;
                            }
                        } else if (key == "noloop-max") {
                            if (midi_info.group != "bgm") {
                                valid_entry &= midi_info.midi_length <= key_value;
                            }
                        } else if (key.substring(0,4) == "tag-") {
                            const tag = key.substring(4)
                            if (key_value) {
                                valid_entry &= midi_info.tags.length == 0 || midi_info.tags.map(item => item.replaceAll(" ","").toLowerCase()).includes(tag)
                            }
                        }
                    })
                    return valid_entry;
                }
                if (filter_value == "") {
                    return true;
                }
                return midi_info.game.toLowerCase().includes(filtered_game) || midi_info.name.toLowerCase().includes(filter_value);
            }

            function adheresToFilterCheckbox(el) {
                const name = el.getElementsByClassName("name_data")[0].innerText;
                const success = adheresToFilter(parseInt(el.getAttribute("song-id")));
                return success;
            }

            function selectAllSongs() {
                const checkboxes = document.getElementsByClassName("midi-checkbox");
                let all_checked = true;
                for (let c = 0; c < checkboxes.length; c++) {
                    if (adheresToFilterCheckbox(checkboxes[c])) {
                        if (checkboxes[c].getAttribute("ticked") == "false") {
                            all_checked = false;
                        }
                    }
                }
                let state = "true"
                if (all_checked) {
                    state = "false";
                }
                for (let c = 0; c < checkboxes.length; c++) {
                    if (adheresToFilterCheckbox(checkboxes[c])) {
                        checkboxes[c].setAttribute("ticked",state);
                    }
                }
                updateMaster();
            }

            document.getElementById("uploaded_pack").addEventListener("change", function(e) {
                var fr = new FileReader();
                fr.onload = function() {
                    handlePack(fr.result);
                };
                fr.readAsArrayBuffer(document.getElementById("uploaded_pack").files[0]);
            })

            function waitFor(conditionFunction) {
                const poll = resolve => {
                    if(conditionFunction()) resolve();
                    else setTimeout(_ => poll(resolve), 400);
                }
                return new Promise(poll);
            }

            function checkArrayMatch(array_a, array_b) {
                if (array_a.length != array_b.length) {
                    return false; // Mismatching array size
                }
                for (let a = 0; a < array_a.length; a++) {
                    if (array_a[a] != array_b[a]) {
                        return false; // Byte mismatch
                    }
                }
                return true;
            }

            function checkSongArrayMatch(array_a, array_b, filename_a) {
                const extension = last(filename_a.split("."));
                if (PARSEABLE_EXTENSIONS.includes(extension)) { // Binary file
                    if (filename_a == "bgm/Undertale Spider Dance.candy") {
                        //console.log(array_a, array_b)
                    }
                    return checkArrayMatch(array_a, array_b);
                }
                // Unknown
                return false
            }

            async function findAsync(arr, asyncCallback) {
                const promises = arr.map(asyncCallback);
                const results = await Promise.all(promises);
                const index = results.findIndex(result => result);
                return arr[index];
            }

            const PARSEABLE_EXTENSIONS = ["bin","candy"]

            async function handlePack(data) {
                // Load all data
                let site_data = {};
                uploaded_pack_data = {};
                let req = new Array(midi_data_copy.length).fill(null);
                let loaded_count = 0;
                const zip_full = new JSZip();
                pack_zip_jszip = await zip_full.loadAsync(pack_zip_data);
                for (let [filename_0, file_0] of Object.entries(pack_zip_jszip.files)) {
                    if (!file_0.dir) {
                        const filename_id = filename_0
                        const song = total_data_copy.find(item => item.drive_id == filename_id)
                        loaded_count++;
                        if (song) {
                            const fileData = await pack_zip_jszip.files[filename_0].async("Uint8Array");
                            site_data[`${filename_id.replace(".bin","")}.bin`] = {
                                "group": song.group,
                                "data": Array.from(fileData),
                                "selected_version": song.drive_id,
                                "updated_version": getUpdatedVersion(song.drive_id) ? getUpdatedVersion(song.drive_id) : song.drive_id,
                            }
                        }
                    }
                }
                // console.log(site_data)
                // Load uploaded zip file
                const new_zip = new JSZip();
                let site_song_data = {};
                let compressed_data = {}
                const zip_data = await new_zip.loadAsync(data);
                for (let [filename_0, file_0] of Object.entries(zip_data.files)) {
                    if (!file_0.dir) {
                        const fileData = await zip_data.files[filename_0].async("Uint8Array");
                        const file_path_array = filename_0.split("/")
                        const file_group = file_path_array[file_path_array.length - 2];
                        compressed_data[filename_0] = {
                            "group": file_group,
                            "data": Array.from(fileData),
                            "blob": fileData
                        };
                    }
                }

                await waitFor(_ => loaded_count >= midi_data_copy.length);

                // Parse data for matching arrays

                // console.log(compressed_data)

                let matching_songs = [];
                let files_parsed = 0;
                const files_pushed = Array(Object.keys(compressed_data).length).fill(null);
                Object.keys(compressed_data).forEach((song_a, song_i) => {
                    // console.log(song_a)
                    const extension = last(song_a.split("."));
                    if (extension == "candy") {
                        c_zip = new JSZip();
                        c_zip.loadAsync(compressed_data[song_a].blob).then((czip_data) => {
                            for (let [filename_0, file_0] of Object.entries(czip_data.files)) {
                                if (filename_0 == "song.bin") {
                                    czip_data.files[filename_0].async("Uint8Array").then((fileData) => {
                                        files_pushed[song_i] = Array.from(fileData);
                                        files_parsed += 1;
                                    });
                                }
                            }
                        });
                    } else {
                        files_pushed[song_i] = compressed_data[song_a].data;
                        files_parsed += 1;
                    }
                })

                await waitFor(_ => files_parsed >= Object.keys(compressed_data).length)

                Object.keys(compressed_data).forEach((song_a, song_i) => {
                    if (last(song_a.split("/")).toLowerCase() != "predule.bin") { // Temporarily installed to weed out the bad bin
                        const extension = last(song_a.split("."));
                        let found_song = null;
                        if (PARSEABLE_EXTENSIONS.includes(extension)) {
                            found_song = Object.keys(site_data).find(item => {
                                return checkSongArrayMatch(files_pushed[song_i], site_data[item].data, song_a);
                            })
                        }
                        if (found_song) {
                            const new_song = site_data[found_song].updated_version;
                            if (!matching_songs.includes(new_song)) {
                                matching_songs.push(new_song)
                            }
                        } else {
                            // console.log(song_a)
                            // Song isn't on site. TODO: Handle persisting these songs
                            const item_name = last(song_a.split("/"));
                            const item_group = compressed_data[song_a].group;
                            const item_data = files_pushed[song_i];
                            if (!Object.keys(uploaded_pack_data).includes(item_group)) {
                                uploaded_pack_data[item_group] = []
                            }
                            uploaded_pack_data[item_group].push({
                                "song": item_name,
                                "data": new Blob([new Uint8Array(item_data)]),
                                "append_extension": false,
                            })
                        }
                    }
                })

                // console.log(matching_songs)

                const checkboxes = document.getElementsByClassName("midi-checkbox")
                for (let c = 0; c < checkboxes.length; c++) {
                    checkboxes[c].setAttribute("ticked", "false");
                }
                matching_songs.forEach(m_drive_id => {
                    const entry = midi_data_copy.find(item => item.drive_id == m_drive_id)
                    if (entry) {
                        const game = entry.game;
                        const id = entry.index;
                        for (c = 0; c < checkboxes.length; c++) {
                            if (checkboxes[c].getAttribute("song-id") == id) {
                                checkboxes[c].setAttribute("ticked", "true");
                            }
                        }
                    }
                })
                updateMaster();
            }

            function uploadPack() {
                document.getElementById("uploaded_pack").click();
            }

            function shuffle(array) {
                let currentIndex = array.length,  randomIndex;
              
                // While there remain elements to shuffle.
                while (currentIndex > 0) {
              
                    // Pick a remaining element.
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;
              
                    // And swap it with the current element.
                    [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
                }
              
                return array;
            }
            YT_EMBED_CAP = 199

            function sendToURL(url) {
                window.open(url, "_blank")
            }

            function getYTPlaylist() {
                if ((getSongSelectedCount() < 1) && (Object.keys(uploaded_pack_data).length == 0)) {
                    generateToast("Cannot generate playlist, no songs selected", true);
                    return;
                }
                const checkboxes = document.getElementsByClassName("midi-checkbox");
                folder_data = {...uploaded_pack_data}
                let data_array = []
                for (let c = 0; c < checkboxes.length; c++) {
                    if (checkboxes[c].getAttribute("ticked") == "true") {
                        if (checkboxes[c].getAttribute("group") == "bgm") {
                            const data = idToSongInfo(checkboxes[c].getAttribute("song-id"));
                            if (data != null) {
                                data_array.push(data)
                            }
                        }
                    }
                }
                data_array = data_array.filter(item => item.preview.includes("youtube") || item.preview.includes("youtu.be"))
                data_array = data_array.map(item => item.preview)
                shuffle(data_array)
                if (data_array.length > YT_EMBED_CAP) {
                    // Embeded playlists only can have a max of YT_EMBED_CAP videos
                    data_array = data_array.filter((item, index) => index < YT_EMBED_CAP)
                }
                let yt_ids = []
                data_array.forEach(item => {
                    YT_LONG_SPLITTER = "youtube.com/watch?v="
                    YT_SHORT_SPLITTER = "youtu.be/"
                    if (item.includes(YT_LONG_SPLITTER)) {
                        let id_seg = item.split(YT_LONG_SPLITTER)[1]
                        if (id_seg.includes("&")) {
                            id_seg = id_seg.split("&")[0]
                        }
                        yt_ids.push(id_seg)
                    } else if (item.includes(YT_SHORT_SPLITTER)) {
                        let id_seg = item.split(YT_SHORT_SPLITTER)[1]
                        if (id_seg.includes("?")) {
                            id_seg = id_seg.split("?")[0]
                        }
                        yt_ids.push(id_seg)
                    }
                })
                const LINK_INIT = "http://www.youtube.com/embed/?playlist="
                const full_link = `${LINK_INIT}${yt_ids.join(",")}`
                sendToURL(full_link)
            }
            function playSong(url, converter, song_name, index=null) {
                const hook = document.getElementById("audio-event-content");
                getShareLink(false, true, false, index, false);
                document.getElementById("playSongModalLabel").innerText = song_name;
                if ((url.includes("cdn.discordapp.com")) || (url.includes(GITHUB_AUDIO))) {
                    // Embedded audio
                    hook.innerHTML = `
                        <audio controls autoplay>
                            <source src="${url}" type="audio/mpeg">
                        </audio>
                    `
                } else if ((url.includes("youtube")) || (url.includes("youtu.be"))) {
                    const CONVERTER_NO_EXTERNAL = []; // Any users who make their videos non-distributable on external websites will just open a new tab to YT
                    if (CONVERTER_NO_EXTERNAL.includes(converter)) {
                        sendToURL(url)
                        document.getElementById("playSongModalClose").click();
                        return;
                    }
                    // Embedded YT Link
                    let video_id = null;
                    if (url.includes("youtube")) {
                        // Full YT Link
                        const queryString = `?${url.split("?")[1]}`;
                        const urlParams = new URLSearchParams(queryString);
                        video_id = urlParams.get("v")
                    } else if (url.includes("youtu.be")) {
                        // YT URL Shortener
                        video_id = last(url.split("/"))
                    }
                    if (video_id != null) {
                        hook.innerHTML = `
                            <iframe 
                                width="560"
                                height="315"
                                src="https://www.youtube.com/embed/${video_id}"
                                title="YouTube video player"
                                frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                allowfullscreen
                                ></iframe>
                        `
                    }
                } else {
                    sendToURL(url);
                    document.getElementById("playSongModalClose").click();
                    return;
                }
            }

            function closeSong() {
                document.getElementById("audio-event-content").innerHTML = ""
            }

            function getShareLink(include_settings=false, include_song=false, include_download=false, song_id=0, force_download=false) {
                if (force_download == undefined) {
                    force_download = false;
                }
                if (include_download == undefined) {
                    include_download = false;
                }
                if (include_song == undefined) {
                    include_song = false;
                }
                if (include_settings == undefined) {
                    include_settings = false;
                }
                let url = new URL(window.location.href);
                let stateObj = {}
                if (include_settings) {
                    const seed = convertSelectionsToString();
                    stateObj["s"] = seed;
                    url.searchParams.set("s",seed.toString());
                }
                if (include_download) {
                    url.searchParams.set("download", force_download.toString())
                    stateObj["download"] = force_download.toString()
                }
                if (include_song) {
                    url.searchParams.set("conversion_id", song_id.toString())
                    stateObj["conversion_id", song_id.toString()]
                }
                window.history.replaceState(stateObj, "", url.toString());
            }
            const B64_chars = [
                "A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q",
                "R","S","T","U","V","W","X","Y","Z",
                "a","b","c","d","e","f"
            ];
            const nums = ["0","1","2","3","4","5","6","7","8","9"];
            const BIT_SIZE_PER_CHAR = 5;

            function convertSelectionsToString() {
                let activated = [];
                const checkboxes = document.getElementsByClassName("midi-checkbox")
                for (let c = 0; c < checkboxes.length; c++) {
                    const index = idToSongInfo(checkboxes[c].getAttribute("song-id")).index;
                    if (activated.length <= index) {
                        const diff = (index - activated.length) + 1;
                        for (let d = 0; d < diff; d++) {
                            activated.push(false)
                        }
                    }
                    activated[index] = checkboxes[c].getAttribute("ticked") == "true"
                }
                const B64_SIZE = Math.ceil(activated.length / BIT_SIZE_PER_CHAR);
                let base64num = new Array(B64_SIZE).fill(0)
                activated.forEach((bit, index) => {
                    if (bit) {
                        base64num[Math.floor(index / BIT_SIZE_PER_CHAR)] |= (1 << (index % BIT_SIZE_PER_CHAR))
                    }
                })
                let b64_string = "";
                let prev_char = "";
                let counter = 0;
                let char_seq = []
                base64num.forEach((character, index) => {
                    if ((index == 0) || char_seq[char_seq.length - 1][0] != B64_chars[character]) {
                        char_seq.push([])
                    }
                    char_seq[char_seq.length - 1].push(B64_chars[character])
                })
                char_seq.forEach(subset => {
                    if (subset.length > 1) {
                        b64_string += subset.length.toString()
                    }
                    b64_string += subset[0];
                })
                return b64_string;
            }

            function unpackSeed(seed) {
                const characters = seed.split("");
                let count_string = "";
                let unpacked_seed_nums = [];
                characters.forEach(char => {
                    if (nums.includes(char)) {
                        count_string += char;
                    } else {
                        let count = 1;
                        if (count_string != "") {
                            count = Number(count_string);
                        }
                        if (B64_chars.includes(char)) {
                            for (let c = 0; c < count; c++) {
                                unpacked_seed_nums.push(B64_chars.indexOf(char));
                            }
                        }
                        count_string = "";
                    }
                })
                return unpacked_seed_nums.slice()
            }

            function willAutoDownload() {
                const queryString = window.location.search;
                const urlParams = new URLSearchParams(queryString);
                const will_download = urlParams.get("download") == "true";
                return will_download;
            }

            function autoPlaySong() {
                const queryString = window.location.search;
                const urlParams = new URLSearchParams(queryString);
                const urlOutput = urlParams.get("conversion_id")
                if (urlOutput == null) {
                    return;
                }
                let song_id = null;
                if (!isNaN(urlOutput)) {
                    song_id = Number(urlOutput);
                }
                const audio_clickers = document.getElementsByClassName("audio-clicker")
                for (let a = 0; a < audio_clickers.length; a++) {
                    const targ_id = audio_clickers[a].getAttribute("conversion_id");
                    if (!isNaN(targ_id)) {
                        if (Number(targ_id) == song_id) {
                            audio_clickers[a].click();
                            return;
                        }
                    }
                }

            }

            function parseSeed(index) {
                const queryString = window.location.search;
                const urlParams = new URLSearchParams(queryString);
                const seed = urlParams.get("s")
                if (seed == null) {
                    return false; // No data
                }
                const seed_arr = unpackSeed(seed);
                const loc = Math.floor(index / BIT_SIZE_PER_CHAR);
                const subposition = index % BIT_SIZE_PER_CHAR;
                if (loc >= seed_arr.length) {
                    return false; // Data is past seed boundaries
                }
                return (seed_arr[loc] & (1 << subposition)) != 0; // Extracted from seed
            }

            function handleMinView(update_cookie, update_checkbox) {
                let setting = "grid";
                if (document.getElementById("min-view").checked) {
                    setting = "minimal";
                }
                document.getElementById("song_list").setAttribute("render",setting);
                if (update_cookie) {
                    setPackCookie("min-view", setting);
                }
                document.getElementById("song_list").setAttribute("defaultrender", getCookie("min-view"));
            }

            function handleTextView(update_cookie) {
                let setting = "hide";
                if (document.getElementById("text-view").checked) {
                    setting = "show";
                }
                document.getElementById("song_list").setAttribute("gridtext",setting);
                if (update_cookie) {
                    setPackCookie("text-view", setting);
                }
            }

            function setMinView(state, update_cookie, update_checkbox) {
                if (update_checkbox) {
                    document.getElementById("min-view").checked = state;
                }
                handleMinView(update_cookie, update_checkbox);
            }

            function setMinViewToDefault() {
                const hook = document.getElementById("song_list");
                hook.setAttribute("render", hook.getAttribute("defaultrender"));
            }

            function setTextView(state, update_cookie) {
                document.getElementById("text-view").checked = state;
                handleTextView(update_cookie);
            }

            function submitSong() {
                const LINK = "https://script.google.com/macros/s/AKfycbwetNkcuX68j1hSMt0U2F_xmTHFe3hQp6my3cnHXwxICMJVt5NTyD8_aYcrMqEuSwuyfQ/exec"
                sendToURL(LINK)
            }

            let previous_width = null;
            function handleSize() {
                return;
                const force_limit = 700;
                const width = document.documentElement.clientWidth;
                if (width <= force_limit) {
                    if ((previous_width == null) || (previous_width > force_limit)) {
                        setMinView(true, false, false);
                    }
                } else {
                    if ((previous_width == null) || (previous_width <= force_limit)) {
                        setMinViewToDefault();
                    }
                }
                previous_width = width;
            }
            window.onresize = handleSize;
            handleSize();

            function readFile(file, start, size) {
                let value = 0;
                for (let i = 0; i < size; i++) {
                    value <<= 8;
                    value += file[start + i];
                }
                return value;
            }

            function getSongLength(file) {
                // Get song length from file array
                const PPQ = readFile(file, 0x40, 4);
                for (let i = 0; i < 16; i++) {
                    const track_header = readFile(file, i * 4, 4);
                    if (track_header != 0) {
                        
                    }
                }
            }

            function dumpInvalidData(data, title, previous_error) {
                if (data.length > 0) {
                    console.log(title)
                    console.log(data)
                    console.log("----------------------")
                    previous_error = true
                }
                return previous_error;
            }

            function checkInvalidSongs() {
                const tag_limit = 3;
                const location_tags = ["Lobbies and Shops", "Minigames", "Spawning", "Fights", "Collection", "Interiors", "Exteriors"]
                const missing_location_tag = midi_data_copy.filter(item => item.group == "bgm").filter(item => !item.tags.some(i => location_tags.includes(i))).map(item => `${item.game} ${item.name} by ${item.converter}`)
                const too_many_tags = midi_data_copy.filter(item => item.tags.filter(tag => location_tags.includes(tag)).length > tag_limit)
                let has_error = false;
                has_error = dumpInvalidData(missing_location_tag, "MISSING A LOCATION TAG", has_error);
                has_error = dumpInvalidData(too_many_tags, "HAS TOO MANY TAGS", has_error);
                if (!has_error) {
                    console.log("No errors found")
                }
            }
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
        <script>
            // TOAST GENERATOR
            const toastTrigger = document.getElementById('liveToastBtn')
            const toastContainer = document.getElementById("toasts")

            let toast_counter = 0;

            function generateToast(message, error=false) {
                toastContainer.getElementsByClassName("toast-container")[0].innerHTML += `
                <div id="liveToast${toast_counter}" class="toast align-items-center ${error ? 'text-bg-danger' : 'text-bg-primary'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>                    
                </div>`
                const toastEl = document.getElementById(`liveToast${toast_counter}`)
                const toastBootstrap = bootstrap.Toast.getOrCreateInstance(toastEl)
                toastBootstrap.show()
                toast_counter += 1;
            }
        </script>
    </body>
</html>